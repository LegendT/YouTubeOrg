---
phase: 13-watch-later-csv-import-metadata-enrichment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/import/csv-parser.ts
  - src/lib/import/watch-later.ts
  - src/app/actions/import.ts
autonomous: true

must_haves:
  truths:
    - "CSV text with header 'Video ID,Playlist Video Creation Timestamp' is parsed into structured rows"
    - "Invalid CSV (wrong headers, empty file) returns descriptive error message"
    - "Watch Later playlist exists in playlists table with youtubeId 'WL' after import action"
    - "Re-running import does not create duplicate Watch Later playlist entries"
  artifacts:
    - path: "src/lib/import/csv-parser.ts"
      provides: "parseWatchLaterCSV function"
      exports: ["parseWatchLaterCSV", "ParsedCSVRow", "CSVParseResult"]
    - path: "src/lib/import/watch-later.ts"
      provides: "ensureWatchLaterPlaylist function"
      exports: ["ensureWatchLaterPlaylist"]
    - path: "src/app/actions/import.ts"
      provides: "Server action to parse CSV and create playlist"
      exports: ["parseAndInitialiseImport"]
  key_links:
    - from: "src/lib/import/watch-later.ts"
      to: "src/lib/db/schema.ts"
      via: "Drizzle insert with onConflictDoUpdate on playlists.youtubeId"
      pattern: "onConflictDoUpdate.*target.*playlists\\.youtubeId"
    - from: "src/app/actions/import.ts"
      to: "src/lib/import/csv-parser.ts"
      via: "import parseWatchLaterCSV"
      pattern: "import.*parseWatchLaterCSV.*csv-parser"
    - from: "src/app/actions/import.ts"
      to: "src/lib/import/watch-later.ts"
      via: "import ensureWatchLaterPlaylist"
      pattern: "import.*ensureWatchLaterPlaylist.*watch-later"
---

<objective>
Build the CSV parsing utility and Watch Later playlist creation logic for importing Google Takeout exports.

Purpose: This is the foundation for the entire import pipeline. CSV parsing extracts video IDs and timestamps from the Takeout export, and the playlist upsert ensures a Watch Later entry exists in the database for linking videos to.

Output: Three files -- a pure CSV parser, a Watch Later playlist helper, and a server action that orchestrates parsing + playlist creation and returns parsed data for downstream batch processing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/13-watch-later-csv-import-metadata-enrichment/13-RESEARCH.md

Key codebase references:
@src/lib/db/schema.ts — playlists table definition (youtubeId unique constraint on line 6)
@src/lib/youtube/videos.ts — existing fetchVideoBatch pattern for reference
@src/app/actions/sync.ts — server action pattern (auth check, structured return, no throwing)
@src/lib/auth/session.ts — getServerSession helper
</context>

<tasks>

<task type="auto">
  <name>Task 1: CSV parser and Watch Later playlist helper</name>
  <files>
    src/lib/import/csv-parser.ts
    src/lib/import/watch-later.ts
  </files>
  <action>
    Create `src/lib/import/csv-parser.ts`:

    Export interface `ParsedCSVRow` with fields: `videoId: string` and `addedAt: string` (ISO 8601).

    Export type `CSVParseResult` as a discriminated union:
    - `{ success: true; rows: ParsedCSVRow[]; totalCount: number }`
    - `{ success: false; error: string }`

    Export function `parseWatchLaterCSV(csvText: string): CSVParseResult`:
    - Trim the full text, split by newline
    - If fewer than 2 lines, return error: "CSV file is empty or has no data rows"
    - Validate header line equals exactly `Video ID,Playlist Video Creation Timestamp` (trimmed). If not, return error: "Invalid CSV format. Expected Google Takeout Watch Later export with headers: Video ID, Playlist Video Creation Timestamp"
    - For each data line (index 1+): trim, skip empty lines, split on first comma
    - Validate video ID with regex `/^[\w-]{11}$/` — skip lines that do not match (do NOT error, just skip)
    - Collect `{ videoId, addedAt: timestamp }` for valid rows
    - Return success result with rows array and totalCount

    Create `src/lib/import/watch-later.ts`:

    Import `db` from `@/lib/db`, `playlists` from `@/lib/db/schema`, and `eq` from `drizzle-orm`.

    Export async function `ensureWatchLaterPlaylist(videoCount: number): Promise<number>`:
    - Insert into playlists with values: `youtubeId: 'WL'`, `title: 'Watch Later'`, `description: 'Imported from Google Takeout'`, `itemCount: videoCount`, `lastFetched: new Date()`
    - Use `.onConflictDoUpdate({ target: playlists.youtubeId, set: { itemCount: videoCount, updatedAt: new Date() } })`
    - Use `.returning({ id: playlists.id })`
    - Return `result[0].id` (the numeric playlist DB ID)

    British English in all comments. No emoji in code.
  </action>
  <verify>
    `npx tsc --noEmit` passes with no type errors in the new files.
    Manually inspect that parseWatchLaterCSV handles: valid CSV, wrong headers, empty file, trailing newlines, invalid video IDs.
  </verify>
  <done>
    parseWatchLaterCSV correctly parses the Google Takeout format (`Video ID,Playlist Video Creation Timestamp`), returns typed results with discriminated union, handles all edge cases.
    ensureWatchLaterPlaylist upserts a Watch Later playlist and returns its numeric DB ID.
  </done>
</task>

<task type="auto">
  <name>Task 2: Server action to parse CSV and initialise import</name>
  <files>
    src/app/actions/import.ts
  </files>
  <action>
    Create `src/app/actions/import.ts` with `'use server'` directive.

    Import: `auth` from `@/lib/auth/config`, `parseWatchLaterCSV` and `ParsedCSVRow` from `@/lib/import/csv-parser`, `ensureWatchLaterPlaylist` from `@/lib/import/watch-later`.

    Export async function `parseAndInitialiseImport(csvText: string)` returning:
    ```typescript
    Promise<{
      success: boolean;
      error?: string;
      playlistDbId?: number;
      rows?: ParsedCSVRow[];
      totalCount?: number;
    }>
    ```

    Implementation:
    1. Auth check: `const session = await auth()`. If no `session?.access_token`, return `{ success: false, error: 'Not authenticated' }`.
    2. Parse CSV: `const result = parseWatchLaterCSV(csvText)`. If `!result.success`, return `{ success: false, error: result.error }`.
    3. Create playlist: `const playlistDbId = await ensureWatchLaterPlaylist(result.totalCount)`.
    4. Return `{ success: true, playlistDbId, rows: result.rows, totalCount: result.totalCount }`.

    Wrap steps 2-3 in try/catch. On error, return `{ success: false, error: message }`. Follow the sync.ts pattern of never throwing from server actions.

    Note: This action receives the CSV text (already read client-side via FileReader), NOT a File object. The client parses the file with FileReader.readAsText() and sends the string to this action. This is the pattern chosen in research (client-side parsing for instant validation; CSV is ~130KB so well within server action limits).
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    The server action file has `'use server'` at the top.
    The action checks auth, parses CSV, creates playlist, and returns structured result without throwing.
  </verify>
  <done>
    parseAndInitialiseImport server action accepts CSV text, validates via parseWatchLaterCSV, upserts Watch Later playlist, returns playlistDbId + parsed rows for downstream batch processing. Never throws — always returns structured {success, error?} response.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors
2. All three files exist at their specified paths
3. parseWatchLaterCSV handles: valid input, wrong headers, empty file, trailing newlines, malformed video IDs
4. ensureWatchLaterPlaylist uses onConflictDoUpdate (not DoNothing — we want to update itemCount on re-import)
5. Server action has auth guard and structured error returns
</verification>

<success_criteria>
- CSV parser correctly extracts video IDs and timestamps from Google Takeout format
- Watch Later playlist upsert is idempotent (re-import updates, does not duplicate)
- Server action orchestrates parsing + playlist creation and returns data for batch processing
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-watch-later-csv-import-metadata-enrichment/13-01-SUMMARY.md`
</output>
