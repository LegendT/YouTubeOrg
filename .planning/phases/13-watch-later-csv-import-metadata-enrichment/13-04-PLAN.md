---
phase: 13-watch-later-csv-import-metadata-enrichment
plan: 04
type: execute
wave: 4
depends_on: ["13-01", "13-02", "13-03"]
files_modified:
  - src/app/import/page.tsx
  - src/app/import/import-page-client.tsx
  - src/components/import/csv-upload.tsx
  - src/components/import/import-progress.tsx
  - src/components/import/import-summary.tsx
  - src/components/navigation.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to /import from the main navigation bar"
    - "User can select a CSV file and see the file name and video count before starting import"
    - "Invalid CSV files are rejected with a clear error message"
    - "User sees real-time progress during metadata enrichment (e.g., 'Fetching 150/3,932 videos...')"
    - "User sees a completion summary with imported, skipped, and unavailable counts"
    - "Errors during import show a toast notification"
  artifacts:
    - path: "src/app/import/page.tsx"
      provides: "Server component with auth check for /import route"
      min_lines: 15
    - path: "src/app/import/import-page-client.tsx"
      provides: "Client orchestrator driving CSV upload -> metadata batches -> relationships"
      min_lines: 80
    - path: "src/components/import/csv-upload.tsx"
      provides: "File input component with FileReader parsing and validation"
      min_lines: 40
    - path: "src/components/import/import-progress.tsx"
      provides: "Stage-based progress display with batch counter"
      min_lines: 40
    - path: "src/components/import/import-summary.tsx"
      provides: "Completion summary with counts"
      min_lines: 20
    - path: "src/components/navigation.tsx"
      provides: "Navigation with Import link added"
      contains: "import"
  key_links:
    - from: "src/app/import/import-page-client.tsx"
      to: "src/app/actions/import.ts"
      via: "imports parseAndInitialiseImport, importMetadataBatch, createPlaylistRelationships"
      pattern: "import.*from.*actions/import"
    - from: "src/app/import/import-page-client.tsx"
      to: "src/components/import/csv-upload.tsx"
      via: "renders CSVUpload with onParsed callback"
      pattern: "CSVUpload"
    - from: "src/components/import/csv-upload.tsx"
      to: "src/lib/import/csv-parser.ts"
      via: "imports parseWatchLaterCSV for client-side validation"
      pattern: "import.*parseWatchLaterCSV"
    - from: "src/components/navigation.tsx"
      to: "/import"
      via: "navigation array entry"
      pattern: "href.*import"
---

<objective>
Build the Import page UI with file upload, real-time progress tracking, and completion summary, plus add it to the navigation bar.

Purpose: This is the user-facing layer that ties together all backend server actions (13-01 through 13-03) into a cohesive import experience. The user uploads a CSV, sees it validated instantly, watches metadata enrichment progress batch by batch, and gets a completion summary with counts. The UI follows established patterns: dark mode, Phosphor Icons, Sonner toasts, card-based layouts matching the sync page.

Output: A new `/import` page route with server/client component split, three import-specific UI components, and an updated navigation bar.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/13-watch-later-csv-import-metadata-enrichment/13-RESEARCH.md
@.planning/phases/13-watch-later-csv-import-metadata-enrichment/13-01-SUMMARY.md
@.planning/phases/13-watch-later-csv-import-metadata-enrichment/13-02-SUMMARY.md
@.planning/phases/13-watch-later-csv-import-metadata-enrichment/13-03-SUMMARY.md

Key codebase references:
@src/app/sync/page.tsx — server component pattern: auth check, fetch initial data, pass to client
@src/app/sync/sync-page-client.tsx — client orchestrator pattern for reference (not imported, just for pattern)
@src/components/sync/sync-progress.tsx — polling-based progress UI with interval (THE pattern to follow for import progress)
@src/components/navigation.tsx — navigation array to add Import entry (7 items currently, adding 8th)
@src/components/ui/progress.tsx — Radix progress bar component (already styled)
@src/components/ui/spinner.tsx — Spinner component
@src/lib/import/csv-parser.ts — parseWatchLaterCSV for client-side validation
@src/app/actions/import.ts — parseAndInitialiseImport, importMetadataBatch, createPlaylistRelationships

CRITICAL from RESEARCH: Client drives the batch loop. The import-page-client calls importMetadataBatch in a loop (incrementing startIndex by 50 each iteration), updating progress state between calls. This avoids server action serialisation blocking and enables real-time progress.

CRITICAL from MEMORY: Server action serialisation — actions via startTransition block other actions from same component tree. Process one batch at a time with await between them.

British English throughout: "Categorise", "Organise", "Imported", etc.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Import page route and client orchestrator</name>
  <files>
    src/app/import/page.tsx
    src/app/import/import-page-client.tsx
  </files>
  <action>
    Create `src/app/import/page.tsx` (Server Component):
    - Import `getServerSession` from `@/lib/auth/session`, `redirect` from `next/navigation`
    - Export metadata: `{ title: 'Import - YouTube Playlist Organiser' }`
    - Auth check: if no session.access_token or RefreshAccessTokenError, redirect to `/api/auth/signin`
    - Render `<main>` with heading "Import Watch Later" and subtitle "Import videos from a Google Takeout CSV export" (matching sync page layout: `mx-auto max-w-4xl px-6 py-8 space-y-8`)
    - Render `<ImportPageClient />`

    Create `src/app/import/import-page-client.tsx` ('use client'):
    - State machine with stages: `'idle' | 'parsing' | 'enriching' | 'linking' | 'complete' | 'error'`
    - State: `stage`, `parsedRows` (ParsedCSVRow[]), `playlistDbId` (number | null), `totalCount` (number), `enrichProgress` ({processed, unavailable, skipped, currentBatch, totalBatches}), `linkResult` ({created, skipped}), `error` (string | null)
    - Import from Sonner: `toast`

    Stage: idle
    - Render `<CSVUpload onParsed={handleFileSelected} />`
    - `handleFileSelected(rows)`: sets parsedRows, shows count, renders "Start Import" button

    Stage: parsing (triggered by "Start Import" button click)
    - Call `parseAndInitialiseImport(csvText)` — wait, actually the CSV text was already read client-side. The client has parsedRows from CSVUpload. But the server action needs csvText. CORRECTION: The CSVUpload component reads the file with FileReader and gets the raw text. The onParsed callback should receive BOTH the parsed rows AND the raw csvText. Actually, simpler approach: CSVUpload calls parseWatchLaterCSV locally for instant validation + preview, then when user clicks "Start Import", the raw csvText is sent to parseAndInitialiseImport.

    Revised flow:
    1. CSVUpload reads file with FileReader, gets csvText string
    2. CSVUpload calls parseWatchLaterCSV(csvText) locally for instant validation
    3. If valid, CSVUpload calls `onParsed(csvText, result.rows, result.totalCount)` — passes the raw text AND parsed data
    4. ImportPageClient stores csvText and parsed preview data
    5. User clicks "Start Import" button
    6. Stage transitions to 'parsing': call `parseAndInitialiseImport(csvText)` which re-parses server-side and creates the playlist. Store playlistDbId.
    7. Stage transitions to 'enriching': loop calling `importMetadataBatch(videoIds, startIndex, 50)` where videoIds = parsedRows.map(r => r.videoId). Increment startIndex by 50 each iteration. After each batch, update enrichProgress state. Use a simple while loop with await (NOT setInterval — just sequential awaits to avoid serialisation issues).
    8. Stage transitions to 'linking': call `createPlaylistRelationships(playlistDbId, parsedRows)`. Store result.
    9. Stage transitions to 'complete': show ImportSummary.

    On any error: set stage to 'error', show toast.error() with the message, display error state.

    The batch loop for enriching stage:
    ```typescript
    const videoIds = parsedRows.map(r => r.videoId);
    const totalBatches = Math.ceil(videoIds.length / 50);
    let currentBatch = 0;
    let totalProcessed = 0;
    let totalUnavailable = 0;
    let totalSkipped = 0;

    while (currentBatch < totalBatches) {
      const result = await importMetadataBatch(videoIds, currentBatch * 50, 50);
      if (!result.success) {
        toast.error(result.error || 'Failed to fetch video metadata');
        setStage('error');
        return;
      }
      totalProcessed += result.processed;
      totalUnavailable += result.unavailable;
      totalSkipped += result.skipped;
      currentBatch++;
      setEnrichProgress({ processed: totalProcessed, unavailable: totalUnavailable, skipped: totalSkipped, currentBatch, totalBatches });
    }
    ```

    Layout: Render appropriate component based on stage:
    - idle: CSVUpload + "Start Import" button (disabled until file selected)
    - parsing: Spinner with "Initialising import..."
    - enriching: ImportProgress component
    - linking: Spinner with "Creating playlist relationships..."
    - complete: ImportSummary component
    - error: Error card with "Try Again" button (resets to idle)
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    Both files exist. page.tsx is a Server Component with auth. import-page-client.tsx is a Client Component with state machine.
  </verify>
  <done>
    Import page has server/client split. Client drives a sequential batch loop for metadata enrichment, updates progress between each batch, and transitions through stages: idle -> parsing -> enriching -> linking -> complete.
  </done>
</task>

<task type="auto">
  <name>Task 2: Import UI components and navigation update</name>
  <files>
    src/components/import/csv-upload.tsx
    src/components/import/import-progress.tsx
    src/components/import/import-summary.tsx
    src/components/navigation.tsx
  </files>
  <action>
    Create `src/components/import/csv-upload.tsx` ('use client'):
    - Props: `onParsed: (csvText: string, rows: ParsedCSVRow[], totalCount: number) => void`, `disabled?: boolean`
    - Hidden file input (ref), triggered by a Button with UploadSimple icon
    - On file change: validate `.csv` extension, read with FileReader.readAsText
    - Call `parseWatchLaterCSV(text)` — import from `@/lib/import/csv-parser`
    - If error: show error with Warning icon in destructive colours
    - If success: show file name with FileText icon + video count, call onParsed
    - Styling: `rounded-lg border border-border bg-card p-6 space-y-4` (matching existing card pattern)
    - Icons: `UploadSimple`, `FileText`, `Warning` from `@phosphor-icons/react`
    - Accept attribute on input: `.csv`

    Create `src/components/import/import-progress.tsx` ('use client'):
    - Props: `stage: 'parsing' | 'enriching' | 'linking'`, `enrichProgress: { processed: number; unavailable: number; skipped: number; currentBatch: number; totalBatches: number } | null`
    - Three-stage pipeline display (similar to sync-progress.tsx pipeline stages):
      1. "Parsing CSV" — CheckCircle if past, Spinner if current, Circle if future
      2. "Fetching Metadata" — show `currentBatch/totalBatches batches` and `(processed + unavailable + skipped)/total videos` when current
      3. "Creating Relationships" — final stage
    - Progress bar for enriching stage: percentage = `(currentBatch / totalBatches) * 100`
    - Use existing styled pattern: `rounded-lg border border-border bg-card p-6 shadow-sm`
    - Icons: CheckCircle, Circle from Phosphor, Spinner from ui/spinner
    - Numbers formatted with `.toLocaleString()`

    Create `src/components/import/import-summary.tsx`:
    - Props: `totalCount: number`, `processed: number`, `unavailable: number`, `skipped: number`, `relationshipsCreated: number`, `relationshipsSkipped: number`
    - Success card with CheckCircle icon and "Import Complete" heading
    - Stats grid (2 columns on md, 1 on mobile):
      - "Videos Processed" — processed count
      - "Unavailable Videos" — unavailable count (muted if 0)
      - "Skipped (Already in DB)" — skipped count (muted if 0)
      - "Playlist Links Created" — relationshipsCreated count
      - "Links Skipped (Duplicate)" — relationshipsSkipped count (muted if 0)
    - All numbers formatted with `.toLocaleString()`
    - Styling: success colours for the header card, neutral for stats

    Update `src/components/navigation.tsx`:
    - Read the file first (MANDATORY before writing).
    - Add to imports: `FileCsv` from `@phosphor-icons/react`
    - Add new entry to the `navigation` array BEFORE the Sync entry (position 7, before index 6):
      `{ name: 'Import', href: '/import', icon: FileCsv }`
    - This places Import between Safety and Sync in the nav order, which groups data operations together.

    British English in all user-facing text. No emoji.
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    All four files exist.
    Navigation has 8 items with Import between Safety and Sync.
    `npm run dev` starts without errors, /import page renders.
  </verify>
  <done>
    CSVUpload provides instant client-side validation with FileReader. ImportProgress shows three-stage pipeline with batch-level progress for metadata enrichment. ImportSummary shows detailed completion stats. Navigation bar has Import link with FileCsv icon.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Watch Later import UI at /import page with CSV upload, real-time progress tracking, and completion summary. Navigation bar updated with Import link.</what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev`
    2. Navigate to http://localhost:3000 and sign in
    3. Verify "Import" appears in the navigation bar with a CSV file icon, between Safety and Sync
    4. Click Import to navigate to /import
    5. Verify the page shows "Import Watch Later" heading and a file upload area
    6. Try uploading a non-CSV file — verify error message appears
    7. Upload the actual Google Takeout CSV from `data/playlists/Watch later-videos.csv`
    8. Verify file name and video count (~3,932) appear after selection
    9. Click "Start Import" and observe:
       - Parsing stage completes quickly
       - Metadata enrichment shows batch progress (X/Y batches, video counts)
       - Relationship creation stage appears after enrichment
       - Completion summary shows counts for processed, unavailable, skipped, and created relationships
    10. Verify the page works with dark mode enabled
    11. Re-upload the same CSV — verify re-import shows most videos as "skipped" (already in DB)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors
2. `npm run dev` — dev server starts, /import page loads
3. Navigation shows Import link between Safety and Sync
4. CSVUpload validates files client-side before upload
5. Progress UI updates during metadata enrichment
6. Completion summary shows accurate counts
7. Toasts appear on errors
8. Re-import correctly skips existing videos
</verification>

<success_criteria>
- User can navigate to /import from the nav bar
- User can upload CSV and see instant validation (file name, count, or error)
- Real-time progress shows batch-by-batch metadata enrichment
- Completion summary shows all relevant counts (processed, unavailable, skipped, relationships created/skipped)
- Re-import works correctly (skips existing, only processes new)
- Dark mode and accessibility maintained
</success_criteria>

<output>
After completion, create `.planning/phases/13-watch-later-csv-import-metadata-enrichment/13-04-SUMMARY.md`
</output>
