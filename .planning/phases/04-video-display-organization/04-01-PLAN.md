---
phase: 04-video-display-organization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/types/videos.ts
  - src/lib/videos/format.ts
  - src/lib/videos/category-colours.ts
  - src/lib/videos/thumbnail-url.ts
  - src/components/ui/dropdown-menu.tsx
autonomous: true

must_haves:
  truths:
    - "VideoCardData type exists with all fields needed for card rendering"
    - "Duration parsing converts ISO 8601 to seconds for sorting"
    - "Category colour generation produces consistent colours from name strings"
    - "Thumbnail URL construction produces 320x180 URLs from youtubeId"
  artifacts:
    - path: "src/types/videos.ts"
      provides: "VideoCardData, SortOption, MoveUndoData, CopyUndoData types"
      min_lines: 30
    - path: "src/lib/videos/format.ts"
      provides: "parseDurationToSeconds, formatDuration, formatRelativeDate"
      exports: ["parseDurationToSeconds", "formatDuration", "formatRelativeDate"]
    - path: "src/lib/videos/category-colours.ts"
      provides: "getCategoryColour deterministic colour generator"
      exports: ["getCategoryColour"]
    - path: "src/lib/videos/thumbnail-url.ts"
      provides: "getThumbnailUrl from youtubeId"
      exports: ["getThumbnailUrl"]
  key_links:
    - from: "src/types/videos.ts"
      to: "src/types/categories.ts"
      via: "extends VideoSearchResult fields"
      pattern: "VideoCardData"
---

<objective>
Install dependencies and create shared types and utilities for the Phase 4 video browsing interface.

Purpose: Establish the foundation types, utility functions, and UI dependencies that all subsequent Phase 4 plans will build upon. This prevents repeated work and ensures consistent patterns.

Output: @tanstack/react-virtual installed, dropdown-menu shadcn component added, VideoCardData type, sort/undo types, format utilities (extracted from Phase 2), category colour generator, thumbnail URL constructor.
</objective>

<execution_context>
@/Users/anthonygeorge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anthonygeorge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-video-display-organization/04-CONTEXT.md
@.planning/phases/04-video-display-organization/04-RESEARCH.md
@src/types/categories.ts
@src/components/analysis/video-list-paginated.tsx (lines 30-60 for formatDuration/formatRelativeDate)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add dropdown-menu component</name>
  <files>package.json, src/components/ui/dropdown-menu.tsx</files>
  <action>
    1. Install @tanstack/react-virtual:
       `npm install @tanstack/react-virtual`

    2. Add the shadcn dropdown-menu component (needed for sort picker and move/copy category selector in toolbar):
       `npx shadcn@latest add dropdown-menu`

    3. Verify both installed correctly by checking package.json and the new component file.
  </action>
  <verify>`npm ls @tanstack/react-virtual` shows the package; `ls src/components/ui/dropdown-menu.tsx` exists.</verify>
  <done>@tanstack/react-virtual in dependencies and dropdown-menu.tsx component exists in src/components/ui/.</done>
</task>

<task type="auto">
  <name>Task 2: Create shared types and utility functions</name>
  <files>src/types/videos.ts, src/lib/videos/format.ts, src/lib/videos/category-colours.ts, src/lib/videos/thumbnail-url.ts</files>
  <action>
    **Create src/types/videos.ts:**
    Define the following types:

    ```typescript
    export type SortField = 'addedAt' | 'publishedAt' | 'title' | 'channelTitle' | 'duration'
    export type SortDirection = 'asc' | 'desc'

    export interface SortOption {
      field: SortField
      direction: SortDirection
      label: string
    }

    export interface VideoCardData {
      id: number                         // videos.id (database PK)
      youtubeId: string                  // For thumbnail URL construction + YouTube link
      title: string
      channelTitle: string | null
      duration: string | null            // ISO 8601 (e.g., "PT15M33S")
      publishedAt: Date | null
      description: string | null
      categoryId: number                 // Which category this video belongs to (for current view)
      categoryName: string               // Category name for the pill badge
      categoryNames: string[]            // All categories this video is in (for "All Videos" multi-badge)
      addedAt: Date                      // When added to this category (from categoryVideos.addedAt)
    }

    export interface MoveUndoData {
      type: 'move'
      videoIds: number[]
      sourceCategoryId: number
      targetCategoryId: number
      sourceCategoryName: string
      targetCategoryName: string
    }

    export interface CopyUndoData {
      type: 'copy'
      videoIds: number[]
      targetCategoryId: number
      targetCategoryName: string
    }
    ```

    **Create src/lib/videos/format.ts:**
    Extract `formatDuration` and `formatRelativeDate` from `src/components/analysis/video-list-paginated.tsx` (lines 30-60). Add a new `parseDurationToSeconds` function for sort comparisons:

    ```typescript
    export function parseDurationToSeconds(isoDuration: string | null): number {
      if (!isoDuration) return 0
      const match = isoDuration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/)
      if (!match) return 0
      const hours = parseInt(match[1] || '0', 10)
      const minutes = parseInt(match[2] || '0', 10)
      const seconds = parseInt(match[3] || '0', 10)
      return hours * 3600 + minutes * 60 + seconds
    }

    export function formatDuration(isoDuration?: string | null): string {
      // Exact copy from video-list-paginated.tsx lines 30-42
    }

    export function formatRelativeDate(date?: Date | string | null): string {
      // Exact copy from video-list-paginated.tsx lines 44-60
    }
    ```

    After creating the shared utilities, update the imports in `src/components/analysis/video-list-paginated.tsx` to use the new shared module instead of the inline definitions. Delete the inline `formatDuration` and `formatRelativeDate` from that file and import from `@/lib/videos/format`. Also check `src/components/analysis/video-assignment-dialog.tsx` for duplicate `formatDuration` and update it too.

    **Create src/lib/videos/category-colours.ts:**
    Deterministic colour generation from category name string:

    ```typescript
    export function getCategoryColour(name: string): { bg: string; text: string } {
      let hash = 0
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash)
        hash = hash & hash
      }
      const hue = ((hash % 360) + 360) % 360
      return {
        bg: `hsl(${hue}, 65%, 92%)`,
        text: `hsl(${hue}, 65%, 30%)`,
      }
    }
    ```

    **Create src/lib/videos/thumbnail-url.ts:**
    Construct higher-quality thumbnail URLs:

    ```typescript
    export function getThumbnailUrl(
      youtubeId: string,
      size: 'default' | 'mqdefault' | 'hqdefault' = 'mqdefault'
    ): string {
      return `https://img.youtube.com/vi/${youtubeId}/${size}.jpg`
    }
    ```
  </action>
  <verify>
    Run `npx tsc --noEmit` and confirm no type errors. Verify the shared format functions are importable:
    - `src/types/videos.ts` exports VideoCardData, SortOption, MoveUndoData, CopyUndoData
    - `src/lib/videos/format.ts` exports parseDurationToSeconds, formatDuration, formatRelativeDate
    - `src/lib/videos/category-colours.ts` exports getCategoryColour
    - `src/lib/videos/thumbnail-url.ts` exports getThumbnailUrl
    - `src/components/analysis/video-list-paginated.tsx` uses imports from `@/lib/videos/format` (no inline copies)
  </verify>
  <done>All type definitions and utility functions exist, are exported, and compile without errors. Existing code updated to use shared utilities.</done>
</task>

</tasks>

<verification>
1. `npm ls @tanstack/react-virtual` shows installed version
2. `ls src/components/ui/dropdown-menu.tsx` exists
3. `npx tsc --noEmit` passes with no errors
4. All 4 new files in src/lib/videos/ and src/types/videos.ts exist
5. No duplicate formatDuration/formatRelativeDate in video-list-paginated.tsx or video-assignment-dialog.tsx
</verification>

<success_criteria>
- @tanstack/react-virtual installed in package.json
- dropdown-menu.tsx exists in src/components/ui/
- VideoCardData type defined with all card fields
- SortOption type with 5 sort fields defined
- MoveUndoData and CopyUndoData types defined
- parseDurationToSeconds, formatDuration, formatRelativeDate extracted to shared utility
- getCategoryColour generates deterministic HSL from name string
- getThumbnailUrl constructs mqdefault URL from youtubeId
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-video-display-organization/04-01-SUMMARY.md`
</output>
