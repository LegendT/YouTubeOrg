---
phase: 04-video-display-organization
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/actions/videos.ts
  - src/components/videos/category-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Server action returns all videos for a selected category with their category names"
    - "Server action returns all videos across all categories for 'All Videos' view"
    - "Category sidebar displays all categories with video counts"
    - "Sidebar highlights selected category and shows 'All Videos' entry at top"
  artifacts:
    - path: "src/app/actions/videos.ts"
      provides: "getVideosForCategory server action"
      exports: ["getVideosForCategory"]
    - path: "src/components/videos/category-sidebar.tsx"
      provides: "CategorySidebar component with selection and counts"
      min_lines: 40
  key_links:
    - from: "src/app/actions/videos.ts"
      to: "src/lib/db/schema.ts"
      via: "Drizzle join query: videos + categoryVideos + categories"
      pattern: "innerJoin.*categoryVideos"
    - from: "src/components/videos/category-sidebar.tsx"
      to: "src/app/actions/categories.ts"
      via: "getCategories for sidebar data"
      pattern: "CategoryListItem"
---

<objective>
Create the data layer (server action for video fetching) and navigation component (category sidebar) for the video browsing page.

Purpose: The server action provides the optimised single-query data fetch that feeds the entire video grid. The sidebar provides category navigation. Both are foundational for the page orchestrator.

Output: `getVideosForCategory` server action returning VideoCardData[], and `CategorySidebar` component with category list, video counts, and selection state.
</objective>

<execution_context>
@/Users/anthonygeorge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anthonygeorge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-video-display-organization/04-CONTEXT.md
@.planning/phases/04-video-display-organization/04-RESEARCH.md
@.planning/phases/04-video-display-organization/04-01-SUMMARY.md
@src/lib/db/schema.ts
@src/app/actions/categories.ts
@src/types/videos.ts
@src/types/categories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create getVideosForCategory server action</name>
  <files>src/app/actions/videos.ts</files>
  <action>
    Create `src/app/actions/videos.ts` with `'use server'` directive.

    **getVideosForCategory(categoryId: number | null): Promise&lt;VideoCardData[]&gt;**

    When `categoryId` is a number: fetch videos in that specific category.
    When `categoryId` is null: fetch ALL videos across all categories ("All Videos" view).

    **Critical: Use a single optimised join query, NOT the N+1 pattern from searchVideosForAssignment.**

    For a specific category:
    ```sql
    SELECT v.id, v.youtube_id, v.title, v.channel_title, v.duration, v.published_at, v.description,
           cv.category_id, cv.added_at,
           c.name as category_name
    FROM category_videos cv
    INNER JOIN videos v ON cv.video_id = v.id
    INNER JOIN categories c ON cv.category_id = c.id
    WHERE cv.category_id = $categoryId
    ORDER BY cv.added_at DESC
    ```

    Then enrich each video with ALL its category names using a single batch query:
    - Collect all video IDs from the result
    - Run ONE query: `SELECT cv.video_id, c.name FROM category_videos cv JOIN categories c ON cv.category_id = c.id WHERE cv.video_id IN (videoIds)`
    - Group by video_id to build a Map<videoId, string[]>
    - Map results to VideoCardData[]

    For "All Videos" (categoryId = null):
    - Fetch all videos that have at least one category assignment
    - Use the same batch enrichment pattern
    - For the primary categoryId/categoryName fields, use the first category assignment
    - Order by videos.title ASC (natural browse order for all videos)

    **Remember:** PostgreSQL bigint aggregates return strings via Drizzle. Wrap with Number() where needed.

    Also add `revalidatePath('/videos')` alongside existing `/analysis` paths in the categories.ts server actions (assignVideosToCategory) so the videos page refreshes after mutations.
  </action>
  <verify>
    `npx tsc --noEmit` passes. The function signature matches `(categoryId: number | null) => Promise<VideoCardData[]>`.
    No N+1 queries â€” verify by checking there is at most 2 DB queries total (one for videos+join, one batch for all category names).
  </verify>
  <done>getVideosForCategory returns VideoCardData[] with optimised batch query. Single category and "All Videos" modes both work. No N+1 pattern.</done>
</task>

<task type="auto">
  <name>Task 2: Create CategorySidebar component</name>
  <files>src/components/videos/category-sidebar.tsx</files>
  <action>
    Create `src/components/videos/category-sidebar.tsx` as a Client Component (`'use client'`).

    **Props:**
    ```typescript
    interface CategorySidebarProps {
      categories: CategoryListItem[]
      selectedCategoryId: number | null  // null = "All Videos"
      onSelectCategory: (categoryId: number | null) => void
      totalVideoCount: number            // Sum of all unique videos for "All Videos" count
    }
    ```

    **Layout:**
    - Persistent left sidebar, width ~280px, full height, border-right
    - Header: "Categories" title
    - First item: "All Videos" with totalVideoCount badge, always at top
    - Remaining items: Each category name with its videoCount badge
    - Selected item highlighted with background colour
    - Use ScrollArea component for the category list (handles overflow)
    - Categories sorted alphabetically with "Uncategorised" pinned to bottom (already comes sorted from getCategories which sorts by isProtected, then name)

    **Styling per item:**
    - Hover state (bg-muted)
    - Selected state (bg-accent text-accent-foreground)
    - Count badge right-aligned (text-muted-foreground, tabular-nums)
    - Cursor pointer

    **Note:** Use British English in any user-facing text (e.g., "Uncategorised").
  </action>
  <verify>`npx tsc --noEmit` passes. Component renders a list of categories with selection callback.</verify>
  <done>CategorySidebar component displays categories with counts, supports selection, and has "All Videos" entry at top.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `src/app/actions/videos.ts` exports getVideosForCategory
3. `src/components/videos/category-sidebar.tsx` exports CategorySidebar
4. No N+1 queries in getVideosForCategory (at most 2 DB queries)
5. VideoCardData returned includes categoryNames array (all categories per video)
</verification>

<success_criteria>
- getVideosForCategory(categoryId) returns VideoCardData[] for a specific category
- getVideosForCategory(null) returns all videos across categories
- Category names batch-loaded in single query (not N+1)
- CategorySidebar shows "All Videos" + all categories with video counts
- Selected category visually highlighted
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-video-display-organization/04-02-SUMMARY.md`
</output>
