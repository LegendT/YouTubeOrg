---
phase: 04-video-display-organization
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/app/videos/page.tsx
  - src/components/videos/video-browse-page.tsx
  - src/components/videos/move-copy-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /videos and see video grid with category sidebar"
    - "Selecting a category in sidebar loads and displays that category's videos"
    - "Search filters videos in-place with result count banner"
    - "Sort changes reorder the grid immediately"
    - "User can select videos and move/copy them between categories with undo support"
    - "Confirmation dialog appears for bulk moves of 5+ videos"
    - "Undo toast appears after move/copy with Cmd/Ctrl+Z support"
  artifacts:
    - path: "src/app/videos/page.tsx"
      provides: "Server Component entry point fetching initial data"
      min_lines: 15
    - path: "src/components/videos/video-browse-page.tsx"
      provides: "Client Component orchestrating all video browse state"
      min_lines: 150
    - path: "src/components/videos/move-copy-dialog.tsx"
      provides: "Move/Copy category picker dialog with confirmation"
      min_lines: 50
  key_links:
    - from: "src/app/videos/page.tsx"
      to: "src/app/actions/categories.ts"
      via: "getCategories() for initial sidebar data"
      pattern: "getCategories"
    - from: "src/components/videos/video-browse-page.tsx"
      to: "src/app/actions/videos.ts"
      via: "getVideosForCategory for loading videos"
      pattern: "getVideosForCategory"
    - from: "src/components/videos/video-browse-page.tsx"
      to: "src/app/actions/categories.ts"
      via: "assignVideosToCategory for move/copy"
      pattern: "assignVideosToCategory"
    - from: "src/components/videos/video-browse-page.tsx"
      to: "src/lib/categories/undo-stack.ts"
      via: "useUndoStack for move/copy undo"
      pattern: "useUndoStack"
---

<objective>
Wire all Phase 4 components into a working /videos page with full state management, move/copy dialog, and undo support.

Purpose: This is the orchestration plan that brings the sidebar (04-02), grid (04-03), and toolbar (04-03) together into a functioning page. It adds the move/copy dialog, selection state management, search/sort logic, and undo support.

Output: Working /videos route with category browsing, search, sort, video selection, move/copy between categories, and undo.
</objective>

<execution_context>
@/Users/anthonygeorge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anthonygeorge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-video-display-organization/04-CONTEXT.md
@.planning/phases/04-video-display-organization/04-RESEARCH.md
@.planning/phases/04-video-display-organization/04-01-SUMMARY.md
@.planning/phases/04-video-display-organization/04-02-SUMMARY.md
@.planning/phases/04-video-display-organization/04-03-SUMMARY.md
@src/types/videos.ts
@src/types/categories.ts
@src/app/actions/videos.ts
@src/app/actions/categories.ts
@src/lib/categories/undo-stack.ts
@src/components/analysis/undo-banner.tsx
@src/components/videos/category-sidebar.tsx
@src/components/videos/video-grid.tsx
@src/components/videos/video-toolbar.tsx
@src/components/videos/video-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MoveCopyDialog component</name>
  <files>src/components/videos/move-copy-dialog.tsx</files>
  <action>
    Create `src/components/videos/move-copy-dialog.tsx` as a Client Component.

    **Props:**
    ```typescript
    interface MoveCopyDialogProps {
      open: boolean
      onOpenChange: (open: boolean) => void
      mode: 'move' | 'copy'
      selectedVideoIds: number[]
      categories: CategoryListItem[]
      currentCategoryId: number | null      // Source category (null for "All Videos")
      currentCategoryName: string | null
      onConfirm: (targetCategoryId: number, targetCategoryName: string) => void
    }
    ```

    **Behaviour:**
    1. Dialog title: "Move {N} video(s) to..." or "Copy {N} video(s) to..."
    2. Show a scrollable list of target categories (exclude current category from list)
    3. Each category row shows: name + video count
    4. User clicks a category to select it (highlight selection)
    5. Confirmation button: "Move" / "Copy" — disabled until target selected
    6. For bulk moves (5+ videos in move mode), show a warning: "This will remove {N} videos from '{currentCategoryName}'"
    7. Close dialog on confirm or cancel

    **Styling:**
    - Use shadcn Dialog
    - ScrollArea for category list
    - Highlighted selection row (bg-accent)
    - Warning text in amber for bulk moves

    **British English:** "Organise", "Uncategorised" etc.
  </action>
  <verify>`npx tsc --noEmit` passes. Dialog accepts categories list and emits target selection on confirm.</verify>
  <done>MoveCopyDialog shows category picker, handles move/copy modes, warns on bulk moves (5+), and calls onConfirm with target category.</done>
</task>

<task type="auto">
  <name>Task 2: Create /videos page with full state orchestration</name>
  <files>src/app/videos/page.tsx, src/components/videos/video-browse-page.tsx</files>
  <action>
    **Create src/app/videos/page.tsx (Server Component):**
    ```typescript
    import { getCategories } from '@/app/actions/categories'
    import { getVideosForCategory } from '@/app/actions/videos'
    import { VideoBrowsePage } from '@/components/videos/video-browse-page'

    export default async function VideosPage() {
      const categories = await getCategories()
      // Load "All Videos" initially (null = all categories)
      const initialVideos = await getVideosForCategory(null)
      const totalVideoCount = initialVideos.length

      return (
        <VideoBrowsePage
          initialCategories={categories}
          initialVideos={initialVideos}
          totalVideoCount={totalVideoCount}
        />
      )
    }
    ```

    **Create src/components/videos/video-browse-page.tsx (Client Component):**

    This is the main orchestrator. It manages ALL state and wires child components.

    **State:**
    ```typescript
    // Category selection
    const [selectedCategoryId, setSelectedCategoryId] = useState<number | null>(null)
    const [categories, setCategories] = useState(initialCategories)
    const [videos, setVideos] = useState(initialVideos)
    const [isLoading, setIsLoading] = useState(false)

    // Search
    const [searchQuery, setSearchQuery] = useState('')
    const [debouncedQuery, setDebouncedQuery] = useState('')
    const [searchScope, setSearchScope] = useState<'category' | 'all'>('category')

    // Sort
    const [currentSort, setCurrentSort] = useState<SortOption>({
      field: 'addedAt', direction: 'desc', label: 'Date Added'
    })

    // Selection
    const [selectedIds, setSelectedIds] = useState<Set<number>>(new Set())

    // Move/Copy dialog
    const [moveCopyOpen, setMoveCopyOpen] = useState(false)
    const [moveCopyMode, setMoveCopyMode] = useState<'move' | 'copy'>('move')

    // Undo
    const undoStack = useUndoStack()
    ```

    **Key behaviours:**

    1. **Category switching:**
       - When user clicks a category in sidebar, call `getVideosForCategory(categoryId)` and update `videos` state
       - Show loading state while fetching
       - Clear search query and selection on category switch
       - Update `selectedCategoryId`

    2. **Search with debounce:**
       - 300ms debounce on searchQuery -> debouncedQuery
       - Filter `videos` array client-side using `useMemo`:
         - Match against title, channelTitle, description (all case-insensitive includes)
       - When searchScope is 'all' and user is viewing a specific category:
         - Fetch ALL videos via `getVideosForCategory(null)` and filter from that set
         - When toggling back to 'category', re-filter from the current category's videos
       - Show result count in toolbar

    3. **Sort:**
       - Apply sort to the filtered videos using `useMemo`
       - Sort comparators:
         - addedAt/publishedAt: compare Date objects (getTime())
         - title/channelTitle: localeCompare (handle nulls by sorting them last)
         - duration: use `parseDurationToSeconds` from format.ts
       - Reverse for desc direction

    4. **Selection:**
       - `toggleSelect(videoId)`: toggle in selectedIds Set
       - `selectAll()`: add all currently visible (filtered+sorted) video IDs to Set
       - `clearSelection()`: empty the Set
       - Clear selection when switching categories or changing search

    5. **Move/Copy:**
       - "Move to..." button opens MoveCopyDialog with mode='move'
       - "Copy to..." button opens MoveCopyDialog with mode='copy'
       - On confirm from dialog:
         a. Call `assignVideosToCategory(targetCategoryId, [...selectedIds], mode, selectedCategoryId ?? undefined)`
         b. On success, optimistically update state:
            - For move: remove moved videos from `videos` array, update category counts in sidebar
            - For copy: update target category count in sidebar
         c. Push to undo stack:
            ```typescript
            undoStack.push({
              type: mode,  // Need to extend UndoEntry to support 'move' | 'copy'
              label: `${mode === 'move' ? 'Moved' : 'Copied'} ${selectedIds.size} video${selectedIds.size > 1 ? 's' : ''} to "${targetCategoryName}"`,
              undoAction: async () => {
                if (mode === 'move') {
                  return await assignVideosToCategory(sourceCategoryId, videoIds, 'move', targetCategoryId)
                } else {
                  // For copy undo: remove the copied entries from target
                  // Use a new server action or delete from categoryVideos directly
                  return await removeVideosFromCategory(targetCategoryId, videoIds)
                }
              },
            })
            ```
         d. Clear selection
         e. Refresh categories list (`getCategories()`)

    6. **Undo integration:**
       - Import and render UndoBanner from `@/components/analysis/undo-banner.tsx`
       - Wire: canUndo, latest, onUndo, isUndoing from undoStack
       - After undo succeeds, refresh both categories and current videos

    **Note on UndoEntry type:**
    The existing `useUndoStack` has `type: 'delete' | 'merge'`. For Phase 4, we need to extend this to also support `'move' | 'copy'`. Update the UndoEntry type union in `src/lib/categories/undo-stack.ts` to: `type: 'delete' | 'merge' | 'move' | 'copy'`.

    **Also create a `removeVideosFromCategory` server action** in `src/app/actions/videos.ts` for copy undo:
    ```typescript
    export async function removeVideosFromCategory(
      categoryId: number,
      videoIds: number[]
    ): Promise<{ success: boolean; error?: string }> {
      // Delete categoryVideos rows, recalculate videoCount
    }
    ```

    **Layout:**
    ```tsx
    <div className="flex h-screen">
      <CategorySidebar ... />
      <div className="flex flex-1 flex-col min-w-0">
        <VideoToolbar ... />
        {isLoading ? <LoadingSpinner /> : <VideoGrid ... />}
      </div>
      <MoveCopyDialog ... />
      <UndoBanner ... />
    </div>
    ```

    The grid's scroll container gets its fixed height from `flex-1` within the flex column (CRITICAL for virtualiser — see RESEARCH pitfall #1).
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    - `/videos` page renders with sidebar + grid layout
    - Category switching triggers data reload
    - Search filters grid in-place
    - Sort reorders grid
    - Selection state tracked
    - MoveCopyDialog opens with correct mode
    - UndoBanner wired
  </verify>
  <done>
    Working /videos page with:
    - Category sidebar navigation loading videos on selection
    - Debounced search filtering grid in-place with result count
    - 5 sort options reordering grid
    - Multi-select with select-all
    - Move/Copy dialog with category picker and bulk warning
    - Undo support via UndoBanner with Cmd/Ctrl+Z
    - Optimistic UI updates after move/copy
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Navigate to http://localhost:3001/videos — page loads with sidebar and grid
3. Clicking category in sidebar loads its videos
4. Search input filters grid with debounced query
5. Sort dropdown reorders grid
6. Checkbox selection works on cards
7. "Move to..." opens dialog with category list
8. UndoBanner appears after move/copy
</verification>

<success_criteria>
- /videos page loads with category sidebar and video grid
- Category selection loads correct videos via server action
- Search filters in-place with 300ms debounce and result count
- Sort by date added, published, title, channel, duration all work
- Select-all and individual selection work
- Move/Copy dialog opens, shows category picker, warns on bulk moves (5+)
- Move/Copy executes via assignVideosToCategory with optimistic update
- Undo toast appears with countdown, Cmd/Ctrl+Z works
- Copy undo removes copied videos via removeVideosFromCategory
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-video-display-organization/04-04-SUMMARY.md`
</output>
