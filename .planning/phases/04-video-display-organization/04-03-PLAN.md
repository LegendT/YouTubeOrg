---
phase: 04-video-display-organization
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/videos/video-card.tsx
  - src/components/videos/video-grid.tsx
  - src/components/videos/video-toolbar.tsx
autonomous: true

must_haves:
  truths:
    - "Video card displays thumbnail, title, channel name, duration overlay, publish date, and category badge"
    - "Video grid renders 4,000+ cards with virtualised scrolling (no UI freeze)"
    - "Grid is responsive: 3-4 cards per row depending on container width"
    - "Toolbar provides search input, sort dropdown, select-all checkbox, and move/copy buttons"
    - "Search filters videos in real-time with 300ms debounce"
  artifacts:
    - path: "src/components/videos/video-card.tsx"
      provides: "VideoCard component with thumbnail, metadata, and checkbox"
      min_lines: 40
    - path: "src/components/videos/video-grid.tsx"
      provides: "Virtualised grid using @tanstack/react-virtual"
      min_lines: 50
    - path: "src/components/videos/video-toolbar.tsx"
      provides: "Search, sort, select-all, move/copy toolbar"
      min_lines: 60
  key_links:
    - from: "src/components/videos/video-grid.tsx"
      to: "@tanstack/react-virtual"
      via: "useVirtualizer for row virtualisation"
      pattern: "useVirtualizer"
    - from: "src/components/videos/video-card.tsx"
      to: "src/lib/videos/thumbnail-url.ts"
      via: "getThumbnailUrl for 320x180 thumbnails"
      pattern: "getThumbnailUrl"
    - from: "src/components/videos/video-card.tsx"
      to: "src/lib/videos/category-colours.ts"
      via: "getCategoryColour for pill badge"
      pattern: "getCategoryColour"
---

<objective>
Build the core visual components: the video card, virtualised grid, and toolbar with search/sort/selection controls.

Purpose: These are the primary UI building blocks that handle rendering 4,000+ videos performantly. The virtualised grid is the key technical component of Phase 4.

Output: VideoCard (individual card), VideoGrid (virtualised row-based grid with responsive columns), VideoToolbar (search + sort + selection + batch action buttons).
</objective>

<execution_context>
@/Users/anthonygeorge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anthonygeorge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-video-display-organization/04-CONTEXT.md
@.planning/phases/04-video-display-organization/04-RESEARCH.md
@.planning/phases/04-video-display-organization/04-01-SUMMARY.md
@src/types/videos.ts
@src/lib/videos/format.ts
@src/lib/videos/category-colours.ts
@src/lib/videos/thumbnail-url.ts
@src/components/ui/dropdown-menu.tsx
@src/components/ui/checkbox.tsx
@src/components/ui/badge.tsx
@src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VideoCard component</name>
  <files>src/components/videos/video-card.tsx</files>
  <action>
    Create `src/components/videos/video-card.tsx` as a Client Component.

    **Props:**
    ```typescript
    interface VideoCardProps {
      video: VideoCardData
      isSelected: boolean
      onToggleSelect: (videoId: number) => void
      showCategoryBadge?: boolean     // true in "All Videos" view
    }
    ```

    **Card layout (YouTube-style):**
    1. **Thumbnail area** (16:9 aspect ratio, ~320x180):
       - Use `getThumbnailUrl(video.youtubeId, 'mqdefault')` for the image source
       - `loading="lazy"` for native lazy loading (UI-06 requirement)
       - Duration overlay: dark semi-transparent pill in bottom-right corner showing `formatDuration(video.duration)`
       - The entire thumbnail is wrapped in an `<a>` tag linking to `https://www.youtube.com/watch?v=${video.youtubeId}` with `target="_blank"` and `rel="noopener noreferrer"` (VID-06: click opens YouTube)

    2. **Checkbox** (top-left corner overlay on thumbnail):
       - Use shadcn Checkbox component
       - Visible on hover OR when selected (use group-hover pattern)
       - `onClick` calls `onToggleSelect(video.id)`
       - Stop propagation so clicking checkbox doesn't open YouTube link

    3. **Info area** (below thumbnail):
       - **Title**: 2-line clamp (line-clamp-2), font-medium, text-sm
       - **Channel name**: text-xs text-muted-foreground, single line truncate
       - **Publish date**: text-xs text-muted-foreground, using `formatRelativeDate(video.publishedAt)`
       - **Category badge** (when showCategoryBadge is true): Use Badge component with inline `style` from `getCategoryColour(video.categoryName)` for bg/text colours. Show the primary categoryName. If video has multiple categories (categoryNames.length > 1), show "+N" indicator.

    **Styling:**
    - Rounded corners (rounded-lg), subtle border, hover shadow transition
    - Card background: bg-card
    - group class on outer div for hover states on checkbox
    - Cursor: pointer on the thumbnail link area

    **British English:** Any user-facing text (e.g., "Uncategorised") should use British spelling.
  </action>
  <verify>`npx tsc --noEmit` passes. Component accepts VideoCardData and renders card with thumbnail, duration overlay, and metadata.</verify>
  <done>VideoCard renders YouTube-style card with thumbnail (lazy-loaded), duration overlay, title, channel, date, category badge, and selection checkbox.</done>
</task>

<task type="auto">
  <name>Task 2: Create VideoGrid (virtualised) and VideoToolbar components</name>
  <files>src/components/videos/video-grid.tsx, src/components/videos/video-toolbar.tsx</files>
  <action>
    **Create src/components/videos/video-grid.tsx:**

    Use `@tanstack/react-virtual` with single row virtualiser + CSS grid columns pattern (from RESEARCH.md).

    **Props:**
    ```typescript
    interface VideoGridProps {
      videos: VideoCardData[]
      selectedIds: Set<number>
      onToggleSelect: (videoId: number) => void
      showCategoryBadges: boolean
    }
    ```

    **Implementation:**
    1. Use `useRef<HTMLDivElement>(null)` for the scroll container
    2. Implement `useColumnCount` hook with ResizeObserver:
       - Observe the scroll container width
       - `minCardWidth = 300`, max columns = 4, min = 1
       - `Math.max(1, Math.min(4, Math.floor(width / minCardWidth)))`
    3. Calculate `rowCount = Math.ceil(videos.length / columnCount)`
    4. Create virtualiser:
       ```typescript
       const rowVirtualizer = useVirtualizer({
         count: rowCount,
         getScrollElement: () => parentRef.current,
         estimateSize: () => ROW_HEIGHT, // ~340px (thumbnail 180 + info ~120 + gap 16 + padding)
         overscan: 3,
       })
       ```
    5. Render pattern:
       - Outer div: `ref={parentRef}`, `className="flex-1 overflow-auto"` (CRITICAL: must have fixed height via flex-1 within a flex column parent)
       - Inner div: `height: rowVirtualizer.getTotalSize()px`, position relative
       - Virtual rows: position absolute, translateY, CSS grid with `repeat(columnCount, 1fr)`, gap-4
       - Each cell: render `<VideoCard>` or empty div for last-row padding

    6. When the `videos` array changes (search/filter/sort), call `rowVirtualizer.scrollToIndex(0)` to reset scroll position. Use `useEffect` watching `videos.length`.

    7. Empty state: If `videos.length === 0`, show a centered message "No videos found" instead of the virtualised grid.

    **Create src/components/videos/video-toolbar.tsx:**

    **Props:**
    ```typescript
    interface VideoToolbarProps {
      // Search
      searchQuery: string
      onSearchChange: (query: string) => void
      searchScope: 'category' | 'all'
      onSearchScopeChange: (scope: 'category' | 'all') => void
      showScopeToggle: boolean        // Hide when already in "All Videos"
      resultCount: number
      totalCount: number

      // Sort
      currentSort: SortOption
      onSortChange: (sort: SortOption) => void

      // Selection
      selectedCount: number
      totalInView: number
      onSelectAll: () => void
      onClearSelection: () => void
      isAllSelected: boolean

      // Batch actions
      onMoveToClick: () => void
      onCopyToClick: () => void
      hasSelection: boolean

      // Current category context
      currentCategoryName: string | null  // null when "All Videos"
    }
    ```

    **Layout (horizontal toolbar bar above the grid):**
    1. **Search area** (left side):
       - Text input with Search icon (lucide-react), placeholder "Search videos..."
       - Result count banner: show only when searching, e.g. "23 results for 'react hooks'" with a clear (X) button
       - Scope toggle: small button or toggle "In {categoryName}" / "All categories" — hidden when viewing "All Videos"

    2. **Sort dropdown** (centre):
       - Use DropdownMenu (shadcn) with DropdownMenuRadioGroup
       - Sort options from RESEARCH.md:
         - "Date Added" (addedAt, desc)
         - "Published Date" (publishedAt, desc)
         - "Title A-Z" (title, asc)
         - "Channel A-Z" (channelTitle, asc)
         - "Duration" (duration, desc)
       - Show current sort as button label

    3. **Selection area** (right side):
       - "Select All" checkbox (Checkbox component) with label "{N} selected" or "Select all ({total})"
       - "Move to..." button (disabled when no selection) — variant="outline"
       - "Copy to..." button (disabled when no selection) — variant="ghost"

    **British English:** "Organise", "Categorise" etc. if used in any labels.
  </action>
  <verify>
    `npx tsc --noEmit` passes.
    - VideoGrid uses `useVirtualizer` from @tanstack/react-virtual
    - VideoGrid has responsive column count via ResizeObserver
    - VideoToolbar has search input, sort dropdown, select-all, and move/copy buttons
    - Empty state rendered when videos array is empty
  </verify>
  <done>VideoGrid renders cards in virtualised rows with responsive 1-4 column layout. VideoToolbar provides search, sort, selection, and batch action controls. Both compile without errors.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. VideoCard renders thumbnail with lazy loading and duration overlay
3. VideoGrid uses useVirtualizer with row virtualisation
4. VideoGrid has responsive column count (1-4 based on width)
5. VideoToolbar has search, sort dropdown, select-all, move/copy buttons
6. Scroll resets when video array changes
</verification>

<success_criteria>
- VideoCard shows thumbnail (320x180 from youtubeId), duration overlay, title, channel, date, category badge
- Clicking thumbnail opens YouTube in new tab
- Selection checkbox visible on hover and when selected
- VideoGrid virtualises rows with @tanstack/react-virtual (overscan: 3)
- Grid responsive: 1-4 columns based on container width
- VideoToolbar has debounce-ready search, 5 sort options, select-all, move/copy buttons
- Empty state displays "No videos found" message
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-video-display-organization/04-03-SUMMARY.md`
</output>
