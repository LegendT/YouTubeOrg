---
phase: 07-safety-archive-system
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - src/app/safety/page.tsx
  - src/components/safety/backup-list.tsx
  - src/components/safety/operation-log-table.tsx
  - src/components/safety/pending-changes.tsx
  - src/components/navigation.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /safety from the navbar"
    - "User sees list of backups with trigger type, timestamp, file size, and download button"
    - "User can create a manual backup and sees confirmation with timestamp and filename"
    - "User can download a backup JSON file"
    - "User can restore from a backup with confirmation dialog"
    - "User sees immutable operation log with timestamps, actions, and affected entities"
    - "User sees pending changes summary showing what will change when syncing to YouTube"
  artifacts:
    - path: "src/app/safety/page.tsx"
      provides: "Safety dashboard page with three sections: backups, operation log, pending changes"
      min_lines: 30
    - path: "src/components/safety/backup-list.tsx"
      provides: "Backup list with create, download, restore, delete actions"
      min_lines: 50
    - path: "src/components/safety/operation-log-table.tsx"
      provides: "Paginated operation log display"
      min_lines: 40
    - path: "src/components/safety/pending-changes.tsx"
      provides: "Pending changes summary for pre-sync review"
      min_lines: 30
    - path: "src/components/navigation.tsx"
      provides: "Safety nav link added"
      contains: "Safety"
  key_links:
    - from: "src/components/safety/backup-list.tsx"
      to: "src/app/actions/backup.ts"
      via: "calls createManualBackup, listBackups, restoreBackup, deleteBackup"
      pattern: "import.*backup"
    - from: "src/components/safety/operation-log-table.tsx"
      to: "src/app/actions/operation-log.ts"
      via: "calls getOperationLog"
      pattern: "import.*operation-log"
    - from: "src/components/safety/pending-changes.tsx"
      to: "src/app/actions/operation-log.ts"
      via: "calls getPendingChanges"
      pattern: "import.*getPendingChanges"
---

<objective>
Build the Safety dashboard page with backup management, operation log viewing, and pending changes review.

Purpose: Gives the user full visibility into the safety system — they can create/download/restore backups, view the immutable audit trail, and see a summary of pending changes before Phase 8 sync.

Output: A complete /safety page with three tabbed or sectioned panels, plus a nav link in the main navigation bar.
</objective>

<execution_context>
@/Users/anthonygeorge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anthonygeorge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-safety-archive-system/07-RESEARCH.md
@.planning/phases/07-safety-archive-system/07-01-SUMMARY.md
@.planning/phases/07-safety-archive-system/07-02-SUMMARY.md
@src/components/navigation.tsx
@src/app/actions/backup.ts
@src/app/actions/operation-log.ts
@src/types/backup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Safety dashboard page and components</name>
  <files>src/app/safety/page.tsx, src/components/safety/backup-list.tsx, src/components/safety/operation-log-table.tsx, src/components/safety/pending-changes.tsx</files>
  <action>
**Create src/app/safety/page.tsx** — Server Component page:

1. Fetch initial data using `Promise.all([listBackups(), getOperationLog(20, 0), getPendingChanges()])` in the Server Component
2. Pass data to client components
3. Layout: Full-width page with a header ("Safety & Archives") and three sections stacked vertically or in a tabbed layout (prefer tabs using Radix Tabs, already installed in the project):
   - **Backups** tab: BackupList component
   - **Operation Log** tab: OperationLogTable component
   - **Pending Changes** tab: PendingChanges component
4. Include page metadata/title

**Create src/components/safety/backup-list.tsx** — 'use client' component:

1. Props: `initialBackups: BackupSnapshotMeta[]`
2. Display backups in a table/card list:
   - Each row shows: trigger badge (manual/pre_delete/pre_merge/pre_sync/pre_restore), timestamp (relative format like "2 hours ago"), file size (formatted KB/MB), entity count
   - Actions per row: Download button (links to `/api/backup/${id}`), Restore button, Delete button
3. "Create Backup" button at top:
   - Calls `createManualBackup()` server action
   - Shows loading state during creation
   - On success: show success message with filename and timestamp, refresh backup list
   - On error: show error message
4. Restore confirmation:
   - When user clicks Restore, show a confirmation dialog (use window.confirm or a simple Dialog): "Restore from backup '{filename}'? This will replace all current categories and video assignments. A safety backup will be created automatically before restoring."
   - On confirm: call `restoreBackup(snapshotId)`, show loading, then success/error message
5. Delete confirmation: simple window.confirm before calling `deleteBackup(snapshotId)`
6. Use `useTransition` for server action calls to get loading states
7. Refresh list after any mutation by calling `listBackups()` and updating state

**Create src/components/safety/operation-log-table.tsx** — 'use client' component:

1. Props: `initialEntries: OperationLogEntry[], initialTotal: number`
2. Display entries in a table:
   - Columns: Timestamp (relative), Action (badge with colour coding: red for delete, amber for merge, blue for restore, green for create), Entity Type, Details (from metadata JSON), Linked Backup (if backupSnapshotId exists)
   - Pagination: "Load more" button or page numbers (simple offset-based)
3. Action badge colour mapping:
   - delete_category, delete_backup → red
   - merge_categories, move_videos → amber
   - restore_backup → blue
   - create_backup → green
   - Default → grey
4. Metadata display: render key metadata fields as comma-separated values (e.g., "categoryName: Gaming, videoCount: 42")

**Create src/components/safety/pending-changes.tsx** — 'use client' component:

1. Props: `initialSummary: PendingChangeSummary`
2. Display a summary card:
   - Total pending changes count
   - Grouped by type with counts: "X categories created", "Y ML suggestions accepted", "Z videos moved", etc.
   - If no changes: show "No pending changes — your YouTube playlists are up to date"
   - Note: "These changes will be synced to YouTube in Phase 8"
3. Future-ready: This component will be enhanced in Phase 8 to include an "Undo All" button and a "Start Sync" button

Style all components using Tailwind CSS following existing project conventions (bg-white, rounded-lg, shadow-sm, border patterns). Use British English for all user-facing text (e.g., "Categorise", "Organise", "Uncategorised").
  </action>
  <verify>
Run `npx tsc --noEmit` — no compilation errors.
Run `npm run dev` and navigate to `/safety` — page should load and display (may have empty data initially).
Verify all three sections/tabs are visible.
Verify "Create Backup" button is present.
  </verify>
  <done>
Safety dashboard at /safety shows three sections: backup list with create/download/restore/delete actions, paginated operation log with action badges and metadata, and pending changes summary. All server actions properly wired with loading states via useTransition.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Safety link to navigation bar</name>
  <files>src/components/navigation.tsx</files>
  <action>
In src/components/navigation.tsx:

1. Import the `Shield` icon from lucide-react (appropriate for safety/security)
2. Add a new navigation entry after the 'Review' entry:
   ```typescript
   { name: 'Safety', href: '/safety', icon: Shield },
   ```

This follows the exact pattern of existing navigation items. No other changes needed.
  </action>
  <verify>
Run `npm run dev` and verify the "Safety" link appears in the navbar between "Review" and "Sign Out".
Click the link — should navigate to /safety.
  </verify>
  <done>
Safety link visible in navbar with Shield icon. Clicking navigates to /safety dashboard.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- /safety page loads with three sections (Backups, Operation Log, Pending Changes)
- Navigation bar shows "Safety" link with Shield icon
- "Create Backup" button is visible and functional
- Operation log table renders (empty if no entries yet)
- Pending changes section renders summary
</verification>

<success_criteria>
User can navigate to the Safety dashboard from the navbar, view backups, create manual backups, download backup files, restore from backups, view the operation log, and see pending changes summary.
</success_criteria>

<output>
After completion, create `.planning/phases/07-safety-archive-system/07-03-SUMMARY.md`
</output>
