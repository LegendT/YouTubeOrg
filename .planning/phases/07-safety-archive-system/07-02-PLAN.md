---
phase: 07-safety-archive-system
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/actions/backup.ts
  - src/app/actions/operation-log.ts
  - src/app/api/backup/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "Server actions can create manual backups and return confirmation with timestamp and filename"
    - "Server actions can list all backups with metadata (trigger, size, date)"
    - "Server actions can restore from a specific backup ID and return success/failure"
    - "Server actions can log operations to the immutable operation log"
    - "Server actions can retrieve paginated operation log entries"
    - "Server actions can compute pending changes since last sync"
    - "Route Handler serves backup JSON files as downloadable attachments"
  artifacts:
    - path: "src/app/actions/backup.ts"
      provides: "createManualBackup, listBackups, restoreBackup, deleteBackup server actions"
      exports: ["createManualBackup", "listBackups", "restoreBackup", "deleteBackup"]
    - path: "src/app/actions/operation-log.ts"
      provides: "logOperation, getOperationLog, getPendingChanges server actions"
      exports: ["logOperation", "getOperationLog", "getPendingChanges"]
    - path: "src/app/api/backup/[id]/route.ts"
      provides: "GET route handler for backup file downloads"
      exports: ["GET"]
  key_links:
    - from: "src/app/actions/backup.ts"
      to: "src/lib/backup/snapshot.ts"
      via: "imports createSnapshot for backup creation"
      pattern: "import.*createSnapshot"
    - from: "src/app/actions/backup.ts"
      to: "src/lib/backup/restore.ts"
      via: "imports restoreFromSnapshot for restore operations"
      pattern: "import.*restoreFromSnapshot"
    - from: "src/app/actions/operation-log.ts"
      to: "src/lib/db/schema.ts"
      via: "imports operationLog table for append-only inserts and queries"
      pattern: "import.*operationLog"
---

<objective>
Create all server actions for the safety system (backup CRUD, operation logging, pending changes) and the file download route handler.

Purpose: Provides the full server-side API that the Safety dashboard UI and the integration hooks will consume. Separates backup actions from operation log actions for clean module boundaries.

Output: Two server action files and one API route handler, giving complete server-side capability for backup management, audit logging, pending change review, and file downloads.
</objective>

<execution_context>
@/Users/anthonygeorge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anthonygeorge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-safety-archive-system/07-RESEARCH.md
@.planning/phases/07-safety-archive-system/07-01-SUMMARY.md
@src/lib/db/schema.ts
@src/lib/db/index.ts
@src/lib/backup/snapshot.ts
@src/lib/backup/restore.ts
@src/types/backup.ts
@src/app/actions/categories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backup and operation log server actions</name>
  <files>src/app/actions/backup.ts, src/app/actions/operation-log.ts</files>
  <action>
**Create src/app/actions/backup.ts** with 'use server' directive:

1. `createManualBackup()` — calls `createSnapshot('manual')`, revalidates '/safety', returns `{ success: true, snapshotId, filename, timestamp }` or `{ success: false, error }`.

2. `listBackups()` — queries `backupSnapshots` table ordered by `createdAt DESC`, returns `BackupSnapshotMeta[]`. Wrap count with `Number()`.

3. `restoreBackup(snapshotId: number)` — calls `restoreFromSnapshot(snapshotId)` from src/lib/backup/restore.ts. On success, also log the restore operation via `logOperation`. Revalidate '/safety', '/videos', '/dashboard'. Return result.

4. `deleteBackup(snapshotId: number)` — looks up snapshot by ID, deletes the JSON file from filesystem (`fs.unlink`), deletes the DB row, returns `{ success: true }` or error. Does NOT delete associated operation log entries (they're immutable). Revalidate '/safety'.

Follow existing server action patterns from src/app/actions/categories.ts (try/catch, revalidatePath, return type with success boolean).

**Create src/app/actions/operation-log.ts** with 'use server' directive:

1. `logOperation(entry: { action: string, entityType: string, entityIds: number[], metadata?: Record<string, unknown>, backupSnapshotId?: number })` — inserts into `operationLog` table, returns the created entry with `id` and `createdAt`. This is the ONLY write function for the operation log (append-only, no update or delete exposed).

2. `getOperationLog(limit: number = 50, offset: number = 0)` — queries `operationLog` ordered by `createdAt DESC` with pagination. Returns `{ entries: OperationLogEntry[], total: number }`. Use `Number()` on count aggregate.

3. `getPendingChanges()` — computes what has changed since the last sync by querying:
   - Categories with no YouTube playlist ID (i.e., categories that exist locally but not on YouTube yet — these are all categories since the app doesn't track YouTube playlist IDs on the categories table yet)
   - Count of accepted ML categorizations (`acceptedAt IS NOT NULL`)
   - Count of rejected ML categorizations (`rejectedAt IS NOT NULL`)
   - Count of manually recategorised videos (`manualCategoryId IS NOT NULL`)
   - Count of categoryVideos entries by source type
   - Returns a `PendingChangeSummary` with grouped changes and counts

   Note: Since Phase 8 hasn't been built yet, "last sync timestamp" doesn't exist. For now, treat ALL current state as pending (everything is a change relative to the original YouTube state). Phase 8 will refine this.
  </action>
  <verify>
Run `npx tsc --noEmit` — no compilation errors.
Verify 'use server' directive is present at top of both files.
Verify logOperation does NOT export any update or delete function (immutability).
Verify restoreBackup calls logOperation after successful restore.
  </verify>
  <done>
backup.ts exports createManualBackup, listBackups, restoreBackup, deleteBackup. operation-log.ts exports logOperation, getOperationLog, getPendingChanges. Operation log is strictly append-only (insert only, no update/delete). All functions follow existing server action patterns with try/catch and revalidation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create backup download route handler</name>
  <files>src/app/api/backup/[id]/route.ts</files>
  <action>
**Create src/app/api/backup/[id]/route.ts** — Next.js App Router Route Handler for downloading backup JSON files:

1. Export `async function GET(request: NextRequest, { params }: { params: Promise<{ id: string }> })`:
   - Await params and extract `id`
   - Parse `id` as integer, return 400 if NaN
   - Look up backupSnapshots row by ID
   - If not found, return `new Response('Backup not found', { status: 404 })`
   - Construct filepath: `path.join(process.cwd(), 'backups', snapshot.filename)`
   - Read file content with `fs.readFile(filepath, 'utf-8')`
   - If file doesn't exist on disk, return 404 with message "Backup file missing from disk"
   - Return `new Response(content, { headers: { 'Content-Type': 'application/json', 'Content-Disposition': \`attachment; filename="${snapshot.filename}"\` } })`

2. Use the App Router pattern (NOT Pages Router). Import `NextRequest` from 'next/server'.

3. Wrap file read in try/catch to handle missing files gracefully.
  </action>
  <verify>
Run `npx tsc --noEmit` — no compilation errors.
Verify the route file exports only GET (no POST, PUT, DELETE).
Verify Content-Disposition header uses 'attachment' for download behavior.
Verify params are awaited (Next.js 15 async params pattern).
  </verify>
  <done>
GET /api/backup/[id] serves backup JSON files as downloadable attachments. Returns 400 for invalid IDs, 404 for missing backups or missing files, and the JSON content with Content-Disposition header for valid backups.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- src/app/actions/backup.ts has 'use server' and exports 4 functions
- src/app/actions/operation-log.ts has 'use server' and exports 3 functions (NO update/delete for operation log)
- src/app/api/backup/[id]/route.ts exports GET function
- All server actions follow existing patterns (try/catch, revalidatePath, success/error returns)
</verification>

<success_criteria>
Complete server-side API for the safety system: backup CRUD, immutable operation logging, pending change computation, and file downloads. Ready for the UI dashboard to consume.
</success_criteria>

<output>
After completion, create `.planning/phases/07-safety-archive-system/07-02-SUMMARY.md`
</output>
