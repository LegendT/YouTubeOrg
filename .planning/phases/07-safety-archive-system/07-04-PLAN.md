---
phase: 07-safety-archive-system
plan: 04
type: execute
wave: 4
depends_on: ["07-02", "07-03"]
files_modified:
  - src/app/actions/categories.ts
autonomous: false

must_haves:
  truths:
    - "System automatically creates a backup before deleteCategory is executed"
    - "System automatically creates a backup before mergeCategories is executed"
    - "System logs delete and merge operations to the immutable operation log"
    - "User sees backup confirmation with timestamp on the Safety dashboard after a destructive operation"
    - "User can undo pending changes by restoring from an automatic pre-operation backup"
  artifacts:
    - path: "src/app/actions/categories.ts"
      provides: "Pre-operation backup and operation logging wired into deleteCategory and mergeCategories"
      contains: "createSnapshot"
  key_links:
    - from: "src/app/actions/categories.ts"
      to: "src/lib/backup/snapshot.ts"
      via: "calls createSnapshot before destructive operations"
      pattern: "createSnapshot.*pre_delete|createSnapshot.*pre_merge"
    - from: "src/app/actions/categories.ts"
      to: "src/app/actions/operation-log.ts"
      via: "calls logOperation after destructive operations complete"
      pattern: "logOperation"
---

<objective>
Wire the safety system into existing destructive operations (deleteCategory, mergeCategories) so that backups and audit logging happen automatically.

Purpose: Satisfies SAFE-02 (automatic archiving before any delete operation) and SAFE-05 (immutable operation log for destructive operations). This is the critical integration step that makes the safety system functional rather than manual-only.

Output: Modified categories.ts with pre-operation snapshots and post-operation logging, plus end-to-end verification via human checkpoint.
</objective>

<execution_context>
@/Users/anthonygeorge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anthonygeorge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-safety-archive-system/07-RESEARCH.md
@.planning/phases/07-safety-archive-system/07-01-SUMMARY.md
@.planning/phases/07-safety-archive-system/07-02-SUMMARY.md
@.planning/phases/07-safety-archive-system/07-03-SUMMARY.md
@src/app/actions/categories.ts
@src/lib/backup/snapshot.ts
@src/app/actions/operation-log.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire pre-operation backups and operation logging into destructive actions</name>
  <files>src/app/actions/categories.ts</files>
  <action>
Modify src/app/actions/categories.ts to add automatic safety mechanisms to destructive operations:

**Import additions** at the top of the file:
```typescript
import { createSnapshot } from '@/lib/backup/snapshot';
import { logOperation } from '@/app/actions/operation-log';
```

**Modify `deleteCategory` function:**
1. After the protection check and BEFORE the transaction, create a pre-operation backup:
   ```typescript
   // Create pre-operation backup (SAFE-02: automatic archive before delete)
   const backup = await createSnapshot('pre_delete', `category:${category.name}`);
   ```
2. After the transaction succeeds (after the existing return object is constructed), log the operation:
   ```typescript
   // Log to immutable operation log (SAFE-05)
   await logOperation({
     action: 'delete_category',
     entityType: 'category',
     entityIds: [categoryId],
     metadata: {
       categoryName: category.name,
       videoCount: category.videoCount,
       orphanedCount: result.orphanedCount,
     },
     backupSnapshotId: backup.snapshotId,
   });
   ```
3. Also add `revalidatePath('/safety')` alongside the existing revalidations so the Safety dashboard updates.

**Modify `mergeCategories` function:**
1. After the protection/validation checks and BEFORE the transaction, create a pre-operation backup:
   ```typescript
   // Create pre-operation backup (SAFE-02: automatic archive before merge)
   const categoryNames = sourceCategories.map(c => c.name).join(', ');
   const backup = await createSnapshot('pre_merge', `merge:${categoryNames}`);
   ```
2. After the transaction succeeds, log the operation:
   ```typescript
   // Log to immutable operation log (SAFE-05)
   await logOperation({
     action: 'merge_categories',
     entityType: 'category',
     entityIds: sourceCategoryIds,
     metadata: {
       sourceCategoryNames: sourceCategories.map(c => c.name),
       targetName: trimmed,
       totalVideos: result.totalVideos,
     },
     backupSnapshotId: backup.snapshotId,
   });
   ```
3. Add `revalidatePath('/safety')`.

**IMPORTANT implementation notes:**
- The backup must happen BEFORE the destructive transaction, not inside it. This ensures the backup captures the pre-operation state even if the transaction fails.
- The operation log entry must happen AFTER the transaction succeeds. If the transaction fails, there's nothing to log.
- If the backup creation itself fails (e.g., disk full), wrap it in try/catch and proceed with the operation anyway — the backup is a safety net, not a gate. Log a warning to console.
- Do NOT modify the existing undo functionality (undoDeleteCategory, undoMergeCategories) — those handle in-session undo. Phase 7's safety system provides persistent undo via backup restore.
  </action>
  <verify>
Run `npx tsc --noEmit` — no compilation errors.
Verify `createSnapshot` is called BEFORE the transaction in both deleteCategory and mergeCategories.
Verify `logOperation` is called AFTER the transaction succeeds.
Verify backup failures are caught and don't block the operation.
  </verify>
  <done>
deleteCategory and mergeCategories automatically create pre-operation backups and log to the immutable operation log. Backup happens before the destructive transaction; logging happens after success. Backup failures are caught and don't block operations.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 7 Safety & Archive System:
1. Database tables: operationLog (append-only audit), backupSnapshots (backup metadata)
2. Core backup/restore logic in src/lib/backup/ with SHA-256 integrity checks
3. Server actions for backup CRUD, operation logging, and pending changes
4. Backup download route handler at /api/backup/[id]
5. Safety dashboard at /safety with backup list, operation log table, and pending changes
6. Navigation link to Safety page
7. Automatic pre-operation backups wired into deleteCategory and mergeCategories
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to /safety — verify the page loads with three sections
3. Click "Create Backup" — verify a backup appears in the list with timestamp and file size
4. Click the download button on the backup — verify a JSON file downloads
5. Open the downloaded JSON — verify it contains categories with video assignments using YouTube IDs (not internal DB IDs)
6. Navigate to /dashboard or the category management page
7. Delete a test category (or create a temporary one first, then delete it)
8. Navigate back to /safety:
   - Verify a new backup appeared with trigger "pre_delete"
   - Verify the operation log shows a "delete_category" entry with the category name
9. Verify the pending changes section shows a summary of current state
10. (Optional) Test restore: click "Restore" on the pre-delete backup, confirm the dialog, then verify the deleted category reappears
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- Pre-operation backups created automatically for delete and merge operations
- Operation log entries created for all destructive operations
- Safety dashboard shows backups, operation log, and pending changes
- Backup download works (JSON file with stable identifiers)
- Restore works (category structure rebuilt from backup)
- All 5 Phase 7 success criteria satisfied:
  1. System exports current playlist structure to JSON backup automatically before any delete operation [SAFE-02 via wired deleteCategory/mergeCategories]
  2. User sees archive confirmation with timestamp and file location [Safety dashboard]
  3. User can restore playlists from archive if needed [Restore button on Safety dashboard]
  4. System maintains immutable log showing all destructive operations [Operation log table]
  5. User can undo pending changes before syncing to YouTube [Restore from pre-operation backup]
</verification>

<success_criteria>
The safety system is fully integrated: destructive operations automatically archive state, the operation log captures an immutable audit trail, and users can restore from any backup. Phase 7 is complete and ready for Phase 8 (Batch Sync Operations).
</success_criteria>

<output>
After completion, create `.planning/phases/07-safety-archive-system/07-04-SUMMARY.md`
</output>
