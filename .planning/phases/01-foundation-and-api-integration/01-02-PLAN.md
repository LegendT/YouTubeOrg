---
phase: 01-foundation-and-api-integration
plan: 02
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - src/lib/auth/config.ts
  - src/app/api/auth/[...nextauth]/route.ts
  - src/lib/auth/session.ts
  - .env.local
autonomous: false
user_setup:
  - service: google-cloud
    why: "OAuth 2.0 authentication for YouTube Data API"
    env_vars:
      - name: AUTH_GOOGLE_ID
        source: "Google Cloud Console → APIs & Services → Credentials → Create OAuth 2.0 Client ID (Web application)"
      - name: AUTH_GOOGLE_SECRET
        source: "Same OAuth client - copy secret after creation"
      - name: AUTH_SECRET
        source: "Generate with: openssl rand -base64 32"
    dashboard_config:
      - task: "Enable YouTube Data API v3"
        location: "Google Cloud Console → APIs & Services → Library → Search 'YouTube Data API v3' → Enable"
      - task: "Configure OAuth consent screen"
        location: "Google Cloud Console → APIs & Services → OAuth consent screen → Add scopes: youtube.readonly"
      - task: "Add authorized redirect URI"
        location: "OAuth Client settings → Authorized redirect URIs → Add: http://localhost:3000/api/auth/callback/google"

must_haves:
  truths:
    - "User can click 'Sign in with Google' and authenticate"
    - "OAuth flow redirects back to localhost after Google login"
    - "Access token and refresh token are stored in session"
    - "Session persists across page refreshes"
    - "User can re-authenticate if tokens are revoked (AUTH-04)"
  artifacts:
    - path: "src/lib/auth/config.ts"
      provides: "NextAuth configuration with Google provider and token refresh"
      exports: ["auth", "handlers"]
      min_lines: 80
    - path: "src/app/api/auth/[...nextauth]/route.ts"
      provides: "NextAuth API route handlers"
      exports: ["GET", "POST"]
    - path: "src/lib/auth/session.ts"
      provides: "Server-side session helpers"
      exports: ["getServerSession"]
  key_links:
    - from: "src/lib/auth/config.ts"
      to: "process.env.AUTH_GOOGLE_ID"
      via: "Google provider configuration"
      pattern: "AUTH_GOOGLE_ID"
    - from: "src/lib/auth/config.ts callbacks.jwt"
      to: "oauth2.googleapis.com/token"
      via: "Token refresh fetch"
      pattern: "refresh_token.*fetch"
    - from: "src/lib/auth/config.ts callbacks.jwt"
      to: "token.error assignment on 403 invalid_grant"
      via: "Revoked token error handling"
      pattern: "invalid_grant.*error.*RefreshAccessTokenError"
---

<objective>
Implement YouTube OAuth 2.0 authentication using NextAuth.js v5 with automatic token refresh, storing access tokens and refresh tokens in encrypted JWT sessions.

Purpose: Establishes secure authentication required for all YouTube API calls. Token refresh ensures multi-hour operations don't require re-authentication.

Output: Working OAuth flow that authenticates user with Google, requests YouTube read-only scope, and maintains valid access tokens.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-and-api-integration/01-RESEARCH.md
@.planning/phases/01-foundation-and-api-integration/01-01-SUMMARY.md

**Key patterns from research:**
- Pattern 1: OAuth 2.0 with Automatic Token Refresh (NextAuth.js JWT Strategy)
- Must request `access_type: "offline"` and `prompt: "consent"` to get refresh_token
- Must handle token expiry by refreshing before API calls (in jwt callback)
- Pitfall 1: Missing Refresh Token on First Login - avoid by forcing consent
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NextAuth Configuration with Token Refresh</name>
  <files>
    src/lib/auth/config.ts
  </files>
  <action>
Create `src/lib/auth/config.ts` implementing research Pattern 1 (OAuth 2.0 with Automatic Token Refresh).

Import NextAuth v5 (Auth.js):
```typescript
import NextAuth from "next-auth"
import Google from "next-auth/providers/google"
```

Configure Google provider with these authorization params:
- `access_type: "offline"` (required for refresh_token)
- `prompt: "consent"` (force consent screen to guarantee refresh_token)
- `scope: "openid email profile https://www.googleapis.com/auth/youtube.readonly"` (YouTube read-only access)

Implement JWT callback with three cases:
1. First login (account exists): Save access_token, expires_at, refresh_token from account
2. Token still valid (Date.now() < expires_at): Return token unchanged
3. Token expired: Fetch new token from https://oauth2.googleapis.com/token using refresh_token, update token with new values

Implement session callback to expose access_token:
```typescript
async session({ session, token }) {
  session.access_token = token.access_token
  session.error = token.error
  return session
}
```

**Handle revoked tokens (AUTH-04):** In jwt callback, check for 403 errors with 'invalid_grant' during token refresh. If detected, set `token.error = "RefreshAccessTokenError"` and clear tokens. In session callback, if error exists, return null access_token to trigger re-authentication.

Export `auth` and `handlers` from NextAuth().

**Critical:** Follow research example exactly for token refresh logic to avoid Pitfall 5 (Refresh Token Rotation Confusion).
  </action>
  <verify>
Check file exports `auth` and `handlers`:
```bash
grep -E "export.*auth|export.*handlers" src/lib/auth/config.ts
```

Verify token refresh logic exists:
```bash
grep -A 5 "refresh_token" src/lib/auth/config.ts | grep "oauth2.googleapis.com/token"
```

Confirm offline access requested:
```bash
grep "access_type.*offline" src/lib/auth/config.ts
```
  </verify>
  <done>
NextAuth config file exists with Google provider configured for offline access, JWT callback handles token refresh, and session exposes access_token for YouTube API calls.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NextAuth API Route and Session Helpers</name>
  <files>
    src/app/api/auth/[...nextauth]/route.ts
    src/lib/auth/session.ts
  </files>
  <action>
Create `src/app/api/auth/[...nextauth]/route.ts`:
```typescript
import { handlers } from "@/lib/auth/config"

export const { GET, POST } = handlers
```

This exposes NextAuth OAuth callback endpoint at `/api/auth/callback/google`.

Create `src/lib/auth/session.ts`:
```typescript
import { auth } from "@/lib/auth/config"

export async function getServerSession() {
  return await auth()
}
```

This provides a clean helper for Server Components and API routes to access session.

**No sign-in UI yet** - that's deferred to Plan 05 (Dashboard UI). This task only sets up the authentication plumbing.
  </action>
  <verify>
Check API route exists and exports GET/POST:
```bash
cat src/app/api/auth/[...nextauth]/route.ts | grep "export.*GET.*POST"
```

Verify session helper imports auth:
```bash
grep "import.*auth" src/lib/auth/session.ts
```
  </verify>
  <done>
NextAuth API route is configured at correct path. Session helper function exists for server-side session access. Authentication infrastructure is ready for UI integration.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure Google Cloud OAuth credentials</action>
  <why>
Claude cannot access Google Cloud Console to create OAuth clients or enable APIs. This requires human interaction with Google's UI and manual copying of credentials.
  </why>
  <instructions>
**Step 1: Enable YouTube Data API v3**
1. Go to https://console.cloud.google.com
2. Create new project or select existing project
3. Navigate to: APIs & Services → Library
4. Search: "YouTube Data API v3"
5. Click Enable

**Step 2: Configure OAuth Consent Screen**
1. Navigate to: APIs & Services → OAuth consent screen
2. User type: External (for personal use) → Create
3. App name: "YouTube Playlist Organizer"
4. User support email: Your email
5. Developer contact: Your email
6. Click "Save and Continue"
7. Scopes: Click "Add or Remove Scopes"
   - Search: "youtube.readonly"
   - Select: ".../auth/youtube.readonly"
   - Click "Update" → "Save and Continue"
8. Test users: Add your Google account email → "Save and Continue"

**Step 3: Create OAuth 2.0 Credentials**
1. Navigate to: APIs & Services → Credentials
2. Click "Create Credentials" → "OAuth client ID"
3. Application type: Web application
4. Name: "YouTube Organizer Local Dev"
5. Authorized redirect URIs → Add URI:
   - `http://localhost:3000/api/auth/callback/google`
6. Click "Create"
7. **Copy the Client ID and Client Secret** (will only show once)

**Step 4: Update .env.local**
Open `.env.local` and fill in these values:
```
AUTH_GOOGLE_ID=<paste Client ID>
AUTH_GOOGLE_SECRET=<paste Client Secret>
AUTH_SECRET=<run: openssl rand -base64 32>
```

Save the file.
  </instructions>
  <resume-signal>
Type "credentials configured" when .env.local has been updated with real values.
  </resume-signal>
</task>

</tasks>

<verification>
**After human action complete:**
1. Verify .env.local has non-empty values for AUTH_GOOGLE_ID, AUTH_GOOGLE_SECRET, AUTH_SECRET
2. Run `npm run dev` and check no auth errors in terminal
3. Visit http://localhost:3000/api/auth/signin - should show sign in page (NextAuth default UI)
4. **Do NOT test OAuth flow yet** - that's verified in Plan 05 after dashboard UI is built

**Code verification:**
```bash
# Check NextAuth config has required callbacks
grep -E "jwt.*callback|session.*callback" src/lib/auth/config.ts

# Check token refresh endpoint is correct
grep "oauth2.googleapis.com/token" src/lib/auth/config.ts

# Verify YouTube scope is requested
grep "youtube.readonly" src/lib/auth/config.ts
```
</verification>

<success_criteria>
- NextAuth v5 configuration exists with Google provider
- JWT callback implements automatic token refresh logic
- Session callback exposes access_token for API usage
- NextAuth API route exists at correct path ([...nextauth]/route.ts)
- Google OAuth credentials are configured in Cloud Console
- .env.local contains real AUTH_GOOGLE_ID, AUTH_GOOGLE_SECRET, and AUTH_SECRET values
- Authorization includes youtube.readonly scope
- Configuration requests offline access and forces consent
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-api-integration/01-02-SUMMARY.md` using the summary template.
</output>
