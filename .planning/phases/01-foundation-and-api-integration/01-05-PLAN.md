---
phase: 01-foundation-and-api-integration
plan: 05
type: execute
wave: 4
depends_on: [01-02, 01-04]
files_modified:
  - src/app/dashboard/page.tsx
  - src/components/quota-display.tsx
  - src/components/playlist-list.tsx
  - src/components/sync-button.tsx
  - src/app/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees Sign In with Google button on home page"
    - "After authentication, user is redirected to dashboard"
    - "Dashboard displays playlist count and Watch Later count"
    - "Dashboard shows remaining API quota with progress bar"
    - "User can trigger data sync with button click"
  artifacts:
    - path: "src/app/page.tsx"
      provides: "Home page with sign-in button"
      min_lines: 20
    - path: "src/app/dashboard/page.tsx"
      provides: "Dashboard Server Component displaying playlists and quota"
      min_lines: 60
    - path: "src/components/quota-display.tsx"
      provides: "Quota usage visualization component"
      exports: ["QuotaDisplay"]
    - path: "src/components/playlist-list.tsx"
      provides: "Playlist summary list component"
      exports: ["PlaylistList"]
    - path: "src/components/sync-button.tsx"
      provides: "Client Component for triggering sync"
      exports: ["SyncButton"]
  key_links:
    - from: "src/app/dashboard/page.tsx"
      to: "src/lib/auth/session.ts (getServerSession)"
      via: "Check authentication"
      pattern: "getServerSession"
    - from: "src/app/dashboard/page.tsx"
      to: "src/lib/db (playlists table)"
      via: "Fetch cached playlists"
      pattern: "db.select.*playlists"
    - from: "src/components/sync-button.tsx"
      to: "src/app/actions/sync-playlists.ts (syncAllData)"
      via: "Trigger data sync on click"
      pattern: "syncAllData"
---

<objective>
Build dashboard UI displaying authenticated user's playlists, quota usage, and sync controls. Implements Phase 1 Success Criteria verification through visual interface.

Purpose: Provides user-facing interface to verify OAuth works, view cached data, monitor quota, and trigger initial sync. This is the completion point for Phase 1.

Output: Working web application where user can authenticate, see their YouTube data, and monitor API usage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-and-api-integration/01-RESEARCH.md
@.planning/phases/01-foundation-and-api-integration/01-02-SUMMARY.md
@.planning/phases/01-foundation-and-api-integration/01-04-SUMMARY.md

**Key patterns from research:**
- Code Example: Server Component Dashboard with Quota Display
- Must use Server Components for data fetching (no client-side API calls)
- Client Components only for interactivity (buttons, forms)

**Phase 1 Success Criteria to validate:**
1. User can authenticate with YouTube OAuth 2.0 and see confirmation ✓
2. User sees dashboard displaying 87 playlists with video counts and Watch Later count (4,000) ✓
3. System displays remaining API quota on dashboard (e.g., "8,245 / 10,000 units remaining today") ✓
4. User can view cached playlist data without triggering new API calls ✓
5. System maintains valid session across multi-hour operations without re-authentication ✓
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Home Page with Sign-In Button</name>
  <files>
    src/app/page.tsx
  </files>
  <action>
Replace default Next.js home page with authentication landing page.

Create `src/app/page.tsx` as Server Component:
```typescript
import { getServerSession } from '@/lib/auth/session'
import { redirect } from 'next/navigation'
import Link from 'next/link'

export default async function HomePage() {
  const session = await getServerSession()

  // If already authenticated, redirect to dashboard
  if (session) {
    redirect('/dashboard')
  }

  return (
    <main className="flex min-h-screen flex-col items-center justify-center p-24">
      <div className="text-center space-y-6">
        <h1 className="text-4xl font-bold">YouTube Playlist Organizer</h1>
        <p className="text-xl text-gray-600">
          Organize your 87 playlists and 4,000+ videos with AI-powered categorization
        </p>
        <Link
          href="/api/auth/signin"
          className="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition"
        >
          Sign in with Google
        </Link>
      </div>
    </main>
  )
}
```

This provides the entry point for authentication flow.
  </action>
  <verify>
Check Server Component (no 'use client'):
```bash
head -5 src/app/page.tsx | grep -v "use client"
```

Verify session check:
```bash
grep "getServerSession\|redirect" src/app/page.tsx
```

Confirm sign-in link:
```bash
grep "/api/auth/signin" src/app/page.tsx
```
  </verify>
  <done>
Home page exists with conditional rendering: authenticated users redirect to dashboard, unauthenticated users see sign-in button. NextAuth signin URL is linked correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Dashboard Components</name>
  <files>
    src/components/quota-display.tsx
    src/components/playlist-list.tsx
    src/components/sync-button.tsx
  </files>
  <action>
Create three reusable components for dashboard UI.

**1. QuotaDisplay Component** (src/components/quota-display.tsx):
```typescript
interface QuotaDisplayProps {
  used: number
  total: number
}

export function QuotaDisplay({ used, total }: QuotaDisplayProps) {
  const remaining = total - used
  const percentage = (remaining / total) * 100

  return (
    <div className="border rounded-lg p-6 bg-white shadow">
      <h2 className="text-2xl font-semibold mb-4">API Quota</h2>
      <p className="text-lg mb-2">
        {remaining.toLocaleString()} / {total.toLocaleString()} units remaining today
      </p>
      <div className="w-full bg-gray-200 rounded-full h-4">
        <div
          className="bg-blue-600 h-4 rounded-full transition-all"
          style={{ width: `${percentage}%` }}
        />
      </div>
      <p className="text-sm text-gray-600 mt-2">
        Resets daily at midnight PT
      </p>
    </div>
  )
}
```

**2. PlaylistList Component** (src/components/playlist-list.tsx):
```typescript
interface Playlist {
  id: number
  title: string
  itemCount: number
  youtubeId: string
}

interface PlaylistListProps {
  playlists: Playlist[]
}

export function PlaylistList({ playlists }: PlaylistListProps) {
  const watchLater = playlists.find(p => p.youtubeId.includes('WL'))

  return (
    <div className="border rounded-lg p-6 bg-white shadow">
      <h2 className="text-2xl font-semibold mb-4">
        Your Playlists ({playlists.length})
      </h2>

      {watchLater && (
        <div className="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded">
          <h3 className="font-semibold">Watch Later</h3>
          <p className="text-lg">{watchLater.itemCount.toLocaleString()} videos</p>
        </div>
      )}

      <ul className="space-y-2 max-h-96 overflow-y-auto">
        {playlists
          .filter(p => !p.youtubeId.includes('WL'))
          .map(playlist => (
            <li key={playlist.id} className="flex justify-between border-b pb-2">
              <span className="truncate">{playlist.title}</span>
              <span className="text-gray-600">{playlist.itemCount} videos</span>
            </li>
          ))}
      </ul>
    </div>
  )
}
```

**3. SyncButton Component** (src/components/sync-button.tsx):
```typescript
'use client'

import { useState } from 'react'
import { syncAllData } from '@/app/actions/sync-playlists'

export function SyncButton() {
  const [syncing, setSyncing] = useState(false)
  const [message, setMessage] = useState<string | null>(null)

  async function handleSync() {
    setSyncing(true)
    setMessage(null)

    try {
      const result = await syncAllData()

      if (result.success) {
        setMessage(`✓ Synced ${result.playlistCount} playlists successfully!`)
      } else if (result.partialSuccess) {
        setMessage(`⚠️ ${result.error}`)
      }
    } catch (error: any) {
      setMessage(`✗ Error: ${error.message}`)
    } finally {
      setSyncing(false)
    }
  }

  return (
    <div className="space-y-2">
      <button
        onClick={handleSync}
        disabled={syncing}
        className="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition"
      >
        {syncing ? 'Syncing...' : 'Sync YouTube Data'}
      </button>
      {message && (
        <p className="text-sm">{message}</p>
      )}
    </div>
  )
}
```

All components use Tailwind CSS for styling.
  </action>
  <verify>
Check component exports:
```bash
grep "export.*QuotaDisplay" src/components/quota-display.tsx
grep "export.*PlaylistList" src/components/playlist-list.tsx
grep "export.*SyncButton" src/components/sync-button.tsx
```

Verify SyncButton is Client Component:
```bash
head -1 src/components/sync-button.tsx | grep "use client"
```

Confirm Server Action import:
```bash
grep "import.*syncAllData" src/components/sync-button.tsx
```
  </verify>
  <done>
Three dashboard components exist: QuotaDisplay shows API usage with progress bar, PlaylistList renders playlists with Watch Later highlighted, SyncButton triggers data sync as Client Component. All use Tailwind styling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Dashboard Page</name>
  <files>
    src/app/dashboard/page.tsx
  </files>
  <action>
Create `src/app/dashboard/page.tsx` as Server Component implementing research code example "Server Component: Dashboard with Quota Display".

```typescript
import { getServerSession } from '@/lib/auth/session'
import { redirect } from 'next/navigation'
import { db } from '@/lib/db'
import { playlists } from '@/lib/db/schema'
import { getRemainingQuota } from '@/lib/youtube/quota'
import { QuotaDisplay } from '@/components/quota-display'
import { PlaylistList } from '@/components/playlist-list'
import { SyncButton } from '@/components/sync-button'

export default async function DashboardPage() {
  // Check authentication
  const session = await getServerSession()

  if (!session?.access_token || session?.error === 'RefreshAccessTokenError') {
    redirect('/api/auth/signin')
  }

  // Fetch cached data (no API calls = 0 quota cost)
  const allPlaylists = await db.select().from(playlists).orderBy(playlists.title)

  // Calculate quota usage
  const remainingQuota = await getRemainingQuota()
  const usedQuota = 10000 - remainingQuota

  return (
    <main className="min-h-screen bg-gray-50 p-8">
      <div className="max-w-6xl mx-auto space-y-6">
        <header className="flex justify-between items-center">
          <h1 className="text-3xl font-bold">YouTube Organizer Dashboard</h1>
          <a
            href="/api/auth/signout"
            className="text-sm text-gray-600 hover:text-gray-900"
          >
            Sign Out
          </a>
        </header>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <QuotaDisplay used={usedQuota} total={10000} />

          <div className="border rounded-lg p-6 bg-white shadow flex flex-col justify-center">
            <h2 className="text-2xl font-semibold mb-4">Data Sync</h2>
            <p className="text-gray-600 mb-4">
              {allPlaylists.length === 0
                ? 'No playlists synced yet. Click below to fetch your YouTube data.'
                : `Last synced: ${allPlaylists.length} playlists cached locally`}
            </p>
            <SyncButton />
          </div>
        </div>

        {allPlaylists.length > 0 && (
          <PlaylistList playlists={allPlaylists} />
        )}
      </div>
    </main>
  )
}
```

This Server Component:
- Checks authentication (redirects if not signed in)
- Fetches cached playlist data from database (no YouTube API calls)
- Calculates quota usage from database
- Renders components with data

**Important:** All data fetching happens server-side. No client-side API calls = no quota waste on page refresh.
  </action>
  <verify>
Check Server Component (no 'use client'):
```bash
head -5 src/app/dashboard/page.tsx | grep -v "use client"
```

Verify authentication check:
```bash
grep "getServerSession.*redirect" src/app/dashboard/page.tsx
```

Confirm database queries:
```bash
grep "db.select.*playlists\|getRemainingQuota" src/app/dashboard/page.tsx
```

Check component imports:
```bash
grep "import.*QuotaDisplay\|PlaylistList\|SyncButton" src/app/dashboard/page.tsx
```
  </verify>
  <done>
Dashboard page exists as Server Component with authentication check, cached data fetching, quota calculation, and component rendering. No client-side API calls. Ready for end-to-end testing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 1 implementation: OAuth authentication, database setup, YouTube API client with ETag caching, data sync logic, and dashboard UI.
  </what-built>
  <how-to-verify>
**Test the complete flow:**

1. **Start application:**
   ```bash
   npm run dev
   ```
   Visit http://localhost:3000

2. **Test authentication:**
   - Click "Sign in with Google"
   - Authorize app with YouTube readonly scope
   - Should redirect to /dashboard after successful auth
   - Verify session persists (refresh page, should stay on dashboard)

3. **Test dashboard rendering:**
   - Dashboard should show:
     - "0 playlists" initially (before sync)
     - Quota display showing "10,000 / 10,000 units remaining"
     - "Sync YouTube Data" button

4. **Test data sync:**
   - Click "Sync YouTube Data" button
   - Watch terminal for sync progress logs
   - After completion, page should show:
     - Your actual playlist count (target: 87 playlists)
     - Watch Later playlist highlighted with video count (target: ~4,000)
     - Updated quota usage (should be < 500 units for initial sync)

5. **Test caching (verify no new API calls):**
   - Refresh dashboard page
   - Quota should NOT increase (cached data = 0 API calls)
   - Playlists still display correctly

6. **Test session persistence:**
   - Close browser tab
   - Reopen http://localhost:3000
   - Should redirect to dashboard (no re-authentication needed)

7. **Verify database:**
   - Run `npx drizzle-kit studio`
   - Check playlists table has your 87 playlists
   - Check videos table has video data
   - Check quota_usage table has logged operations

**Expected results:**
- ✓ OAuth flow completes without errors
- ✓ Dashboard displays actual YouTube data
- ✓ Watch Later shows ~4,000 videos
- ✓ Quota consumption is tracked and displayed
- ✓ Page refresh doesn't trigger new API calls
- ✓ Session persists across browser restarts

**Check Phase 1 Success Criteria:**
1. ✓ User can authenticate with YouTube OAuth 2.0 and see confirmation
2. ✓ User sees dashboard displaying 87 playlists with video counts and Watch Later count (4,000)
3. ✓ System displays remaining API quota on dashboard
4. ✓ User can view cached playlist data without triggering new API calls
5. ✓ System maintains valid session across multi-hour operations without re-authentication
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe any issues encountered (e.g., "quota exhausted at 50 playlists", "OAuth redirect failing", "session not persisting").
  </resume-signal>
</task>

</tasks>

<verification>
**Pre-human verification (automated checks):**
```bash
# Verify all files exist
ls src/app/page.tsx src/app/dashboard/page.tsx src/components/*.tsx

# Check TypeScript compilation
npm run build

# Verify no console errors on startup
npm run dev &
sleep 5
curl http://localhost:3000 > /dev/null
```

**Code structure validation:**
- Home page redirects authenticated users to dashboard
- Dashboard is Server Component (no 'use client')
- SyncButton is Client Component (has 'use client')
- Components receive props with correct TypeScript types
- Database queries use Drizzle ORM
- Session checks use getServerSession helper
</verification>

<success_criteria>
- Home page displays sign-in button for unauthenticated users
- OAuth flow successfully authenticates and redirects to dashboard
- Dashboard displays actual playlist count after sync (target: 87)
- Watch Later playlist is highlighted with video count (target: ~4,000)
- Quota display shows remaining units with progress bar
- Cached data loads without new API calls (quota doesn't increase on refresh)
- Session persists across page refreshes and browser restarts
- All Phase 1 Success Criteria from roadmap are validated as TRUE
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-api-integration/01-05-SUMMARY.md` using the summary template.
</output>
