---
phase: 01-foundation-and-api-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .env.local
  - drizzle.config.ts
  - src/lib/db/index.ts
  - src/lib/db/schema.ts
autonomous: true

must_haves:
  truths:
    - "Application has Next.js 15 installed with App Router"
    - "PostgreSQL connection is configured and tested"
    - "Database schema exists with playlists, videos, and cache tables"
    - "Environment variables are documented"
  artifacts:
    - path: "package.json"
      provides: "Next.js 15, Drizzle ORM, and core dependencies"
      contains: "next@15"
    - path: "drizzle.config.ts"
      provides: "Drizzle Kit configuration for migrations"
      exports: ["default"]
    - path: "src/lib/db/schema.ts"
      provides: "Database schema with ETag support"
      contains: "playlists, videos, cacheMetadata, quotaUsage"
    - path: "src/lib/db/index.ts"
      provides: "Drizzle database instance with connection pool"
      exports: ["db"]
  key_links:
    - from: "src/lib/db/index.ts"
      to: "process.env.DATABASE_URL"
      via: "pg Pool initialization"
      pattern: "connectionString.*DATABASE_URL"
    - from: "drizzle.config.ts"
      to: "src/lib/db/schema.ts"
      via: "schema import"
      pattern: "schema.*db/schema"
---

<objective>
Initialize Next.js 15 application with TypeScript, install core dependencies (Drizzle ORM, PostgreSQL, googleapis, NextAuth), and establish database schema with ETag caching support.

Purpose: Foundation layer required by all subsequent plans. No YouTube API integration yet—just project scaffolding and database setup.

Output: Working Next.js app with configured database connection and schema ready for data storage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-and-api-integration/01-RESEARCH.md

**Key constraints from research:**
- Must use Next.js 15 App Router (not Pages Router)
- Must configure PostgreSQL with serverless-compatible connection pooling (max: 1)
- Must include ETag columns in schema from day 1 (critical for quota optimization)
- Must use Drizzle ORM with `push` command for rapid development (not migrations yet)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js 15 Application</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    .gitignore
    src/app/layout.tsx
    src/app/page.tsx
    tailwind.config.ts
    postcss.config.mjs
  </files>
  <action>
Run `npx create-next-app@latest` with these options:
- TypeScript: Yes
- ESLint: Yes
- Tailwind CSS: Yes
- src/ directory: Yes
- App Router: Yes
- Turbopack: Yes
- Import alias: @/* (default)

Then install core dependencies:
```bash
npm install googleapis next-auth@beta @auth/drizzle-adapter drizzle-orm bottleneck pg zod
npm install -D drizzle-kit @types/pg tsx
```

Verify installation with `npm list next` (should show 15.x) and `npm list drizzle-orm`.
  </action>
  <verify>
Run `npm list next drizzle-orm next-auth` and confirm versions:
- next: 15.x
- drizzle-orm: 0.36+
- next-auth: 5.x (beta)

Run `npm run dev` and verify app starts on http://localhost:3000
  </verify>
  <done>
Next.js 15 application starts successfully with all core dependencies installed. Default page renders at localhost:3000.
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Database Schema with ETag Support</name>
  <files>
    src/lib/db/schema.ts
    drizzle.config.ts
  </files>
  <action>
Create `src/lib/db/schema.ts` implementing the schema from research Pattern 5 (Database Schema with ETag Metadata).

Include these tables:
- **playlists**: youtubeId (unique), title, description, thumbnailUrl, itemCount, etag, lastFetched, createdAt, updatedAt
- **videos**: youtubeId (unique), title, description, thumbnailUrl, channelTitle, duration, publishedAt, etag, lastFetched, createdAt, updatedAt
- **playlistVideos**: Join table linking playlists to videos with position field
- **cacheMetadata**: cacheKey (unique), etag, data (jsonb for full response), timestamp
- **quotaUsage**: date, unitsUsed, operation, details (jsonb)

Use `pgTable`, `serial`, `text`, `integer`, `timestamp`, `jsonb` from 'drizzle-orm/pg-core'.

Create `drizzle.config.ts` pointing to `DATABASE_URL` environment variable with schema exported from `./src/lib/db/schema.ts`.

**Important:** Use standard `serial()` for now (research mentions `generatedAlwaysAsIdentity()` but serial is simpler for initial setup).
  </action>
  <verify>
Run `npx drizzle-kit generate` (should fail with "DATABASE_URL not found" - expected until Task 3).

Verify schema file exports all tables: `playlists, videos, playlistVideos, cacheMetadata, quotaUsage`.
  </verify>
  <done>
Database schema file exists with all 5 tables defined. Drizzle config points to correct schema file. Schema follows research patterns with ETag support.
  </done>
</task>

<task type="auto">
  <name>Task 3: Setup PostgreSQL Connection and Push Schema</name>
  <files>
    .env.local
    src/lib/db/index.ts
  </files>
  <action>
Create `.env.local` with these required variables (empty values for now):
```
DATABASE_URL=postgresql://...
AUTH_SECRET=
AUTH_GOOGLE_ID=
AUTH_GOOGLE_SECRET=
NEXTAUTH_URL=http://localhost:3000
```

Create `src/lib/db/index.ts` implementing Pattern 4 (PostgreSQL Connection for Vercel Serverless):
- Import `Pool` from 'pg' and `drizzle` from 'drizzle-orm/node-postgres'
- Create global pool with `max: 1` (serverless-compatible)
- Export `db` instance: `export const db = drizzle(pool)`

**Local database setup:**
1. Check if PostgreSQL is installed locally: `which psql`
2. If not installed, use Docker: `docker run --name youtube-org-db -e POSTGRES_PASSWORD=postgres -p 5432:5432 -d postgres:16`
3. Create database: `docker exec youtube-org-db createdb -U postgres youtube_organizer` (or `createdb youtube_organizer` if local psql)
4. Update `.env.local` DATABASE_URL to: `postgresql://postgres:postgres@localhost:5432/youtube_organizer`

Push schema to database: `npx drizzle-kit push`

Test connection programmatically:
Create `test-db.ts` in project root:
```typescript
import { db } from './src/lib/db'
import { playlists } from './src/lib/db/schema'

async function testConnection() {
  console.log('Testing database connection...')
  const result = await db.select().from(playlists).limit(1)
  console.log('✓ Connection successful!')
  process.exit(0)
}

testConnection().catch(err => {
  console.error('✗ Connection failed:', err)
  process.exit(1)
})
```

Run test: `npx tsx test-db.ts`
  </action>
  <verify>
Run `npx drizzle-kit push` - should succeed and create tables.

Run programmatic verification:
```bash
npx tsx test-db.ts
```
Should output "✓ Connection successful!" without errors.

Run `npx drizzle-kit studio` to open Drizzle Studio and verify all 5 tables exist in the database.

Check Docker container is running: `docker ps` (if using Docker).
  </verify>
  <done>
PostgreSQL database is running (locally or Docker). DATABASE_URL is configured. Schema is pushed to database. All 5 tables exist and are accessible via Drizzle Studio.
  </done>
</task>

</tasks>

<verification>
**After all tasks complete:**
1. Run `npm run dev` - app should start without errors
2. Visit http://localhost:3000 - Next.js welcome page renders
3. Run `npx drizzle-kit studio` - opens database GUI showing 5 empty tables
4. Run `npm list` - verify no peer dependency warnings for core packages

**Schema validation:**
Check Drizzle Studio shows these tables:
- playlists (with etag column)
- videos (with etag column)
- playlist_videos (join table)
- cache_metadata (with jsonb data column)
- quota_usage (with jsonb details column)
</verification>

<success_criteria>
- Next.js 15 application runs on localhost:3000 with TypeScript and Tailwind configured
- PostgreSQL database is running and accessible
- All 5 database tables exist with correct schema (ETag columns present)
- Core dependencies installed: googleapis, next-auth@beta, drizzle-orm, bottleneck
- Environment variables file exists with documented placeholders
- No build errors or dependency conflicts
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-api-integration/01-01-SUMMARY.md` using the summary template.
</output>
