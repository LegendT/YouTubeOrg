---
phase: 06-review-and-approval-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/actions/ml-categorization.ts
  - src/types/ml.ts
autonomous: true

must_haves:
  truths:
    - "System can mark ML suggestion as accepted with timestamp"
    - "System can mark ML suggestion as rejected with timestamp"
    - "System can store user's manual category choice for rejected videos"
    - "User can fetch videos with ML suggestions filtered by review status and confidence"
    - "User can fetch full video details with category info for modal display"
  artifacts:
    - path: "src/app/actions/ml-categorization.ts"
      provides: "Server actions for review workflow"
      exports: ["acceptSuggestion", "rejectSuggestion", "recategorizeVideo", "getReviewData", "getVideoReviewDetail"]
    - path: "src/types/ml.ts"
      provides: "Review data types"
      exports: ["ReviewResult", "ReviewStats", "VideoReviewDetail"]
  key_links:
    - from: "acceptSuggestion"
      to: "mlCategorizations.acceptedAt"
      via: "Drizzle ORM update"
      pattern: "update.*acceptedAt.*new Date"
    - from: "getReviewData"
      to: "videos/categories/mlCategorizations"
      via: "three-way join query"
      pattern: "select.*join.*mlCategorizations.*join.*categories"
---

<objective>
Create server actions and type definitions for the ML review workflow, enabling accept/reject/recategorize operations and efficient data fetching with joins.

Purpose: Provides database persistence layer for review interface, supporting optimistic UI updates and filtered queries by confidence level and review status.

Output: 5 new server actions and 3 type definitions in existing ml-categorization.ts and ml.ts files.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-review-and-approval-interface/06-CONTEXT.md
@.planning/phases/06-review-and-approval-interface/06-RESEARCH.md
@src/app/actions/ml-categorization.ts
@src/types/ml.ts
@src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Add review workflow server actions</name>
  <files>
    src/app/actions/ml-categorization.ts
    src/types/ml.ts
  </files>
  <action>
Extend existing ml-categorization.ts with 5 new server actions:

1. **acceptSuggestion(videoId: number)**: Updates mlCategorizations.acceptedAt to current timestamp using Drizzle update() + set() + where(). Returns { success: boolean, error?: string }.

2. **rejectSuggestion(videoId: number)**: Updates mlCategorizations.rejectedAt to current timestamp. Returns { success: boolean, error?: string }.

3. **recategorizeVideo(videoId: number, newCategoryId: number)**: Updates mlCategorizations.manualCategoryId and sets rejectedAt if not already set. Returns { success: boolean, error?: string }.

4. **getReviewData(confidenceFilter?: 'HIGH' | 'MEDIUM' | 'LOW', reviewStatus?: 'all' | 'pending' | 'accepted' | 'rejected')**: Performs three-way join (videos -> mlCategorizations -> categories) to fetch enriched review data. Returns ReviewResult[] with video metadata, suggested category name, confidence, similarityScore, acceptedAt, rejectedAt, manualCategoryId. Use conditional where clauses: confidenceFilter filters on confidence column, reviewStatus filters on acceptedAt/rejectedAt nullability (pending = both null, accepted = acceptedAt not null, rejected = rejectedAt not null).

5. **getVideoReviewDetail(videoId: number)**: Fetches single video with full metadata, ML categorization details, suggested category object, and list of all non-protected categories for manual recategorization picker. Returns VideoReviewDetail | null.

Add types to src/types/ml.ts:
- ReviewResult: { videoId, youtubeId, title, thumbnailUrl, channelTitle, duration, publishedAt, suggestedCategoryId, suggestedCategoryName, confidence, similarityScore, acceptedAt, rejectedAt, manualCategoryId }
- ReviewStats: { total, reviewed, pending, highConfidence, mediumConfidence, lowConfidence }
- VideoReviewDetail: { video: VideoCardData, categorization: MLCategorizationResult, suggestedCategory: Category, allCategories: Category[] }

Pattern: Follow existing server action error handling (try/catch, console.error, return success: false).
  </action>
  <verify>
Run TypeScript compiler to check types:
```bash
npm run build
```

Check server actions can be imported:
```bash
grep -n "export async function acceptSuggestion" src/app/actions/ml-categorization.ts
grep -n "export async function getReviewData" src/app/actions/ml-categorization.ts
grep -n "export type ReviewResult" src/types/ml.ts
```
  </verify>
  <done>
- acceptSuggestion/rejectSuggestion/recategorizeVideo functions update mlCategorizations table timestamps
- getReviewData performs three-way join and returns enriched ReviewResult[]
- getVideoReviewDetail returns single video with full categorization context
- ReviewResult, ReviewStats, VideoReviewDetail types exported from ml.ts
- TypeScript compilation succeeds with no errors
  </done>
</task>

<task type="auto">
  <name>Add review statistics helper function</name>
  <files>
    src/app/actions/ml-categorization.ts
  </files>
  <action>
Add server action getReviewStats(): Promise<ReviewStats> that calculates statistics from mlCategorizations table:

- total: COUNT(*) from mlCategorizations
- reviewed: COUNT(*) where acceptedAt IS NOT NULL OR rejectedAt IS NOT NULL
- pending: COUNT(*) where acceptedAt IS NULL AND rejectedAt IS NULL
- highConfidence: COUNT(*) where confidence = 'HIGH'
- mediumConfidence: COUNT(*) where confidence = 'MEDIUM'
- lowConfidence: COUNT(*) where confidence = 'LOW'

Use Drizzle ORM count() aggregation with conditional where clauses. Pattern: Follow existing getMLCategorizationResults structure for conditional queries.

Return ReviewStats object matching type from previous task.
  </action>
  <verify>
Check function exports:
```bash
grep -n "export async function getReviewStats" src/app/actions/ml-categorization.ts
```

Verify return type matches:
```bash
grep -A 10 "export type ReviewStats" src/types/ml.ts
```
  </verify>
  <done>
- getReviewStats function calculates 6 statistics from mlCategorizations table
- Uses Drizzle count() aggregation with WHERE clauses
- Returns ReviewStats type with total, reviewed, pending, and confidence breakdowns
- TypeScript compilation succeeds
  </done>
</task>

</tasks>

<verification>
1. All 6 new server actions export from ml-categorization.ts
2. All 3 new types export from ml.ts
3. TypeScript compilation succeeds (npm run build)
4. Server actions follow existing error handling patterns (try/catch, return success: false)
5. getReviewData performs efficient three-way join (no N+1 queries)
</verification>

<success_criteria>
- acceptSuggestion/rejectSuggestion update acceptedAt/rejectedAt timestamps
- recategorizeVideo updates manualCategoryId field
- getReviewData returns enriched ReviewResult[] with video + category data
- getVideoReviewDetail returns single video with all categories for picker
- getReviewStats calculates 6 statistics from mlCategorizations
- All functions compile and follow existing codebase patterns
</success_criteria>

<output>
After completion, create `.planning/phases/06-review-and-approval-interface/06-01-SUMMARY.md`
</output>
