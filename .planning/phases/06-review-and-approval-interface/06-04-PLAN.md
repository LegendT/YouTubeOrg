---
phase: 06-review-and-approval-interface
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - src/app/ml-review/page.tsx
  - src/components/ml-review/review-page.tsx
  - src/components/ml-review/category-picker-dialog.tsx
  - src/components/nav-bar.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to /ml-review page from navbar"
    - "User can press Tab to cycle focus through grid cards"
    - "User can press Enter to open modal for focused card"
    - "User sees optimistic UI updates when accepting/rejecting suggestions"
    - "User can filter to show only rejected videos and manually assign categories"
    - "User can see real-time progress updates as they review videos"
  artifacts:
    - path: "src/app/ml-review/page.tsx"
      provides: "Server Component for data loading"
      min_lines: 30
    - path: "src/components/ml-review/review-page.tsx"
      provides: "Client orchestrator for review workflow"
      min_lines: 200
    - path: "src/components/ml-review/category-picker-dialog.tsx"
      provides: "Manual recategorization dialog"
      min_lines: 80
  key_links:
    - from: "ReviewPage Tab handler"
      to: "gridFocusIndex state"
      via: "useHotkeys with enabled: !isModalOpen"
      pattern: "useHotkeys.*tab.*setGridFocusIndex"
    - from: "acceptSuggestion action"
      to: "optimistic UI update"
      via: "useOptimistic hook"
      pattern: "useOptimistic.*acceptedAt"
    - from: "CategoryPickerDialog"
      to: "recategorizeVideo server action"
      via: "Dialog with category selection"
      pattern: "recategorizeVideo.*selectedCategoryId"
---

<objective>
Create page orchestrator with Tab/Enter keyboard navigation, optimistic UI updates, category picker for rejected videos, navbar integration, and end-to-end verification.

Purpose: Wires all components together into complete review workflow with keyboard-first navigation, instant feedback, and manual recategorization capability.

Output: 3 new files (Server Component page, Client orchestrator, Category picker) + navbar link integration + verified end-to-end workflow.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-review-and-approval-interface/06-CONTEXT.md
@.planning/phases/06-review-and-approval-interface/06-RESEARCH.md
@src/components/ml-review/review-grid.tsx
@src/components/ml-review/review-modal.tsx
@src/components/ml-review/review-progress.tsx
@src/components/nav-bar.tsx
@src/app/actions/ml-categorization.ts
</context>

<tasks>

<task type="auto">
  <name>Create Server Component page for data loading</name>
  <files>
    src/app/ml-review/page.tsx
  </files>
  <action>
Create page.tsx Server Component for /ml-review route:

**Implementation:**
- Import getReviewData, getReviewStats from @/app/actions/ml-categorization
- Import ReviewPage from @/components/ml-review/review-page (client component)
- Fetch initial data: const [results, stats] = await Promise.all([getReviewData('all', 'pending'), getReviewStats()])
- Handle empty state: if results.length === 0, show "No videos to review" message
- Pass results and stats to ReviewPage client component as props
- Add page metadata: export const metadata = { title: 'ML Review - YouTube Playlist Organizer' }

Pattern: Follow Phase 4 src/app/videos/page.tsx pattern - Server Component loads data, Client Component handles interactivity.
  </action>
  <verify>
Check page exports:
```bash
grep -n "export default async function" src/app/ml-review/page.tsx
grep -n "getReviewData" src/app/ml-review/page.tsx
npm run build
```
  </verify>
  <done>
- Server Component page created at /ml-review route
- Fetches initial review data and stats via server actions
- Renders ReviewPage client component with data props
- Handles empty state with message
- TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Create orchestrator component with keyboard navigation and optimistic updates</name>
  <files>
    src/components/ml-review/review-page.tsx
  </files>
  <action>
Create ReviewPage client component ('use client' directive) to orchestrate review workflow:

**Props:** initialResults: ReviewResult[], initialStats: ReviewStats

**State:**
- results: ReviewResult[] (optimistic state via useOptimistic)
- stats: ReviewStats (normal state)
- gridFocusIndex: number (for Tab navigation)
- selectedVideoId: number | null (for modal)
- confidenceFilter: 'all' | 'HIGH' | 'MEDIUM' | 'LOW' (for filtering)
- reviewStatusFilter: 'pending' | 'rejected' (for rejected video recategorization)
- showCategoryPicker: boolean (for manual recategorization dialog)
- pickerVideoId: number | null (video being recategorized)

**Computed:**
- filteredResults: useMemo to filter results by confidenceFilter and reviewStatusFilter
- isModalOpen: selectedVideoId !== null

**Keyboard navigation (useHotkeys):**
1. **Tab:** Navigate forward through grid
   - useHotkeys('tab', handler, { enabled: !isModalOpen, preventDefault: true })
   - Handler: setGridFocusIndex((prev) => (prev + 1) % filteredResults.length)
2. **Shift+Tab:** Navigate backward through grid
   - useHotkeys('shift+tab', handler, { enabled: !isModalOpen, preventDefault: true })
   - Handler: setGridFocusIndex((prev) => (prev - 1 + filteredResults.length) % filteredResults.length)
3. **Enter:** Open modal for focused card
   - useHotkeys('enter', handler, { enabled: !isModalOpen, preventDefault: true })
   - Handler: setSelectedVideoId(filteredResults[gridFocusIndex]?.videoId || null)

**Optimistic updates pattern (RESEARCH.md Pattern 4):**
- useOptimistic hook for results state:
  ```typescript
  const [optimisticResults, updateOptimistic] = useOptimistic(
    results,
    (state, { videoId, action }: { videoId: number; action: 'accept' | 'reject' }) => {
      return state.map((r) =>
        r.videoId === videoId
          ? { ...r, acceptedAt: action === 'accept' ? new Date() : r.acceptedAt, rejectedAt: action === 'reject' ? new Date() : r.rejectedAt }
          : r
      );
    }
  );
  ```
- useTransition for pending state

**Accept handler:**
- Call updateOptimistic({ videoId, action: 'accept' })
- startTransition: call acceptSuggestion(videoId) server action
- Update stats (increment reviewed count)
- Auto-advance: setSelectedVideoId(nextVideoId) where nextVideoId is next item in filteredResults

**Reject handler:**
- Call updateOptimistic({ videoId, action: 'reject' })
- startTransition: call rejectSuggestion(videoId) server action
- Update stats (increment reviewed count)
- Auto-advance: setSelectedVideoId(nextVideoId)

**Modal navigate handler:**
- setSelectedVideoId(newVideoId)
- Update gridFocusIndex to match new video's index in filteredResults

**Filter change handler:**
- Reset gridFocusIndex to 0 (RESEARCH.md Pitfall 7)
- Update confidenceFilter state
- Refetch data: getReviewData(confidenceFilter, reviewStatusFilter).then(setResults)

**Category picker handler:**
- When user selects "Recategorize rejected" button, set reviewStatusFilter to 'rejected', show category picker
- CategoryPickerDialog onConfirm: call recategorizeVideo(pickerVideoId, selectedCategoryId), update optimistic state

**Layout:**
- Main container: flex flex-col h-screen
- ReviewProgress at top with stats, confidenceFilter, onFilterChange
- Button for "Recategorize rejected videos" (only shown when reviewStatusFilter === 'pending', onClick sets reviewStatusFilter to 'rejected')
- ReviewGrid in middle (flex-1) with optimisticResults, gridFocusIndex, onCardClick, onFocusChange
- ReviewModal with open, selectedVideoId, resultsList, onClose, onNavigate, onAccept, onReject
- CategoryPickerDialog at bottom (conditional render)
- KeyboardHints overlay

**Imports:** All review components, useOptimistic, useTransition, useHotkeys, server actions from ml-categorization.ts

Pattern: Follow RESEARCH.md Pattern 1 (Grid-to-Modal Navigation State) for keyboard shortcuts with enabled option.
  </action>
  <verify>
Check component structure:
```bash
grep -n "'use client'" src/components/ml-review/review-page.tsx
grep -n "useOptimistic" src/components/ml-review/review-page.tsx
grep -n "useHotkeys" src/components/ml-review/review-page.tsx
npm run build
```
  </verify>
  <done>
- ReviewPage orchestrator created with 'use client' directive
- Tab/Shift+Tab/Enter keyboard shortcuts for grid navigation
- useOptimistic hook for instant accept/reject feedback
- Auto-advance logic after accept/reject actions
- Filter handlers reset gridFocusIndex on change
- Wires ReviewGrid, ReviewModal, ReviewProgress, CategoryPicker, KeyboardHints
- TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Create category picker dialog and navbar integration</name>
  <files>
    src/components/ml-review/category-picker-dialog.tsx
    src/components/nav-bar.tsx
  </files>
  <action>
**1. Create CategoryPickerDialog component:**

**Props:** open: boolean, videoId: number | null, videoTitle: string, currentCategoryName: string, allCategories: Category[], onClose: () => void, onConfirm: (categoryId: number) => void

**Layout (Radix Dialog):**
- Dialog with open={open} onOpenChange={(isOpen) => !isOpen && onClose()}
- DialogContent with max-w-md
- DialogTitle: "Recategorize Video"
- DialogDescription: "Choose a new category for: {videoTitle}"
- Category list: map over allCategories, render button for each
  - Button styling: w-full text-left p-3 rounded hover:bg-secondary transition-colors
  - Highlight currentCategoryName with bg-secondary
  - onClick calls onConfirm(category.id) and closes dialog
- Cancel button at bottom: onClick calls onClose()

**Imports:** Dialog, DialogContent, DialogTitle, DialogDescription from @/components/ui/dialog, Category type from @/types/categories

**2. Add /ml-review link to navbar:**

Edit src/components/nav-bar.tsx:
- Add new navigation link after /ml-categorization link
- Text: "Review"
- href: "/ml-review"
- Icon: ClipboardCheck from lucide-react
- Active state when pathname === '/ml-review'

Pattern: Follow existing NavBar link structure (File, Video, CheckCircle2, Brain icons pattern).
  </action>
  <verify>
Check components:
```bash
grep -n "export function CategoryPickerDialog" src/components/ml-review/category-picker-dialog.tsx
grep -n "ml-review" src/components/nav-bar.tsx
grep -n "ClipboardCheck" src/components/nav-bar.tsx
npm run build
```
  </verify>
  <done>
- CategoryPickerDialog component created with Radix Dialog
- Lists all non-protected categories as clickable buttons
- Highlights current category for context
- onConfirm callback with selected categoryId
- NavBar link added for /ml-review route with ClipboardCheck icon
- TypeScript compilation succeeds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete ML review interface with keyboard-driven workflow:
- Grid with confidence badges and review state indicators
- Modal with A/R shortcuts for accept/reject
- Tab/Enter navigation for grid focus
- Optimistic UI updates
- Category picker for manual recategorization
- Progress tracking with confidence filtering
  </what-built>
  <how-to-verify>
1. Start dev server: npm run dev
2. Navigate to http://localhost:3000/ml-review
3. **Grid navigation:**
   - Press Tab repeatedly - verify focus ring moves through cards
   - Press Shift+Tab - verify focus moves backward
   - Press Enter on focused card - verify modal opens
4. **Modal workflow:**
   - In modal, press A - verify "Accepted" appears, modal advances to next video
   - Press R - verify "Rejected" appears, modal advances to next video
   - Press Left/Right arrows - verify navigation between videos without closing modal
   - Press Escape - verify modal closes and returns to grid
5. **Progress tracking:**
   - Verify reviewed count increases after each accept/reject action
   - Click confidence filter buttons (All/High/Medium/Low) - verify grid updates
6. **Category picker:**
   - Click "Recategorize rejected videos" button - verify filter changes to show rejected items
   - Click a rejected video card - verify category picker dialog opens
   - Select a category - verify video reassigned
7. **Keyboard hints:**
   - Verify keyboard shortcuts overlay visible in bottom-right corner
   - Verify all shortcuts listed (Tab, Enter, A, R, arrows, Escape)
  </how-to-verify>
  <resume-signal>
Type "approved" if workflow functions correctly, or describe issues encountered.
  </resume-signal>
</task>

</tasks>

<verification>
1. Server Component page loads initial data via server actions
2. ReviewPage orchestrates Tab/Enter navigation with conditional shortcuts
3. useOptimistic provides instant feedback for accept/reject actions
4. Auto-advance logic works after accept/reject (modal shows next video)
5. CategoryPickerDialog allows manual recategorization of rejected videos
6. NavBar link navigates to /ml-review route
7. All keyboard shortcuts work as specified (A/R/Tab/Enter/Escape/arrows)
8. TypeScript compilation succeeds (npm run build)
9. End-to-end verification confirms full review workflow
</verification>

<success_criteria>
- User can navigate to /ml-review from navbar
- Tab/Shift+Tab cycles grid focus with visual focus ring
- Enter opens modal for focused card
- A key accepts suggestion with optimistic update and auto-advance
- R key rejects suggestion with optimistic update and auto-advance
- Left/Right arrows navigate modal without closing
- Escape closes modal
- Confidence filters update grid view
- Rejected videos can be manually recategorized via category picker
- Progress stats update in real-time as user reviews videos
- All Phase 6 success criteria met and verified
</success_criteria>

<output>
After completion, create `.planning/phases/06-review-and-approval-interface/06-04-SUMMARY.md`
</output>
