---
phase: 06-review-and-approval-interface
plan: 05
type: execute
wave: 4
depends_on: ["06-04"]
files_modified:
  - src/components/ml-review/review-page.tsx
  - src/components/ml-review/category-picker-dialog.tsx
  - src/components/nav-bar.tsx
autonomous: false

must_haves:
  truths:
    - "User sees optimistic UI updates when accepting/rejecting suggestions"
    - "User can filter to show only rejected videos and manually assign categories"
    - "User can navigate to /ml-review page from navbar"
    - "User can see real-time progress updates as they review videos"
  artifacts:
    - path: "src/components/ml-review/review-page.tsx"
      provides: "Enhanced orchestrator with optimistic updates, filters, and category picker"
      min_lines: 200
    - path: "src/components/ml-review/category-picker-dialog.tsx"
      provides: "Manual recategorization dialog"
      min_lines: 80
    - path: "src/components/nav-bar.tsx"
      provides: "NavBar with /ml-review link"
      min_lines: 80
  key_links:
    - from: "acceptSuggestion action"
      to: "optimistic UI update"
      via: "useOptimistic hook"
      pattern: "useOptimistic.*acceptedAt"
    - from: "CategoryPickerDialog"
      to: "recategorizeVideo server action"
      via: "Dialog with category selection"
      pattern: "recategorizeVideo.*selectedCategoryId"
    - from: "Recategorize rejected button"
      to: "reviewStatusFilter state"
      via: "onClick sets filter to 'rejected'"
      pattern: "onClick.*setReviewStatusFilter.*rejected"
---

<objective>
Enhance ReviewPage with optimistic updates, accept/reject handlers, confidence filtering, category picker for rejected videos, auto-advance logic, and navbar integration.

Purpose: Transforms basic grid/modal orchestrator into fully functional review workflow with instant feedback, filtering capabilities, and manual recategorization for edge cases.

Output: Enhanced ReviewPage component + CategoryPickerDialog + NavBar link + end-to-end verification checkpoint.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-review-and-approval-interface/06-CONTEXT.md
@.planning/phases/06-review-and-approval-interface/06-RESEARCH.md
@.planning/phases/06-review-and-approval-interface/06-04-SUMMARY.md
@src/components/ml-review/review-page.tsx
@src/components/nav-bar.tsx
@src/app/actions/ml-categorization.ts
</context>

<tasks>

<task type="auto">
  <name>Add optimistic updates, accept/reject handlers, and filtering to ReviewPage</name>
  <files>
    src/components/ml-review/review-page.tsx
  </files>
  <action>
Enhance existing ReviewPage component from Plan 06-04 with complex features:

**Add state variables:**
- confidenceFilter: 'all' | 'HIGH' | 'MEDIUM' | 'LOW' (for filtering, default 'all')
- reviewStatusFilter: 'pending' | 'rejected' (for rejected video recategorization, default 'pending')
- showCategoryPicker: boolean (for manual recategorization dialog, default false)
- pickerVideoId: number | null (video being recategorized, default null)

**Upgrade results state to optimistic:**
Replace simple useState with useOptimistic hook (RESEARCH.md Pattern 4):
```typescript
const [optimisticResults, updateOptimistic] = useOptimistic(
  results,
  (state, { videoId, action }: { videoId: number; action: 'accept' | 'reject' }) => {
    return state.map((r) =>
      r.videoId === videoId
        ? { ...r, acceptedAt: action === 'accept' ? new Date() : r.acceptedAt, rejectedAt: action === 'reject' ? new Date() : r.rejectedAt }
        : r
    );
  }
);
```
Add useTransition for pending state.

**Add computed values:**
- filteredResults: useMemo to filter optimisticResults by confidenceFilter AND reviewStatusFilter:
  - confidenceFilter !== 'all': filter by result.confidence === confidenceFilter
  - reviewStatusFilter === 'pending': filter by result.acceptedAt === null && result.rejectedAt === null
  - reviewStatusFilter === 'rejected': filter by result.rejectedAt !== null

**Replace placeholder accept/reject handlers with real implementations:**

**Accept handler:**
1. Call updateOptimistic({ videoId, action: 'accept' })
2. startTransition: call acceptSuggestion(videoId) server action
3. Update stats: setStats(prev => ({ ...prev, reviewed: prev.reviewed + 1, pending: prev.pending - 1 }))
4. Auto-advance (RESEARCH.md Pattern 2): Find next video in filteredResults after current, setSelectedVideoId(nextVideoId)

**Reject handler:**
1. Call updateOptimistic({ videoId, action: 'reject' })
2. startTransition: call rejectSuggestion(videoId) server action
3. Update stats: setStats(prev => ({ ...prev, reviewed: prev.reviewed + 1, pending: prev.pending - 1 }))
4. Auto-advance: setSelectedVideoId(nextVideoId)

**Confidence filter change handler:**
1. Reset gridFocusIndex to 0 (RESEARCH.md Pitfall 7 - avoid index out of bounds)
2. Update confidenceFilter state
3. Refetch data: getReviewData(newFilter, reviewStatusFilter).then(setResults)

**Add "Recategorize rejected videos" button:**
- Position: Below ReviewProgress, above ReviewGrid
- Visibility: Only shown when reviewStatusFilter === 'pending' (not when already viewing rejected)
- Text: "Recategorize rejected videos" with icon (Settings from lucide-react)
- onClick handler: setReviewStatusFilter('rejected'), refetch data with rejected filter
- Styling: bg-secondary text-secondary-foreground hover:bg-secondary/80 px-4 py-2 rounded text-sm

**Category picker handler (clarified flow per Blocker 2 fix):**

When user clicks "Recategorize rejected videos" button:
1. Set reviewStatusFilter to 'rejected'
2. Refetch data to show grid of rejected videos
3. Grid now displays rejected videos

When user clicks individual rejected video card in grid:
1. Set pickerVideoId to clicked video's videoId
2. Set showCategoryPicker to true
3. CategoryPickerDialog opens for that SPECIFIC video

CategoryPickerDialog onConfirm handler:
1. Call recategorizeVideo(pickerVideoId, selectedCategoryId) server action
2. Update optimisticResults to reflect category change
3. Close dialog: setShowCategoryPicker(false), setPickerVideoId(null)
4. Optionally refetch data to update stats

**Update layout:**
- ReviewProgress at top (now with real confidenceFilter and onFilterChange handler)
- "Recategorize rejected videos" button (conditional: only when reviewStatusFilter === 'pending')
- ReviewGrid uses filteredResults (not raw optimisticResults)
- ReviewModal uses real accept/reject handlers (not placeholders)
- CategoryPickerDialog at bottom (conditional: showCategoryPicker === true)
  - Props: open={showCategoryPicker}, videoId={pickerVideoId}, videoTitle and currentCategoryName from filteredResults.find, allCategories fetched via getVideoReviewDetail or separate query, onClose, onConfirm handlers
- KeyboardHints overlay

**Add imports:** useOptimistic, useTransition from react, acceptSuggestion, rejectSuggestion, recategorizeVideo, getReviewData from @/app/actions/ml-categorization, CategoryPickerDialog component, Settings icon from lucide-react

Pattern: Follow RESEARCH.md Pattern 2 (Auto-Advance After Decision) and Pattern 4 (Optimistic Updates with useOptimistic).
  </action>
  <verify>
Check enhancements:
```bash
grep -n "useOptimistic" src/components/ml-review/review-page.tsx
grep -n "acceptSuggestion" src/components/ml-review/review-page.tsx
grep -n "filteredResults" src/components/ml-review/review-page.tsx
grep -n "CategoryPickerDialog" src/components/ml-review/review-page.tsx
npm run build
```
  </verify>
  <done>
- ReviewPage enhanced with useOptimistic hook for instant feedback
- Real accept/reject handlers calling server actions with auto-advance
- Confidence filter handler with gridFocusIndex reset
- Review status filtering (pending vs rejected)
- "Recategorize rejected videos" button sets filter to 'rejected'
- Category picker integration: button shows rejected grid â†’ clicking rejected card opens picker for that specific video
- Stats update in real-time as user reviews
- TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Create category picker dialog and navbar integration</name>
  <files>
    src/components/ml-review/category-picker-dialog.tsx
    src/components/nav-bar.tsx
  </files>
  <action>
**1. Create CategoryPickerDialog component:**

**Props:** open: boolean, videoId: number | null, videoTitle: string, currentCategoryName: string, allCategories: Category[], onClose: () => void, onConfirm: (categoryId: number) => void

**Layout (Radix Dialog):**
- Dialog with open={open} onOpenChange={(isOpen) => !isOpen && onClose()}
- DialogContent with max-w-md
- DialogTitle: "Recategorize Video"
- DialogDescription: "Choose a new category for: {videoTitle}"
- Category list: map over allCategories, render button for each
  - Button styling: w-full text-left p-3 rounded hover:bg-secondary transition-colors
  - Highlight currentCategoryName with bg-secondary
  - onClick calls onConfirm(category.id) and closes dialog
- Cancel button at bottom: onClick calls onClose()

**Imports:** Dialog, DialogContent, DialogTitle, DialogDescription from @/components/ui/dialog, Category type from @/types/categories

**2. Add /ml-review link to navbar:**

Edit src/components/nav-bar.tsx:
- Add new navigation link after /ml-categorization link
- Text: "Review"
- href: "/ml-review"
- Icon: ClipboardCheck from lucide-react
- Active state when pathname === '/ml-review'

Pattern: Follow existing NavBar link structure (File, Video, CheckCircle2, Brain icons pattern).
  </action>
  <verify>
Check components:
```bash
grep -n "export function CategoryPickerDialog" src/components/ml-review/category-picker-dialog.tsx
grep -n "ml-review" src/components/nav-bar.tsx
grep -n "ClipboardCheck" src/components/nav-bar.tsx
npm run build
```
  </verify>
  <done>
- CategoryPickerDialog component created with Radix Dialog
- Lists all non-protected categories as clickable buttons
- Highlights current category for context
- onConfirm callback with selected categoryId
- NavBar link added for /ml-review route with ClipboardCheck icon
- TypeScript compilation succeeds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete ML review interface with keyboard-driven workflow:
- Grid with confidence badges and review state indicators
- Modal with A/R shortcuts for accept/reject
- Tab/Enter navigation for grid focus
- Optimistic UI updates for instant feedback
- Category picker for manual recategorization of rejected videos
- Progress tracking with confidence filtering
  </what-built>
  <how-to-verify>
1. Start dev server: npm run dev
2. Navigate to http://localhost:3000/ml-review
3. **Grid navigation:**
   - Press Tab repeatedly - verify focus ring moves through cards
   - Press Shift+Tab - verify focus moves backward
   - Press Enter on focused card - verify modal opens
4. **Modal workflow:**
   - In modal, press A - verify "Accepted" appears instantly, modal advances to next video
   - Press R - verify "Rejected" appears instantly, modal advances to next video
   - Press Left/Right arrows - verify navigation between videos without closing modal
   - Press Escape - verify modal closes and returns to grid
5. **Progress tracking:**
   - Verify reviewed count increases after each accept/reject action
   - Click confidence filter buttons (All/High/Medium/Low) - verify grid updates
6. **Category picker flow (clarified):**
   - Click "Recategorize rejected videos" button - verify filter changes to show rejected items in grid
   - Click a rejected video card in the grid - verify category picker dialog opens for THAT specific video
   - Select a category in the dialog - verify video reassigned and dialog closes
   - Verify video now shows updated category
7. **Keyboard hints:**
   - Verify keyboard shortcuts overlay visible in bottom-right corner
   - Verify all shortcuts listed (Tab, Enter, A, R, arrows, Escape)
8. **NavBar:**
   - Verify "Review" link appears in navbar with ClipboardCheck icon
   - Click link - verify navigates to /ml-review
  </how-to-verify>
  <resume-signal>
Type "approved" if workflow functions correctly, or describe issues encountered.
  </resume-signal>
</task>

</tasks>

<verification>
1. ReviewPage uses useOptimistic for instant accept/reject feedback
2. Auto-advance logic works after accept/reject (modal shows next video)
3. Confidence filter updates grid and refetches data
4. "Recategorize rejected videos" button changes filter to show rejected grid
5. Clicking rejected video card opens CategoryPickerDialog for that specific video
6. CategoryPickerDialog allows manual recategorization with server action call
7. NavBar link navigates to /ml-review route
8. All keyboard shortcuts work as specified (A/R/Tab/Enter/Escape/arrows)
9. TypeScript compilation succeeds (npm run build)
10. End-to-end verification confirms full review workflow
</verification>

<success_criteria>
- User can navigate to /ml-review from navbar
- A key accepts suggestion with optimistic update and auto-advance
- R key rejects suggestion with optimistic update and auto-advance
- Confidence filters update grid view and refetch data
- "Recategorize rejected videos" button shows rejected video grid
- Clicking rejected video card opens category picker for that specific video
- Category picker successfully reassigns video category
- Progress stats update in real-time as user reviews videos
- All Phase 6 success criteria met and verified
</success_criteria>

<output>
After completion, create `.planning/phases/06-review-and-approval-interface/06-05-SUMMARY.md`
</output>
