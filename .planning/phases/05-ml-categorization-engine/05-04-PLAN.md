---
phase: 05-ml-categorization-engine
plan: 04
type: execute
wave: 4
depends_on: ["05-03"]
files_modified:
  - src/app/ml-categorization/page.tsx
  - src/components/nav-bar.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to ML categorization page from navigation bar"
    - "User can trigger ML categorization and see it complete"
    - "System displays categorization statistics after completion"
    - "Database contains ML categorization records after run"
  artifacts:
    - path: "src/app/ml-categorization/page.tsx"
      provides: "Full-page ML categorization interface"
      exports: []
      min_lines: 60
    - path: "src/components/nav-bar.tsx"
      provides: "Updated navigation with ML Categorization link"
      contains: "ML Categorization"
      min_lines: 50
  key_links:
    - from: "src/app/ml-categorization/page.tsx"
      to: "src/components/ml/categorization-trigger.tsx"
      via: "Component import and usage"
      pattern: "<CategorizationTrigger"
    - from: "src/app/ml-categorization/page.tsx"
      to: "src/components/ml/progress-display.tsx"
      via: "Component import and conditional render"
      pattern: "<ProgressDisplay"
    - from: "src/components/nav-bar.tsx"
      to: "/ml-categorization"
      via: "Link href"
      pattern: "href.*ml-categorization"
---

<objective>
Integrate ML categorization components into a dedicated page, add navigation link, push database schema changes, and verify end-to-end categorization workflow with human testing.

Purpose: Complete Phase 5 by connecting all ML infrastructure to the UI, enabling user-triggered categorization, and verifying the full workflow from button click to database persistence.

Output: Working ML categorization page accessible from navigation, database schema deployed, complete end-to-end verification ensuring 4,000 videos can be categorized successfully.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ml-categorization-engine/05-RESEARCH.md

# Plan 03 outputs (dependencies)
@src/app/actions/ml-categorization.ts
@src/components/ml/categorization-trigger.tsx
@src/components/ml/progress-display.tsx
@src/types/ml.ts

# Existing navigation and page patterns
@src/components/nav-bar.tsx
@src/app/videos/page.tsx
@src/app/analysis/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database Schema Push and Verification</name>
  <files>None (database operation)</files>
  <action>
Push database schema changes from Plan 02 to create mlCategorizations table, then verify table creation before proceeding to UI.

**FIXED BLOCKER 2:** Separated schema push into dedicated task with verification step before creating UI that depends on it.

**Step 1: Push Database Schema**

Run Drizzle push to create mlCategorizations table (per STATE.md decision from 01-01: use push for development):

```bash
npx drizzle-kit push
```

**Step 2: Verify Table Created**

Confirm mlCategorizations table exists in database:

```bash
psql -h localhost -U postgres -d youtubeorg -c "\d ml_categorizations"
```

Expected output: Table with columns id, video_id, suggested_category_id, confidence, similarity_score, model_version, created_at, accepted_at, rejected_at, manual_category_id.

**Step 3: Verify Enum Type Created**

Check confidence_level enum:

```bash
psql -h localhost -U postgres -d youtubeorg -c "\dT+ confidence_level"
```

Expected output: Enum with values HIGH, MEDIUM, LOW.

**Key details:**
- Schema push creates both table and enum type
- Verification prevents runtime errors in UI (Task 2)
- Task 2 will not proceed until this verification passes
- If push fails, error will be caught before UI creation

**Avoid:**
- Don't skip verification - Task 2 depends on this table existing
- Don't proceed if table creation fails
  </action>
  <verify>
Run: npx drizzle-kit push (no errors, schema changes applied)
Run: psql -h localhost -U postgres -d youtubeorg -c "\d ml_categorizations" (table exists)
Run: psql -h localhost -U postgres -d youtubeorg -c "\dT+ confidence_level" (enum exists)
Check: Console output shows "ml_categorizations" table with 10 columns
Check: Console output shows "confidence_level" enum with 3 values
  </verify>
  <done>
Database schema pushed successfully, mlCategorizations table created with all columns (id, video_id, suggested_category_id, confidence, similarity_score, model_version, created_at, accepted_at, rejected_at, manual_category_id), confidence_level enum created with HIGH/MEDIUM/LOW values, table structure verified before proceeding to UI creation.
  </done>
</task>

<task type="auto">
  <name>Task 2: ML Categorization Page and Navigation</name>
  <files>src/app/ml-categorization/page.tsx, src/app/ml-categorization/ml-categorization-page.tsx, src/components/nav-bar.tsx</files>
  <action>
Create ML categorization page with integrated components from Plan 03 and update navigation bar.

**Prerequisites:** Task 1 must complete successfully (mlCategorizations table verified in database).

**Step 1: Create ML Categorization Page**

File: src/app/ml-categorization/page.tsx

```typescript
import { Suspense } from 'react';
import { redirect } from 'next/navigation';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth/config';
import { MLCategorizationPage } from './ml-categorization-page';

export default async function Page() {
  const session = await getServerSession(authOptions);

  if (!session) {
    redirect('/api/auth/signin');
  }

  return (
    <Suspense fallback={<div className="p-8">Loading ML categorization...</div>}>
      <MLCategorizationPage />
    </Suspense>
  );
}
```

File: src/app/ml-categorization/ml-categorization-page.tsx

```typescript
'use client';

import { useState } from 'react';
import { CategorizationTrigger } from '@/components/ml/categorization-trigger';
import { ProgressDisplay } from '@/components/ml/progress-display';
import type { RunMLCategorizationResult, MLProgressUpdate } from '@/types/ml';

export function MLCategorizationPage() {
  const [progress, setProgress] = useState<MLProgressUpdate>({
    current: 0,
    total: 0,
    percentage: 0,
    status: 'Ready to categorize',
  });
  const [result, setResult] = useState<RunMLCategorizationResult | null>(null);

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-white border-b border-gray-200 px-8 py-6">
        <h1 className="text-2xl font-bold text-gray-900">ML Video Categorization</h1>
        <p className="mt-2 text-sm text-gray-600">
          Automatically categorize videos using machine learning. This process analyzes video titles and
          descriptions to suggest the best category match.
        </p>
      </div>

      {/* Main Content */}
      <div className="p-8">
        <div className="max-w-2xl mx-auto space-y-6">
          {/* Information Card */}
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h2 className="font-semibold text-blue-900 mb-2">How it works</h2>
            <ul className="text-sm text-blue-800 space-y-1 list-disc list-inside">
              <li>Analyzes video titles and channel names using AI embeddings</li>
              <li>Matches videos to categories based on semantic similarity</li>
              <li>Assigns confidence levels: HIGH, MEDIUM, or LOW</li>
              <li>Processes videos in batches for optimal performance</li>
              <li>Caches embeddings to avoid recomputation on re-runs</li>
            </ul>
          </div>

          {/* Categorization Trigger */}
          <div className="bg-white border border-gray-200 rounded-lg p-6">
            <h2 className="text-lg font-semibold text-gray-900 mb-4">Run Categorization</h2>

            <CategorizationTrigger
              onProgressUpdate={(current, total, percentage, status) => {
                setProgress({ current, total, percentage, status });
              }}
              onComplete={(result) => {
                setResult(result);
              }}
            />

            {/* Progress Display */}
            {progress.total > 0 && (
              <div className="mt-6">
                <ProgressDisplay
                  current={progress.current}
                  total={progress.total}
                  percentage={progress.percentage}
                  status={progress.status}
                />
              </div>
            )}
          </div>

          {/* Results Display */}
          {result && result.success && (
            <div className="bg-green-50 border border-green-200 rounded-lg p-6">
              <h2 className="text-lg font-semibold text-green-900 mb-4">Categorization Complete</h2>

              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span className="text-gray-600">Total Videos:</span>
                  <span className="ml-2 font-semibold text-gray-900">
                    {result.categorizedCount}
                  </span>
                </div>

                <div>
                  <span className="text-gray-600">High Confidence:</span>
                  <span className="ml-2 font-semibold text-green-700">
                    {result.highConfidenceCount}
                  </span>
                </div>

                <div>
                  <span className="text-gray-600">Medium Confidence:</span>
                  <span className="ml-2 font-semibold text-yellow-700">
                    {result.mediumConfidenceCount}
                  </span>
                </div>

                <div>
                  <span className="text-gray-600">Low Confidence:</span>
                  <span className="ml-2 font-semibold text-red-700">
                    {result.lowConfidenceCount}
                  </span>
                </div>
              </div>

              <div className="mt-4 pt-4 border-t border-green-200">
                <p className="text-sm text-green-800">
                  Next step: Review and approve suggestions in the Review Interface (Phase 6)
                </p>
              </div>
            </div>
          )}

          {/* Error Display */}
          {result && !result.success && (
            <div className="bg-red-50 border border-red-200 rounded-lg p-6">
              <h2 className="text-lg font-semibold text-red-900 mb-2">Error</h2>
              <p className="text-sm text-red-800">{result.error}</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
```

**Step 2: Update Navigation Bar**

Add ML Categorization link to nav-bar.tsx after the Videos link:

```typescript
// In the navigation items array, add:
{
  name: 'ML Categorization',
  href: '/ml-categorization',
  current: pathname === '/ml-categorization',
}
```

Follow existing pattern from Phase 4 (Videos link) for consistency.

**Key details:**
- Server Component wrapper handles authentication (redirect if not logged in)
- Client Component (ml-categorization-page.tsx) manages interactive state
- Progress state lifted to page level, passed to ProgressDisplay
- Result state displayed with confidence breakdown
- Information card explains how ML categorization works
- Navigation link follows existing pattern with `current` highlighting
- Use Tailwind classes matching existing pages (gray-50 bg, white cards)

**Avoid:**
- Don't mix server and client logic in same component (separate page.tsx and ml-categorization-page.tsx)
- Don't forget authentication check (redirect to signin)
- Don't use different color scheme than existing pages (consistency matters)
  </action>
  <verify>
Run: npm run dev (starts development server)
Check: Navigate to http://localhost:3000/ml-categorization (page loads)
Check: Navigation bar includes "ML Categorization" link
Check: Page displays "Run ML Categorization" button
Check: Information card explains how categorization works
Run: npm run type-check (no TypeScript errors)
  </verify>
  <done>
ML categorization page implemented with CategorizationTrigger and ProgressDisplay integration, authentication check redirects unauthenticated users, navigation bar updated with ML Categorization link, results display shows confidence breakdown, information card explains process, Tailwind styling consistent with existing pages. Task depends on Task 1 completion (verified schema push).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete ML categorization workflow: IndexedDB embeddings cache, Web Worker with Transformers.js singleton, cosine similarity functions, batch categorization engine, server actions with database persistence, React components for triggering and progress display, and full-page UI integration.
  </what-built>
  <how-to-verify>
**Pre-verification checks:**

1. **Database Schema Verification:**
   ```bash
   psql -h localhost -U postgres -d youtubeorg -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'ml_categorizations';"
   ```
   Expected: Table ml_categorizations exists

2. **Development Server:**
   ```bash
   npm run dev
   ```
   Visit http://localhost:3000

**End-to-end test sequence:**

1. **Navigation:**
   - Click "ML Categorization" in navigation bar
   - Confirm page loads with header "ML Video Categorization"
   - Verify information card displays (blue background, 5 bullet points)

2. **Categorization Execution:**
   - Click "Run ML Categorization" button
   - Button should disable and show "Categorizing..." text
   - Progress bar should appear (may jump to 100% if server action completes quickly)
   - Wait for completion (may take 30-60 seconds for initial model download)

3. **First-time Model Download:**
   - Open browser DevTools → Console
   - Look for "[ML Worker] Model loading progress" messages
   - First run downloads ~50-100MB model (5-10 seconds)
   - Subsequent runs use cached model (instant)

4. **Results Verification:**
   - After completion, green success card should appear
   - Check statistics:
     - Total Videos: should match video count in database
     - High/Medium/Low confidence counts (sum = total)
   - Statistics should be non-zero (not all zeros)

5. **Database Persistence:**
   ```bash
   psql -h localhost -U postgres -d youtubeorg -c "SELECT confidence, COUNT(*) FROM ml_categorizations GROUP BY confidence;"
   ```
   Expected output:
   ```
    confidence | count
   ------------+-------
    HIGH       |   XXX
    MEDIUM     |   XXX
    LOW        |   XXX
   ```
   Counts should match UI statistics

6. **IndexedDB Cache Verification:**
   - Open DevTools → Application → IndexedDB
   - Database "ml-embeddings" should exist
   - Object store "embeddings" should contain records
   - Each record has keys: videoId, modelVersion, embedding (Float32Array), generatedAt

7. **Re-run Test (Cache Validation):**
   - Click "Run ML Categorization" again
   - Second run should be faster (embeddings cached)
   - Results should be identical (same videos → same categories)

8. **Error Handling:**
   - Stop Docker PostgreSQL container: `docker stop youtube-org-db`
   - Click "Run ML Categorization"
   - Red error card should appear with database connection error
   - Restart container: `docker start youtube-org-db`

**Success criteria:**
- [ ] Navigation link works
- [ ] Button triggers categorization
- [ ] Progress indicator appears
- [ ] Success card shows statistics
- [ ] Database contains ml_categorizations records
- [ ] IndexedDB contains cached embeddings
- [ ] Second run is faster (cache working)
- [ ] Error handling shows error card on failure

**Known limitations to verify:**
- Progress bar may not show incremental updates (server action limitation - acknowledged in Plan 03)
- First run takes longer due to model download (expected per RESEARCH.md)
- If browser has strict privacy settings, IndexedDB may not persist (expected browser behavior)
  </how-to-verify>
  <resume-signal>
Type "approved" if all verification steps pass and ML categorization works end-to-end.

Type "issues" followed by description if any problems found (e.g., "issues: button doesn't trigger categorization, no error shown").
  </resume-signal>
</task>

</tasks>

<verification>
**Phase 5 completion checks:**

1. **All 4 plans executed:**
   - Plan 01: ML foundation (cache, worker, similarity) ✓
   - Plan 02: Database schema + categorization engine ✓
   - Plan 03: Server actions + UI components ✓
   - Plan 04: Integration + verification ✓

2. **Success criteria from ROADMAP.md:**
   - User triggers ML categorization and sees progress indicator ✓
   - System assigns categories with confidence scores (HIGH/MEDIUM/LOW) ✓
   - System completes categorization without browser crash (Web Worker) ✓
   - User can re-run without reprocessing (cached embeddings) ✓

3. **Requirements fulfilled:**
   - ML-01: Auto-categorize using Transformers.js ✓
   - ML-02: Assign confidence scores ✓
   - ML-03: Process in batches (32 videos) ✓
   - ML-04: Cache embeddings to avoid recomputation ✓

4. **Architecture patterns from RESEARCH.md applied:**
   - Pattern 1: Singleton pipeline in Web Worker ✓
   - Pattern 2: Batch processing with progress callbacks ✓
   - Pattern 3: IndexedDB embeddings cache ✓
   - Pattern 4: Cosine similarity for semantic matching ✓
   - Pattern 5: Transferable objects for worker communication ✓
</verification>

<success_criteria>
**Measurable completion:**
- [ ] ml-categorization page exists and loads
- [ ] Navigation bar includes ML Categorization link
- [ ] Database schema includes mlCategorizations table (Task 1 verified)
- [ ] Run ML Categorization button triggers server action
- [ ] Success card displays statistics after completion
- [ ] Database query shows ml_categorizations records
- [ ] IndexedDB contains cached embeddings
- [ ] Second run completes faster (cache working)
- [ ] All 4 Phase 5 success criteria from ROADMAP.md verified
- [ ] Type-check passes with no errors
- [ ] Human verification checkpoint approved
</success_criteria>

<output>
After completion and approval, create `.planning/phases/05-ml-categorization-engine/05-04-SUMMARY.md`
</output>
