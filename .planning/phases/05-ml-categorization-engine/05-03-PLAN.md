---
phase: 05-ml-categorization-engine
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/app/actions/ml-categorization.ts
  - src/components/ml/categorization-trigger.tsx
  - src/components/ml/progress-display.tsx
  - src/types/ml.ts
autonomous: true

must_haves:
  truths:
    - "User can trigger ML categorization from UI"
    - "System shows real-time progress during categorization"
    - "System saves ML categorization results to database"
    - "User sees completion status with success/error counts"
  artifacts:
    - path: "src/app/actions/ml-categorization.ts"
      provides: "Server actions for ML operations"
      exports: ["runMLCategorization", "getMLCategorizationResults"]
      min_lines: 80
    - path: "src/components/ml/categorization-trigger.tsx"
      provides: "UI button to start categorization"
      exports: ["CategorizationTrigger"]
      min_lines: 40
    - path: "src/components/ml/progress-display.tsx"
      provides: "Real-time progress indicator component"
      exports: ["ProgressDisplay"]
      min_lines: 30
    - path: "src/types/ml.ts"
      provides: "TypeScript types for ML categorization"
      exports: ["MLCategorizationResult", "MLProgressUpdate"]
      min_lines: 20
  key_links:
    - from: "src/app/actions/ml-categorization.ts"
      to: "src/lib/ml/categorization-engine.ts"
      via: "MLCategorizationEngine instantiation"
      pattern: "new MLCategorizationEngine"
    - from: "src/components/ml/categorization-trigger.tsx"
      to: "src/app/actions/ml-categorization.ts"
      via: "runMLCategorization import"
      pattern: "import.*runMLCategorization"
    - from: "src/components/ml/progress-display.tsx"
      to: "ML progress state"
      via: "props passing from parent"
      pattern: "progress.*percentage"
---

<objective>
Implement server actions for ML categorization with database persistence and create React components for user-triggered categorization with real-time progress feedback.

Purpose: Bridge the ML categorization engine to the UI, enabling users to trigger categorization of Watch Later videos and see live progress updates as the system processes 4,000 videos in batches.

Output: Server actions handling ML operations, React components for triggering and monitoring categorization, complete UI integration for Phase 5 functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ml-categorization-engine/05-RESEARCH.md

# Plan 02 outputs (dependencies)
@src/lib/ml/categorization-engine.ts
@src/lib/db/schema.ts

# Existing patterns
@src/app/actions/categories.ts
@src/app/actions/videos.ts
@src/types/categories.ts
@src/types/videos.ts

# UI patterns from Phase 4
@src/components/videos/video-toolbar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server Actions and ML Types</name>
  <files>src/app/actions/ml-categorization.ts, src/types/ml.ts</files>
  <action>
Create server actions for ML categorization operations and TypeScript types following existing patterns from categories.ts and videos.ts.

**File: src/types/ml.ts**

```typescript
import type { ConfidenceLevel } from '@/lib/ml/confidence';

/** Result of ML categorization for a single video */
export interface MLCategorizationResult {
  id: number;
  videoId: number;
  suggestedCategoryId: number;
  confidence: ConfidenceLevel;
  similarityScore: number; // 0-100
  modelVersion: string;
  createdAt: Date;
  acceptedAt: Date | null;
  rejectedAt: Date | null;
  manualCategoryId: number | null;
}

/** Progress update during batch categorization */
export interface MLProgressUpdate {
  current: number;
  total: number;
  percentage: number;
  status: string;
}

/** Result of runMLCategorization server action */
export interface RunMLCategorizationResult {
  success: boolean;
  error?: string;
  categorizedCount?: number;
  highConfidenceCount?: number;
  mediumConfidenceCount?: number;
  lowConfidenceCount?: number;
}
```

**File: src/app/actions/ml-categorization.ts**

```typescript
'use server';

import { db } from '@/lib/db';
import { videos, categories, mlCategorizations } from '@/lib/db/schema';
import { MLCategorizationEngine } from '@/lib/ml/categorization-engine';
import type { RunMLCategorizationResult, MLCategorizationResult } from '@/types/ml';
import { eq, inArray } from 'drizzle-orm';

/**
 * Run ML categorization on all uncategorized videos.
 * Note: Progress updates happen client-side (server actions don't stream).
 *
 * @returns Result with success status and categorization counts
 */
export async function runMLCategorization(): Promise<RunMLCategorizationResult> {
  try {
    // Step 1: Fetch all videos that need categorization
    // For Phase 5: categorize all videos (no filter)
    // For Phase 6: filter to Watch Later or uncategorized videos
    const videosToProcess = await db
      .select({
        id: videos.id,
        youtubeId: videos.youtubeId,
        title: videos.title,
        thumbnailUrl: videos.thumbnailUrl,
        duration: videos.duration,
        channelTitle: videos.channelTitle,
        publishedAt: videos.publishedAt,
      })
      .from(videos);

    if (videosToProcess.length === 0) {
      return {
        success: true,
        categorizedCount: 0,
        highConfidenceCount: 0,
        mediumConfidenceCount: 0,
        lowConfidenceCount: 0,
      };
    }

    // Step 2: Fetch all categories (exclude protected "Uncategorized")
    const allCategories = await db
      .select()
      .from(categories)
      .where(eq(categories.isProtected, false));

    if (allCategories.length === 0) {
      return {
        success: false,
        error: 'No categories available for ML categorization',
      };
    }

    // Step 3: Run ML categorization engine
    // Note: Progress callbacks don't work in server actions (no streaming)
    // Progress will be tracked client-side in Plan 04
    const engine = new MLCategorizationEngine();

    const results = await engine.categorizeVideos(
      videosToProcess.map((v) => ({
        ...v,
        categoryNames: [], // Not needed for categorization
      })),
      allCategories
    );

    engine.terminate();

    // Step 4: Persist results to database
    // Delete existing ML categorizations for these videos (re-run scenario)
    const videoIds = videosToProcess.map((v) => v.id);
    await db
      .delete(mlCategorizations)
      .where(inArray(mlCategorizations.videoId, videoIds));

    // Insert new categorization results
    const categorizationRecords = results.map((result) => ({
      videoId: result.videoId,
      suggestedCategoryId: result.suggestedCategoryId,
      confidence: result.confidence,
      similarityScore: result.similarityScore,
      modelVersion: 'all-MiniLM-L6-v2',
    }));

    await db.insert(mlCategorizations).values(categorizationRecords);

    // Step 5: Calculate statistics
    const highCount = results.filter((r) => r.confidence === 'HIGH').length;
    const mediumCount = results.filter((r) => r.confidence === 'MEDIUM').length;
    const lowCount = results.filter((r) => r.confidence === 'LOW').length;

    return {
      success: true,
      categorizedCount: results.length,
      highConfidenceCount: highCount,
      mediumConfidenceCount: mediumCount,
      lowConfidenceCount: lowCount,
    };
  } catch (error) {
    console.error('[runMLCategorization] Error:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
    };
  }
}

/**
 * Fetch ML categorization results for a specific video.
 *
 * @param videoId - Video database ID
 * @returns ML categorization result or null if not found
 */
export async function getMLCategorizationForVideo(
  videoId: number
): Promise<MLCategorizationResult | null> {
  try {
    const result = await db
      .select()
      .from(mlCategorizations)
      .where(eq(mlCategorizations.videoId, videoId))
      .limit(1);

    if (result.length === 0) return null;

    return result[0] as MLCategorizationResult;
  } catch (error) {
    console.error('[getMLCategorizationForVideo] Error:', error);
    return null;
  }
}

/**
 * Get all ML categorization results, optionally filtered by confidence level.
 *
 * @param confidenceFilter - Optional: 'HIGH', 'MEDIUM', 'LOW'
 * @returns Array of categorization results
 */
export async function getMLCategorizationResults(
  confidenceFilter?: 'HIGH' | 'MEDIUM' | 'LOW'
): Promise<MLCategorizationResult[]> {
  try {
    let query = db.select().from(mlCategorizations);

    if (confidenceFilter) {
      query = query.where(eq(mlCategorizations.confidence, confidenceFilter));
    }

    const results = await query;
    return results as MLCategorizationResult[];
  } catch (error) {
    console.error('[getMLCategorizationResults] Error:', error);
    return [];
  }
}
```

**Key details:**
- **FIXED BLOCKER 1:** Changed delete operation from `eq(mlCategorizations.videoId, videosToProcess.map((v) => v.id)[0])` to `inArray(mlCategorizations.videoId, videoIds)` to delete ALL videos' categorizations, not just the first one
- Added `inArray` import from drizzle-orm for proper array-based deletion
- Server actions can't stream progress (limitation noted in comments)
- Delete + insert pattern for re-run scenarios (fresh categorization)
- Statistics calculated for UI display (high/medium/low counts)
- engine.terminate() called after categorization to prevent memory leaks
- Filter by isProtected=false to exclude "Uncategorized" from targets
- Follow existing server action patterns (try/catch, success/error returns)

**Avoid:**
- Don't try to stream progress from server actions (Next.js limitation)
- Don't forget to terminate engine after use (memory leak)
- Don't include protected categories as categorization targets
  </action>
  <verify>
Run: npm run type-check (no TypeScript errors)
Check: File exists at src/types/ml.ts with MLCategorizationResult export
Check: File exists at src/app/actions/ml-categorization.ts with runMLCategorization export
Check: Server action marked with 'use server' directive
Check: MLCategorizationEngine import and terminate() call present
Check: Database delete uses inArray() for all videoIds (not just first one)
Check: Database insert uses mlCategorizations table from schema
  </verify>
  <done>
ML types defined with MLCategorizationResult and RunMLCategorizationResult interfaces, server action runMLCategorization implemented with categorization engine orchestration, database persistence with delete+insert pattern for re-runs using inArray() to delete ALL videos (BLOCKER 1 FIXED), statistics calculation (high/medium/low counts), getMLCategorizationForVideo and getMLCategorizationResults query functions, proper error handling and engine cleanup.
  </done>
</task>

<task type="auto">
  <name>Task 2: React Components for UI Integration</name>
  <files>src/components/ml/categorization-trigger.tsx, src/components/ml/progress-display.tsx</files>
  <action>
Create React components for triggering ML categorization and displaying real-time progress, following Phase 4 component patterns.

**File: src/components/ml/categorization-trigger.tsx**

```typescript
'use client';

import { useState } from 'react';
import { runMLCategorization } from '@/app/actions/ml-categorization';
import type { RunMLCategorizationResult } from '@/types/ml';

interface CategorizationTriggerProps {
  onProgressUpdate?: (current: number, total: number, percentage: number, status: string) => void;
  onComplete?: (result: RunMLCategorizationResult) => void;
}

export function CategorizationTrigger({ onProgressUpdate, onComplete }: CategorizationTriggerProps) {
  const [isRunning, setIsRunning] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleRunCategorization = async () => {
    setIsRunning(true);
    setError(null);

    try {
      // Note: Server actions don't support progress streaming
      // Progress will be simulated/estimated client-side or moved to client-side engine in future
      onProgressUpdate?.(0, 100, 0, 'Starting categorization...');

      const result = await runMLCategorization();

      if (!result.success) {
        setError(result.error || 'Categorization failed');
      } else {
        onProgressUpdate?.(100, 100, 100, 'Complete');
      }

      onComplete?.(result);
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Unknown error';
      setError(errorMessage);
    } finally {
      setIsRunning(false);
    }
  };

  return (
    <div className="flex flex-col gap-2">
      <button
        onClick={handleRunCategorization}
        disabled={isRunning}
        className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
      >
        {isRunning ? 'Categorizing...' : 'Run ML Categorization'}
      </button>

      {error && (
        <div className="text-sm text-red-600 bg-red-50 px-3 py-2 rounded-md">
          Error: {error}
        </div>
      )}
    </div>
  );
}
```

**File: src/components/ml/progress-display.tsx**

```typescript
'use client';

interface ProgressDisplayProps {
  current: number;
  total: number;
  percentage: number;
  status: string;
}

export function ProgressDisplay({ current, total, percentage, status }: ProgressDisplayProps) {
  return (
    <div className="flex flex-col gap-2">
      <div className="flex items-center justify-between text-sm text-gray-700">
        <span className="font-medium">{status}</span>
        <span className="text-gray-500">
          {current} / {total} ({percentage}%)
        </span>
      </div>

      {/* Progress bar */}
      <div className="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
        <div
          className="h-full bg-blue-600 transition-all duration-300 ease-out"
          style={{ width: `${percentage}%` }}
        />
      </div>
    </div>
  );
}
```

**Integration example (for Plan 04):**

```typescript
// Example usage in a page component
const [progress, setProgress] = useState({ current: 0, total: 0, percentage: 0, status: '' });
const [result, setResult] = useState<RunMLCategorizationResult | null>(null);

<CategorizationTrigger
  onProgressUpdate={(current, total, percentage, status) => {
    setProgress({ current, total, percentage, status });
  }}
  onComplete={(result) => {
    setResult(result);
  }}
/>

{progress.total > 0 && (
  <ProgressDisplay
    current={progress.current}
    total={progress.total}
    percentage={progress.percentage}
    status={progress.status}
  />
)}

{result && result.success && (
  <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded-md">
    <h3 className="font-semibold text-green-900">Categorization Complete</h3>
    <ul className="mt-2 text-sm text-green-800">
      <li>Total: {result.categorizedCount} videos</li>
      <li>High confidence: {result.highConfidenceCount}</li>
      <li>Medium confidence: {result.mediumConfidenceCount}</li>
      <li>Low confidence: {result.lowConfidenceCount}</li>
    </ul>
  </div>
)}
```

**Key details:**
- Use 'use client' directive (interactive components)
- Disabled state during categorization prevents double-triggering
- Error display follows existing error banner patterns
- Progress bar uses Tailwind width percentage (smooth transitions)
- Callbacks allow parent component to manage state
- Follow Phase 4 component patterns (client-side state management)

**Limitation acknowledged:**
Server actions can't stream progress in real-time. For Phase 5, progress will show start/complete only. Future enhancement could move categorization engine client-side for true progress tracking.

**Avoid:**
- Don't use Server Components for interactive buttons (needs 'use client')
- Don't forget disabled state during operation (prevents race conditions)
- Don't hard-code styles that conflict with existing Tailwind theme
  </action>
  <verify>
Run: npm run type-check (no TypeScript errors)
Check: File exists at src/components/ml/categorization-trigger.tsx with 'use client' directive
Check: File exists at src/components/ml/progress-display.tsx
Check: CategorizationTrigger imports runMLCategorization from actions
Check: Components use Tailwind classes matching existing patterns
Check: onProgressUpdate and onComplete callbacks properly typed
  </verify>
  <done>
CategorizationTrigger component implemented with button, loading state, error display, and progress callbacks, ProgressDisplay component implemented with status text and animated progress bar, proper TypeScript props interfaces, 'use client' directives for interactivity, Tailwind styling matching existing components, integration example documented for Plan 04.
  </done>
</task>

</tasks>

<verification>
**End-to-end action flow:**

1. **Server Action Callable:**
   - runMLCategorization can be imported in client components
   - Returns RunMLCategorizationResult with success/error/counts
   - Database persistence works (mlCategorizations records created)

2. **Component Integration:**
   - CategorizationTrigger renders button
   - Clicking button calls runMLCategorization
   - Progress callbacks invoked on start/complete
   - Error state displays when categorization fails

3. **Type Safety:**
   - All types exported from ml.ts
   - Server action return types match component expectations
   - No TypeScript errors in type-check

4. **Database Operations:**
   - Schema pushed with `drizzle-kit push` (ready for Plan 04)
   - mlCategorizations table created with indexes
   - Insert operations work with confidence enum
</verification>

<success_criteria>
**Measurable completion:**
- [ ] ml.ts types file created with 3 exported interfaces
- [ ] ml-categorization.ts server actions with 3 exported functions
- [ ] runMLCategorization fetches videos, categories, runs engine, persists results
- [ ] Statistics calculated (high/medium/low counts)
- [ ] CategorizationTrigger component with button and error display
- [ ] ProgressDisplay component with status and progress bar
- [ ] All components use 'use client' directive
- [ ] Type-check passes with no errors
- [ ] All must_haves key_links present (imports verified)
</success_criteria>

<output>
After completion, create `.planning/phases/05-ml-categorization-engine/05-03-SUMMARY.md`
</output>
