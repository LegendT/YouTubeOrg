---
phase: 08-batch-sync-operations
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - src/app/actions/sync.ts
  - src/app/sync/page.tsx
  - src/components/sync/sync-preview.tsx
autonomous: true

must_haves:
  truths:
    - "Server actions provide complete sync lifecycle: preview, start, resume, pause, progress polling, batch processing"
    - "User sees sync preview page at /sync showing playlists to create, videos to add, playlists to delete with quota costs"
    - "Preview shows estimated total days (calculated from totalQuotaCost / 10000)"
    - "User can click 'Start Sync' button to initiate the sync operation"
    - "Preview groups changes by operation type (Create Playlists, Add Videos, Delete Playlists)"
  artifacts:
    - path: "src/app/actions/sync.ts"
      provides: "Server actions for sync control"
      exports: ["getSyncPreview", "startSync", "resumeSync", "pauseSync", "getSyncProgress", "processSyncBatch"]
    - path: "src/app/sync/page.tsx"
      provides: "Sync page with preview and status display"
      min_lines: 30
    - path: "src/components/sync/sync-preview.tsx"
      provides: "Preview component showing changes grouped by operation type"
      min_lines: 50
  key_links:
    - from: "src/app/actions/sync.ts"
      to: "src/lib/sync/engine.ts"
      via: "Engine function imports"
      pattern: "import.*createSyncJob.*engine"
    - from: "src/app/actions/sync.ts"
      to: "src/lib/sync/preview.ts"
      via: "computeSyncPreview import"
      pattern: "import.*computeSyncPreview.*preview"
    - from: "src/app/sync/page.tsx"
      to: "src/app/actions/sync.ts"
      via: "Server action calls"
      pattern: "import.*getSyncPreview.*actions/sync"
    - from: "src/components/sync/sync-preview.tsx"
      to: "src/types/sync.ts"
      via: "SyncPreview type"
      pattern: "import.*SyncPreview.*types/sync"
---

<objective>
Create server actions for sync control and the sync preview page where users see what will happen before starting the sync.

Purpose: The server actions bridge the sync engine to the UI. The preview page is the critical decision point where users see the full scope of changes (playlists to create, videos to add, playlists to delete) with honest quota estimates (~21-23 days) before committing.

Output: Server actions file, /sync page, and SyncPreview component.
</objective>

<execution_context>
@/Users/anthonygeorge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anthonygeorge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-batch-sync-operations/08-RESEARCH.md
@.planning/phases/08-batch-sync-operations/08-CONTEXT.md
@.planning/phases/08-batch-sync-operations/08-01-SUMMARY.md
@.planning/phases/08-batch-sync-operations/08-02-SUMMARY.md
@src/lib/sync/engine.ts
@src/lib/sync/preview.ts
@src/lib/sync/stages.ts
@src/types/sync.ts
@src/app/actions/sync.ts
@src/components/navigation.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync server actions</name>
  <files>src/app/actions/sync.ts</files>
  <action>
**Create `src/app/actions/sync.ts`** with `'use server'` directive.

Import from engine (`createSyncJob`, `processSyncBatch`, `pauseSyncJob`, `resumeSyncJob`, `getCurrentSyncJob`), preview (`computeSyncPreview`), auth (`auth` from `@/lib/auth/config`), and types.

All actions must check authentication via `auth()` and verify `session?.access_token` exists. Return structured responses (not throw).

Export the following server actions:

1. `getSyncPreview(): Promise<{ success: boolean; preview?: SyncPreview; error?: string }>`
   - Authenticate
   - Call `computeSyncPreview()`
   - Return `{ success: true, preview }`

2. `startSync(): Promise<{ success: boolean; job?: SyncJobRecord; error?: string }>`
   - Authenticate
   - Check no active sync job exists (getCurrentSyncJob returns null or completed/failed)
   - If active job exists, return `{ success: false, error: 'A sync operation is already in progress' }`
   - Compute preview via `computeSyncPreview()`
   - Create job via `createSyncJob(preview)`
   - Return `{ success: true, job }`

3. `resumeSync(): Promise<{ success: boolean; job?: SyncJobRecord; error?: string }>`
   - Authenticate
   - Get current job. If not paused, return error.
   - Call `resumeSyncJob(job.id)`
   - Return updated job

4. `pauseSync(): Promise<{ success: boolean; job?: SyncJobRecord; error?: string }>`
   - Authenticate
   - Get current job. If not in an active stage (backup, create_playlists, add_videos, delete_playlists), return error.
   - Call `pauseSyncJob(job.id, 'user_paused')`
   - Return updated job

5. `getSyncProgress(): Promise<{ success: boolean; job?: SyncJobRecord; error?: string }>`
   - Authenticate
   - Call `getCurrentSyncJob()`
   - If no job, return `{ success: true, job: null }` -- preview state
   - Return `{ success: true, job }`

6. `runSyncBatch(): Promise<{ success: boolean; job?: SyncJobRecord; error?: string }>`
   - Authenticate
   - Get current job. If null, completed, paused, or failed, return `{ success: false, error: 'No active sync job' }`
   - Call `processSyncBatch(session.access_token, 10)` (batch size 10)
   - Return updated job
   - **IMPORTANT:** This is the "fire-and-process" action. Client calls this repeatedly via polling. Each call processes up to 10 API operations (500 quota units max) and returns quickly. The client then calls `getSyncProgress()` to display the updated state, and calls `runSyncBatch()` again if the job is still active.

Import `revalidatePath` from `next/cache` and call `revalidatePath('/sync')` after any state-changing action (start, resume, pause, batch).

**Authentication pattern** (match existing server actions in the project):
```typescript
const session = await auth();
if (!session?.access_token) {
  return { success: false, error: 'Not authenticated' };
}
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `grep -r "use server" src/app/actions/sync.ts` shows directive
3. All 6 server actions are exported
4. Each action checks authentication before proceeding
  </verify>
  <done>6 server actions provide complete sync lifecycle control: preview, start, resume, pause, progress, and batch processing. All check authentication. State-changing actions revalidate /sync path.</done>
</task>

<task type="auto">
  <name>Task 2: Sync page and preview component</name>
  <files>src/app/sync/page.tsx, src/components/sync/sync-preview.tsx</files>
  <action>
**Create `src/components/sync/sync-preview.tsx`** as a client component (`'use client'`):

Props: `{ preview: SyncPreview; onStartSync: () => void; isStarting: boolean }`

Layout (grouped by operation type per RESEARCH.md recommendation):

1. **Header:** "Sync Preview" with subtitle "Review the changes that will be synced to YouTube"

2. **Quota Summary Card** (top, full width):
   - Total API units: `preview.totalQuotaCost` formatted with commas (e.g., "225,600 units")
   - Estimated duration: `preview.estimatedDays` days
   - Daily limit: "10,000 units/day"
   - Use amber/warning styling if estimatedDays > 7, to set expectations

3. **Stage Cards** (3 cards in a column layout):

   **Card 1: Create Playlists**
   - Icon: `FolderPlus` from lucide-react
   - Count: `preview.stages.createPlaylists.count` playlists
   - Quota: `preview.stages.createPlaylists.quotaCost` units
   - Expandable list of playlist names (show first 5, "and N more" if > 5)

   **Card 2: Add Videos to Playlists**
   - Icon: `ListVideo` from lucide-react
   - Count: `preview.stages.addVideos.count` video assignments
   - Quota: `preview.stages.addVideos.quotaCost` units
   - Per-category breakdown: show each category name with video count (e.g., "JavaScript: 245 videos")
   - This is the largest stage -- note it prominently

   **Card 3: Delete Old Playlists**
   - Icon: `Trash2` from lucide-react
   - Count: `preview.stages.deletePlaylists.count` playlists
   - Quota: `preview.stages.deletePlaylists.quotaCost` units
   - Expandable list of playlist names

4. **Watch Later Notice** (info card):
   - Blue info styling
   - Text: "Watch Later videos cannot be removed via the YouTube API (deprecated since 2020). After sync completes, you can manually remove categorised videos from Watch Later through the YouTube interface."

5. **Action Section** (bottom):
   - "Start Sync" button (primary blue, large)
   - Disabled while `isStarting` is true, shows spinner
   - Text beneath: "This will create playlists, add videos, and delete old playlists on your YouTube account. New playlists will be created as Private."

Use Tailwind styling consistent with existing components (cards with shadow-sm, rounded-lg borders, p-6 padding).

**Create `src/app/sync/page.tsx`** as a Server Component:

1. Authenticate via `auth()`. If no session, redirect to sign-in.
2. Fetch initial data:
   - Call `getSyncPreview()` server action for preview data
   - Call `getSyncProgress()` server action for current job state
3. Render based on state:
   - If no active job (job is null or completed/failed): show `<SyncPreview>` component with preview data
   - If active job exists (running or paused): show placeholder for progress component (will be built in Plan 08-04). For now, show a simple card: "Sync in progress: {job.stage} - {job.currentStageProgress}/{job.currentStageTotal}"
   - If job is completed: show placeholder for report component (will be built in Plan 08-04). For now, show "Sync completed" message.

Use a client wrapper component (e.g., `SyncPageClient`) that receives initial data as props and manages local state for:
- Calling `startSync()` on button click (via useTransition for loading state)
- Transitioning from preview to progress view after sync starts

**Key UX decisions:**
- British English: "Categorised", "Organise", "Synchronise" in all user-facing text
- The preview must be brutally honest about the ~21-23 day timeline (RESEARCH.md finding)
- No category-level checkboxes (all-or-nothing per CONTEXT.md)
- Standard "Start Sync" button (no type-to-confirm per CONTEXT.md)
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Navigate to `http://localhost:3000/sync` and see the preview page
3. Preview shows 3 stage cards with operation counts and quota costs
4. "Start Sync" button is visible and clickable
5. Estimated days shown matches totalQuotaCost / 10000
  </verify>
  <done>User can visit /sync to see a full preview of sync operations grouped by type, with quota estimates and estimated day count. "Start Sync" button initiates the operation.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. /sync page loads and displays preview data from real database
3. Server actions handle authentication and return structured responses
4. Preview component shows all three stages with accurate counts
5. "Start Sync" button calls startSync action and transitions to progress view
</verification>

<success_criteria>
- Server actions provide the full sync control API (preview, start, resume, pause, progress, batch)
- /sync page shows preview with honest quota/day estimates before user commits
- Preview groups by operation type: Create Playlists, Add Videos, Delete Old Playlists
- Watch Later deprecation notice informs user about manual cleanup
- All text uses British English ("Categorised", "Synchronise")
</success_criteria>

<output>
After completion, create `.planning/phases/08-batch-sync-operations/08-03-SUMMARY.md`
</output>
