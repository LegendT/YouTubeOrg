---
phase: 08-batch-sync-operations
plan: 04
type: execute
wave: 4
depends_on: ["08-03"]
files_modified:
  - src/components/sync/sync-progress.tsx
  - src/components/sync/sync-report.tsx
  - src/app/sync/page.tsx
  - src/components/navigation.tsx
autonomous: false

must_haves:
  truths:
    - "User sees real-time stage progress during sync ('Creating playlists 3/25', 'Adding videos 47/500')"
    - "Progress display polls server every 3 seconds and updates automatically"
    - "User can pause an in-progress sync with a 'Pause' button"
    - "User can resume a paused sync with a 'Resume Sync' button"
    - "Paused state shows reason ('Quota exhausted -- resets in Xh', 'Paused by user')"
    - "Completion report shows per-stage success/failure/skipped counts"
    - "Completion report shows collected errors with stage and entity details"
    - "Navigation bar includes 'Sync' link with RefreshCw icon"
    - "/sync page correctly displays preview, progress, or report based on sync job state"
  artifacts:
    - path: "src/components/sync/sync-progress.tsx"
      provides: "Real-time sync progress display with polling and pause/resume controls"
      min_lines: 80
    - path: "src/components/sync/sync-report.tsx"
      provides: "Detailed completion report with per-stage results and error list"
      min_lines: 60
    - path: "src/app/sync/page.tsx"
      provides: "Full sync page orchestrating preview, progress, and report views"
      min_lines: 80
    - path: "src/components/navigation.tsx"
      provides: "Navigation with Sync link"
      contains: "Sync"
  key_links:
    - from: "src/components/sync/sync-progress.tsx"
      to: "src/app/actions/sync.ts"
      via: "Polling getSyncProgress and calling runSyncBatch"
      pattern: "import.*(getSyncProgress|runSyncBatch).*actions/sync"
    - from: "src/components/sync/sync-report.tsx"
      to: "src/types/sync.ts"
      via: "SyncJobRecord and StageResults types"
      pattern: "import.*SyncJobRecord.*types/sync"
    - from: "src/app/sync/page.tsx"
      to: "src/components/sync"
      via: "Imports SyncPreview, SyncProgress, SyncReport"
      pattern: "import.*Sync(Preview|Progress|Report)"
---

<objective>
Build the sync progress display, completion report, and wire everything together into the /sync page with navigation.

Purpose: This is the user-facing culmination of Phase 8. Users need to see real-time progress during multi-day sync ("Adding videos 1,234/4,200"), control the process (pause/resume), and review detailed results after completion. The navigation link makes the sync feature discoverable.

Output: Progress and report components, fully wired /sync page, and navigation update.
</objective>

<execution_context>
@/Users/anthonygeorge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anthonygeorge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-batch-sync-operations/08-RESEARCH.md
@.planning/phases/08-batch-sync-operations/08-CONTEXT.md
@.planning/phases/08-batch-sync-operations/08-01-SUMMARY.md
@.planning/phases/08-batch-sync-operations/08-02-SUMMARY.md
@.planning/phases/08-batch-sync-operations/08-03-SUMMARY.md
@src/app/sync/page.tsx
@src/app/actions/sync.ts
@src/components/sync/sync-preview.tsx
@src/components/navigation.tsx
@src/types/sync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync progress and completion report components</name>
  <files>src/components/sync/sync-progress.tsx, src/components/sync/sync-report.tsx</files>
  <action>
**Create `src/components/sync/sync-progress.tsx`** as a client component:

Props: `{ job: SyncJobRecord; onPause: () => void; onResume: () => void }`

This component manages polling and the progress-then-trigger loop:

1. **Polling mechanism** (useEffect):
   - When job stage is active (backup, create_playlists, add_videos, delete_playlists):
     - Set up a 3-second interval
     - Each tick: call `runSyncBatch()` server action (processes up to 10 operations), then call `getSyncProgress()` to get updated job state
     - Update local job state with the response
     - If job transitions to paused, failed, or completed: clear interval
   - Clean up interval on unmount

2. **Layout:**
   - **Current Stage Card** (prominent, centre):
     - Stage label from `STAGE_LABELS[job.stage]` (e.g., "Creating playlists", "Adding videos")
     - Progress: `job.currentStageProgress` / `job.currentStageTotal` with percentage
     - Progress bar (Tailwind: `bg-blue-600` fill, `bg-gray-200` track, rounded, h-3)
     - If stage is backup: show "Creating pre-sync backup..." with spinner (no count)

   - **Stage Pipeline** (below, horizontal steps or vertical list):
     - Show all 4 stages: Backup, Create Playlists, Add Videos, Delete Playlists
     - Completed stages: green checkmark, show results (e.g., "25/25 created")
     - Current stage: blue, animated (pulse or spinner)
     - Future stages: grey, dimmed
     - Use `job.stageResults` to populate completed stage counts

   - **Stats Row:**
     - Total quota used this sync: `job.quotaUsedThisSync` units
     - Quota remaining today: can call `getRemainingQuota` via a lightweight server action or display from last known value

   - **Pause Button:**
     - "Pause Sync" button (amber/warning colour), calls `onPause`
     - Only shown when job is in an active stage

3. **Paused State** (when `job.stage === 'paused'`):
   - Show pause reason:
     - `quota_exhausted`: "Sync paused -- daily quota exhausted. The quota resets at midnight Pacific Time. Come back tomorrow to resume."
     - `user_paused`: "Sync paused by you."
     - `errors_collected`: "Sync paused -- errors encountered during {stage}. Review errors below."
   - "Resume Sync" button (primary blue), calls `onResume`
   - If errors exist (`job.errors.length > 0`), show error summary: count by stage, expandable list

4. **Failed State** (when `job.stage === 'failed'`):
   - Show error summary
   - "Start New Sync" option (user would need to go back to preview)

**Create `src/components/sync/sync-report.tsx`** as a client component:

Props: `{ job: SyncJobRecord }`

This is the persistent completion report (CONTEXT.md: "Detailed completion report -- persistent summary page showing every operation: successes, failures, skipped items").

Layout:

1. **Header:** "Sync Complete" with green checkmark icon, or "Sync Finished with Errors" with amber warning icon (if any failures)
   - Started: `job.startedAt` formatted
   - Completed: `job.completedAt` formatted
   - Duration: human-readable difference (e.g., "23 days, 4 hours")

2. **Summary Stats Row:**
   - Total quota used: `job.quotaUsedThisSync`
   - Total operations: sum of all succeeded + failed + skipped across stages

3. **Per-Stage Results Cards** (3 cards):
   - For each stage (create_playlists, add_videos, delete_playlists):
     - Stage name
     - Succeeded count (green)
     - Failed count (red, 0 if none)
     - Skipped count (grey, 0 if none)

4. **Errors Section** (expandable, only if `job.errors.length > 0`):
   - Table with columns: Stage, Entity Type, Entity ID, Error Message, Timestamp
   - Sorted by timestamp
   - Show all errors (no pagination needed for error list)

5. **Watch Later Notice** (same as preview -- reminder about manual cleanup):
   - "Your videos have been added to new playlists. To clean up your Watch Later, manually remove categorised videos through the YouTube interface."

6. **Action:**
   - "Start New Sync" button to return to preview view (for any remaining operations or re-runs)
   - Link to Safety dashboard to review backup created before this sync

Use British English throughout: "Categorised", "Synchronise", "Summarise".
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Both components compile and export correctly
3. SyncProgress uses setInterval for 3-second polling
4. SyncReport displays per-stage results from stageResults
  </verify>
  <done>SyncProgress shows real-time stage progress with polling, pause/resume controls, and quota tracking. SyncReport displays detailed completion results with per-stage success/failure/skipped counts and error list.</done>
</task>

<task type="auto">
  <name>Task 2: Wire sync page and add navigation link</name>
  <files>src/app/sync/page.tsx, src/components/navigation.tsx</files>
  <action>
**Update `src/app/sync/page.tsx`** to be the complete sync orchestrator:

The page should be a Server Component that fetches initial data and passes to a client orchestrator.

1. **Server Component (page.tsx):**
   - Authenticate, redirect if not authenticated
   - Fetch: `getSyncPreview()` and `getSyncProgress()`
   - Render `<SyncPageClient initialPreview={preview} initialJob={job} />`

2. **Client Orchestrator (`SyncPageClient` in same file or separate):**
   - `'use client'` component
   - Props: `{ initialPreview: SyncPreview | null; initialJob: SyncJobRecord | null }`
   - State: `currentJob` (from initialJob), `preview` (from initialPreview)
   - Determine view based on job state:
     - **No job / completed / failed with no errors**: Show `<SyncPreview>` with onStartSync handler
     - **Active job (pending/backup/create_playlists/add_videos/delete_playlists)**: Show `<SyncProgress>` with onPause handler
     - **Paused job**: Show `<SyncProgress>` (it handles paused state display) with onResume handler
     - **Completed job**: Show `<SyncReport>` with the completed job
     - **Failed job with errors**: Show `<SyncReport>` (it handles error display)
   - Logic note: After a completed sync, the user sees the report. They can choose "Start New Sync" which resets the view to preview.

   - **onStartSync handler:**
     - Call `startSync()` server action
     - If success, set `currentJob` to the returned job
     - The view automatically switches to progress

   - **onPause handler:**
     - Call `pauseSync()` server action
     - Update `currentJob`

   - **onResume handler:**
     - Call `resumeSync()` server action
     - Update `currentJob`

   - **Job state polling in SyncProgress:**
     - SyncProgress manages its own polling loop (calls runSyncBatch + getSyncProgress)
     - When job state changes (paused, completed, failed), SyncProgress calls back to parent via `onJobUpdate: (job: SyncJobRecord) => void` prop
     - Parent updates `currentJob` state, which switches the view

   - **"Start New Sync" from report:**
     - Reset `currentJob` to null, view switches back to preview
     - Re-fetch preview data via `getSyncPreview()`

3. **Page layout:**
   - Container with max-w-4xl, centred, py-8 padding
   - Page title: "Sync to YouTube" (h1)
   - Subtitle: "Synchronise your approved category structure with YouTube"

**Update `src/components/navigation.tsx`:**
- Import `RefreshCw` from `lucide-react`
- Add to navigation array: `{ name: 'Sync', href: '/sync', icon: RefreshCw }`
- Place it after 'Safety' in the navigation order (last item before sign out)
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Navigate to `http://localhost:3000/sync` -- page loads with preview or progress based on job state
3. Navigation bar shows "Sync" link with RefreshCw icon
4. Clicking "Start Sync" transitions from preview to progress view
5. Progress view shows stage progress and polling is active
6. Dev server test: `npm run dev` and navigate to /sync
  </verify>
  <done>/sync page orchestrates the full sync workflow: preview -> start -> progress (with polling) -> pause/resume -> completion report. Navigation bar includes Sync link.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete sync-to-YouTube workflow with preview, multi-day progress tracking, pause/resume, and completion report</what-built>
  <how-to-verify>
1. Visit http://localhost:3000/sync
2. Verify the sync preview shows:
   - Number of playlists to create (should match your category count minus protected "Uncategorised")
   - Number of video assignments (total videos to add across all categories)
   - Number of old playlists to delete (should be 87)
   - Total quota cost and estimated days (~21-23 days)
   - Watch Later deprecation notice
3. Verify the "Start Sync" button is visible
4. Verify navigation bar has "Sync" link with icon
5. **IMPORTANT:** You must re-authenticate (sign out, sign in) for the new youtube.force-ssl scope to take effect. The sync will fail with 403 if you haven't re-authenticated.
6. Do NOT click "Start Sync" unless you want to actually begin syncing to YouTube (this will create real playlists on your account).
7. Verify the page uses British English ("Synchronise", "Categorised")
  </how-to-verify>
  <resume-signal>Type "approved" if the preview looks correct, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. /sync page loads and shows appropriate view based on sync job state
3. Navigation includes "Sync" link
4. Preview shows accurate operation counts with quota estimates
5. Progress component polls every 3 seconds (verify in browser dev tools Network tab)
6. Pause/resume buttons work and update the UI
7. Completion report shows per-stage results
8. All text uses British English
</verification>

<success_criteria>
- User can navigate to /sync from the navigation bar
- Sync preview page shows all planned operations with honest quota/day estimates
- User can start sync and see real-time stage progress with polling
- User can pause and resume sync at any time
- Paused state clearly explains why (quota exhaustion, user choice, errors)
- Completion report provides detailed per-stage success/failure/skipped breakdown
- Error list shows all collected errors with context
- All user-facing text uses British English
- Full sync lifecycle works: preview -> start -> progress -> pause/resume -> complete/report
</success_criteria>

<output>
After completion, create `.planning/phases/08-batch-sync-operations/08-04-SUMMARY.md`
</output>
