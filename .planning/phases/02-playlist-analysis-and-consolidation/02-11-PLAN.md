---
phase: 02-playlist-analysis-and-consolidation
plan: 11
type: execute
wave: 6
depends_on: [02-07]
files_modified:
  - src/components/analysis/progress-tracker.tsx
  - src/components/analysis/keyboard-nav.tsx
  - src/components/analysis/algorithm-mode-toggle.tsx
  - src/components/analysis/analysis-loading.tsx
  - src/components/analysis/staleness-banner.tsx
autonomous: true

must_haves:
  truths:
    - "User sees progress counter 'Reviewed: 12/25 categories' with status badges and progress bar"
    - "User can navigate categories with arrow keys and select with Enter"
    - "User sees algorithm mode toggle (Conservative/Aggressive) to switch analysis modes"
    - "User sees staged loading states during analysis: 'Detecting duplicates... (1/3)'"
    - "System shows staleness detection prompt when playlist data is newer than last analysis"
  artifacts:
    - path: "src/components/analysis/progress-tracker.tsx"
      provides: "Review progress counter, status badges, and visual progress bar"
      exports: ["ProgressTracker"]
      min_lines: 50
    - path: "src/components/analysis/keyboard-nav.tsx"
      provides: "Keyboard navigation hook for category list"
      exports: ["useCategoryKeyboardNav"]
      min_lines: 40
    - path: "src/components/analysis/algorithm-mode-toggle.tsx"
      provides: "Conservative/Aggressive mode selector"
      exports: ["AlgorithmModeToggle"]
      min_lines: 30
    - path: "src/components/analysis/analysis-loading.tsx"
      provides: "Staged loading state display"
      exports: ["AnalysisLoading"]
      min_lines: 40
    - path: "src/components/analysis/staleness-banner.tsx"
      provides: "Warning banner for stale analysis data"
      exports: ["StalenessBanner"]
      min_lines: 25
  key_links:
    - from: "src/components/analysis/keyboard-nav.tsx"
      to: "react-hotkeys-hook"
      via: "useHotkeys for arrow key navigation"
      pattern: "useHotkeys"
    - from: "src/components/analysis/staleness-banner.tsx"
      to: "src/app/actions/analysis.ts"
      via: "checkStaleness data"
      pattern: "StalenessCheck"
    - from: "src/components/analysis/algorithm-mode-toggle.tsx"
      to: "src/app/actions/analysis.ts"
      via: "runAnalysis with mode parameter"
      pattern: "runAnalysis"
---

<objective>
Build supporting UI components for progress tracking, keyboard navigation, algorithm mode selection, staged loading states, and staleness detection.

Purpose: CONTEXT.md specifies "Counter: Reviewed 12/25 categories", "Status badges: Approved, Rejected, Pending", "Progress bar: Visual completion percentage", "Full keyboard navigation (arrow keys, Enter)", "Preset algorithm modes: Conservative vs Aggressive", "Loading state with stages", and "Multi-session staleness detection". These are cross-cutting concerns that enhance the overall analysis experience.

Output: Five standalone components ready to be integrated into the analysis dashboard and page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-CONTEXT.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-RESEARCH.md
@src/types/analysis.ts
@src/app/actions/analysis.ts
@src/components/ui/progress.tsx
@src/components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create progress tracker, algorithm toggle, and staleness banner</name>
  <files>src/components/analysis/progress-tracker.tsx, src/components/analysis/algorithm-mode-toggle.tsx, src/components/analysis/staleness-banner.tsx</files>
  <action>
1. **Create src/components/analysis/progress-tracker.tsx:**

Client Component showing review progress.

Props:
```typescript
interface ProgressTrackerProps {
  proposals: ConsolidationProposal[]
}
```

Implementation:
- Count reviewed = proposals.filter(p => p.status !== 'pending').length
- Count total = proposals.length
- Count approved = proposals.filter(p => p.status === 'approved').length
- Count rejected = proposals.filter(p => p.status === 'rejected').length
- Count pending = proposals.filter(p => p.status === 'pending').length

Display:
- Counter text: "Reviewed: {reviewed}/{total} categories"
- Progress bar (shadcn/ui Progress): value = (reviewed / total) * 100
- Status badge row:
  - Badge with Check icon and green styling: "{approved} Approved"
  - Badge with X icon and red styling: "{rejected} Rejected"
  - Badge with Circle icon and outline styling: "{pending} Pending"

Place this component above the split-panel in the analysis dashboard.

2. **Create src/components/analysis/algorithm-mode-toggle.tsx:**

Client Component for switching between Conservative and Aggressive modes.

Props:
```typescript
interface AlgorithmModeToggleProps {
  currentMode: AlgorithmMode
  onModeChange: (mode: AlgorithmMode) => void
  disabled?: boolean
}
```

Implementation:
- Two buttons styled as a button group (segmented control):
  - "Conservative" button: highlighted when active
  - "Aggressive" button: highlighted when active (default)
- Use Button variant="default" for active, variant="outline" for inactive
- Tooltip/description below:
  - Conservative: "Fewer merges, higher confidence threshold (~35 categories)"
  - Aggressive: "More merges, lower threshold (~25 categories)"
- When user switches mode, calls onModeChange
- Parent is responsible for triggering re-analysis with new mode

Place next to the "Run Analysis" / "Re-analyze" button on the analysis page.

3. **Create src/components/analysis/staleness-banner.tsx:**

Client Component showing warning when analysis data is stale.

Props:
```typescript
interface StalenessBannerProps {
  staleness: StalenessCheck
  onReAnalyze: () => void
}
```

Implementation:
- Only renders when staleness.isStale === true
- Yellow/amber warning banner:
  - Icon: AlertTriangle from lucide-react
  - Message: staleness.message (e.g., "Playlist data has changed since last analysis. Re-analyze?")
  - Sub-text: "Last analyzed: {date}, Last sync: {date}"
  - "Re-analyze" button that calls onReAnalyze
- Uses Card with warning styling (border-yellow-500 bg-yellow-50 or similar Tailwind classes)
- Dismissible: X button to close (stores dismissed in local state, reappears on page reload)

Place at top of analysis page, before the summary card.
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check files:
```bash
ls src/components/analysis/ | grep -E "(progress-tracker|algorithm-mode-toggle|staleness-banner)"
```

Check exports:
```bash
grep "export function" src/components/analysis/progress-tracker.tsx src/components/analysis/algorithm-mode-toggle.tsx src/components/analysis/staleness-banner.tsx
```
Expected: ProgressTracker, AlgorithmModeToggle, StalenessBanner exported.
  </verify>
  <done>
ProgressTracker shows "Reviewed: X/Y" with progress bar and status badge counts. AlgorithmModeToggle provides Conservative/Aggressive segmented control with descriptions. StalenessBanner shows dismissible amber warning when data is stale. All use shadcn/ui components. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create keyboard navigation hook and analysis loading component</name>
  <files>src/components/analysis/keyboard-nav.tsx, src/components/analysis/analysis-loading.tsx</files>
  <action>
1. **Create src/components/analysis/keyboard-nav.tsx:**

Custom hook using react-hotkeys-hook for category list keyboard navigation.

```typescript
'use client'

import { useHotkeys } from 'react-hotkeys-hook'
import { useState, useCallback } from 'react'

interface UseCategoryKeyboardNavOptions {
  categories: Array<{ id: number }>
  onSelect: (id: number) => void
  enabled?: boolean
}

export function useCategoryKeyboardNav({ categories, onSelect, enabled = true }: UseCategoryKeyboardNavOptions) {
  const [focusedIndex, setFocusedIndex] = useState(0)

  // Up arrow / k: Move focus up
  useHotkeys('up, k', (e) => {
    e.preventDefault()
    setFocusedIndex(prev => Math.max(0, prev - 1))
  }, { enabled })

  // Down arrow / j: Move focus down
  useHotkeys('down, j', (e) => {
    e.preventDefault()
    setFocusedIndex(prev => Math.min(categories.length - 1, prev + 1))
  }, { enabled })

  // Enter: Select focused category
  useHotkeys('enter', (e) => {
    e.preventDefault()
    if (categories[focusedIndex]) {
      onSelect(categories[focusedIndex].id)
    }
  }, { enabled })

  // a: Approve focused category (to be wired by parent)
  // r: Reject focused category (to be wired by parent)

  return {
    focusedIndex,
    setFocusedIndex,
    focusedId: categories[focusedIndex]?.id ?? null,
  }
}
```

The hook returns focusedIndex for visual highlighting in the category list. CategoryList (from Plan 02-07) will need to accept focusedIndex as a prop and apply a focus ring class (ring-2 ring-primary) to the focused item.

Also export keyboard shortcut hints for contextual display:
```typescript
export const KEYBOARD_HINTS = [
  { key: 'arrow up / k', action: 'Previous category' },
  { key: 'arrow down / j', action: 'Next category' },
  { key: 'Enter', action: 'Select category' },
]
```

2. **Create src/components/analysis/analysis-loading.tsx:**

Client Component showing staged loading progress during analysis generation.

Props:
```typescript
interface AnalysisLoadingProps {
  stage: 'idle' | 'duplicates' | 'clustering' | 'proposals' | 'complete' | 'error'
  error?: string
  onRetry?: () => void
}
```

Implementation:
- Shows a centered card with stage-specific content:

Stage display:
- idle: Nothing shown
- duplicates: "Detecting duplicates... (1/3)" with animated spinner/pulse
- clustering: "Clustering playlists... (2/3)" with animated spinner
- proposals: "Generating proposals... (3/3)" with animated spinner
- complete: "Analysis complete!" with check icon (brief, then dismissed)
- error: Error message with retry button

Visual:
- Card centered on page
- Each stage has a number indicator: (1/3), (2/3), (3/3)
- Simple progress bar showing 33%, 66%, 100%
- Stage text with icon (Search for duplicates, GitBranch for clustering, FileCheck for proposals)
- If error: red styling with AlertTriangle icon and onRetry button

NOTE: The actual staging requires the runAnalysis server action to report progress. Since server actions don't support streaming progress, there are two approaches:
a. SIMPLE: Show a single "Analyzing..." state with indeterminate progress (the staging is decorative, not real)
b. COMPLEX: Break runAnalysis into 3 separate server actions called sequentially from the client

Recommend approach (a) for now: Show the loading component with an animated progress bar that cycles through stages on a timer (e.g., 2 seconds per stage). The actual analysis runs as a single server action. This gives the appearance of staged progress without backend changes. If the user later wants real staging, Plan 02-06's runAnalysis can be split.

Add a wrapper component `AnalysisRunner` that:
- Renders AlgorithmModeToggle and "Run Analysis" button
- On click: sets loading state, starts stage timer, calls runAnalysis
- On complete: shows success, transitions to results
- On error: shows error with retry

```typescript
export function AnalysisRunner({ currentMode, onComplete }: {
  currentMode?: AlgorithmMode
  onComplete: () => void
}) { ... }
```
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check files:
```bash
ls src/components/analysis/ | grep -E "(keyboard-nav|analysis-loading)"
```

Check react-hotkeys-hook:
```bash
grep "useHotkeys" src/components/analysis/keyboard-nav.tsx
```

Check loading stages:
```bash
grep -E "(duplicates|clustering|proposals)" src/components/analysis/analysis-loading.tsx
```
  </verify>
  <done>
useCategoryKeyboardNav hook provides arrow key + j/k navigation with Enter to select. KEYBOARD_HINTS exported for contextual display. AnalysisLoading shows staged progress (1/3, 2/3, 3/3) with animated transitions. AnalysisRunner wraps mode toggle + run button with loading state management. Error state with retry button. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **TypeScript compilation clean:** `npx tsc --noEmit`
2. **Progress tracking:** Counter, progress bar, status badges
3. **Keyboard nav:** Arrow keys, j/k, Enter work via react-hotkeys-hook
4. **Algorithm toggle:** Conservative/Aggressive with descriptions
5. **Loading states:** Staged progress display with animations
6. **Staleness banner:** Warning with re-analyze button
7. **All components standalone:** Can be integrated in Plan 02-12

These cross-cutting components enhance the analysis experience. Plan 02-12 integrates everything.
</verification>

<success_criteria>
Plan complete when:
- ProgressTracker shows reviewed/total counter with progress bar
- useCategoryKeyboardNav handles up/down/enter keyboard events
- AlgorithmModeToggle switches between Conservative and Aggressive
- AnalysisLoading shows staged progress (Detecting duplicates -> Clustering -> Generating)
- AnalysisRunner wraps the run workflow with loading state
- StalenessBanner shows when data is stale with re-analyze option
- Error handling shows error message with retry button
- Empty analysis shows "No automatic merges found" fallback
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-playlist-analysis-and-consolidation/02-11-SUMMARY.md`
</output>
