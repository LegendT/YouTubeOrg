---
phase: 02-playlist-analysis-and-consolidation
plan: 09
type: execute
wave: 6
depends_on: [02-07]
files_modified:
  - src/components/analysis/duplicate-resolver.tsx
  - src/components/analysis/batch-operations.tsx
autonomous: true

must_haves:
  truths:
    - "User sees detailed conflict view with all source playlists per duplicate video"
    - "System applies 'keep from most specific playlist' as smart default for duplicates"
    - "User can select multiple duplicate conflicts with checkboxes and apply resolution in bulk"
    - "User sees preview of bulk resolution before applying"
    - "User can select multiple categories with checkboxes and batch approve/reject"
  artifacts:
    - path: "src/components/analysis/duplicate-resolver.tsx"
      provides: "Conflict resolution view with bulk actions and preview"
      exports: ["DuplicateResolver"]
      min_lines: 150
    - path: "src/components/analysis/batch-operations.tsx"
      provides: "Checkbox multi-select with batch approve/reject toolbar"
      exports: ["BatchOperations"]
      min_lines: 80
  key_links:
    - from: "src/components/analysis/duplicate-resolver.tsx"
      to: "src/app/actions/analysis.ts"
      via: "resolveDuplicates server action"
      pattern: "resolveDuplicates\\("
    - from: "src/components/analysis/batch-operations.tsx"
      to: "src/app/actions/analysis.ts"
      via: "bulkUpdateStatus server action"
      pattern: "bulkUpdateStatus\\("
---

<objective>
Build the duplicate conflict resolution view with bulk actions and the batch operations toolbar for multi-select approve/reject on categories.

Purpose: CONTEXT.md specifies "Detailed conflict view with all source playlists per duplicate", "Smart default 'keep from most specific playlist'", "Bulk duplicate resolution with multi-select checkboxes", "Preview before applying bulk resolution", and "Checkbox selection with approve/reject actions on multiple categories". These are distinct from the individual category detail (Plan 02-08).

Output: DuplicateResolver component for conflict resolution and BatchOperations toolbar for multi-category batch actions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-CONTEXT.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-RESEARCH.md
@src/types/analysis.ts
@src/app/actions/analysis.ts
@src/components/ui/checkbox.tsx
@src/components/ui/table.tsx
@src/components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create duplicate resolver component</name>
  <files>src/components/analysis/duplicate-resolver.tsx</files>
  <action>
Create src/components/analysis/duplicate-resolver.tsx as Client Component for bulk duplicate conflict resolution.

Props:
```typescript
interface DuplicateResolverProps {
  duplicates: DuplicateVideo[]  // From getDuplicateStats or a new server action
}
```

Implementation:

1. **Table of duplicate videos** using Table from shadcn/ui:
   - Columns: Checkbox (for multi-select), Video Title, Playlist Count, Source Playlists, Resolved To
   - Each row shows a video that appears in multiple playlists
   - Source Playlists column: list all playlists containing this video with their names
   - Resolved To column: dropdown showing which playlist "wins" for this video
     - Default selection: Apply "keep from most specific playlist" rule
     - Specificity heuristic: playlist with the LONGEST title is most specific (per CONTEXT.md and RESEARCH.md). Tiebreaker: playlist with fewer total videos (more focused).
     - User can change the dropdown to override the default

2. **Smart default logic** (runs on mount):
   - For each duplicate, sort its containing playlists by title length (descending), then by itemCount (ascending)
   - Pre-select the first playlist (longest name, fewest videos) as the default resolution
   - Store in local state: Map<duplicateId, resolvedPlaylistId>

3. **Multi-select with checkboxes:**
   - Header checkbox: select/deselect all visible duplicates
   - Individual checkboxes per row
   - Track selected IDs in useState<Set<number>>

4. **Bulk action toolbar** (appears when any checkboxes selected):
   - "Apply default resolution to selected ({N} selected)" button
   - Shows preview dialog before applying

5. **Preview dialog** (using Dialog from shadcn/ui):
   - Trigger: Click "Apply resolution" button
   - Content: Summary table showing:
     - "This will keep {X} videos from '{PlaylistA}', remove {Y} from '{PlaylistB}'"
     - Grouped by target playlist for clarity
   - Confirm button: "Apply resolution" -- calls resolveDuplicates server action with the resolution array
   - Cancel button to go back

6. **After resolution:**
   - Call resolveDuplicates(resolutions) server action
   - Show success message with count resolved
   - Refresh duplicate list (resolved items could be filtered out or shown with resolved badge)

Use Checkbox from shadcn/ui for selection. Use Table for the list. Use Dialog for preview.
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check file:
```bash
grep -E "(DuplicateResolver|resolveDuplicates)" src/components/analysis/duplicate-resolver.tsx
```

Check multi-select:
```bash
grep "Checkbox" src/components/analysis/duplicate-resolver.tsx
```

Check preview dialog:
```bash
grep "Dialog" src/components/analysis/duplicate-resolver.tsx
```
  </verify>
  <done>
DuplicateResolver shows table of duplicate videos with multi-select checkboxes. Smart default applies "keep from most specific playlist" (longest name, then fewest videos). Bulk action toolbar appears on selection. Preview dialog shows resolution summary before applying. Calls resolveDuplicates server action. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create batch operations toolbar</name>
  <files>src/components/analysis/batch-operations.tsx</files>
  <action>
Create src/components/analysis/batch-operations.tsx as Client Component for multi-category batch approve/reject.

This component wraps the category list (from Plan 02-07) and adds checkbox selection capability with a floating action toolbar.

Props:
```typescript
interface BatchOperationsProps {
  proposals: ConsolidationProposal[]
  children: React.ReactNode  // The CategoryList component as child
}
```

Implementation:

1. **Selection state:**
   - useState<Set<number>> for selected proposal IDs
   - Expose select/deselect handlers

2. **Checkbox column integration:**
   - Export a `useBatchSelection` hook that CategoryList can consume:
     ```typescript
     export function useBatchSelection() {
       const [selectedIds, setSelectedIds] = useState<Set<number>>(new Set())
       const toggle = (id: number) => { ... }
       const selectAll = (ids: number[]) => { ... }
       const clearAll = () => { ... }
       const isSelected = (id: number) => selectedIds.has(id)
       return { selectedIds, toggle, selectAll, clearAll, isSelected }
     }
     ```
   - CategoryList renders a Checkbox next to each category item
   - Header checkbox to select/deselect all visible (pending only)

3. **Floating action toolbar** (appears when any checkboxes selected):
   - Positioned as sticky bar at bottom of left panel
   - Shows: "{N} categories selected"
   - Two buttons:
     - "Approve selected" -- calls bulkUpdateStatus(selectedIds, 'approved')
     - "Reject selected" -- calls bulkUpdateStatus(selectedIds, 'rejected')
   - Both use useTransition for loading state
   - After action: clear selection, show success feedback

4. **Filtering awareness:**
   - "Select all" only selects visible (filtered) and pending proposals
   - Approved/rejected proposals cannot be selected (or show as disabled checkboxes)

Export both BatchOperations component and useBatchSelection hook. The hook will be used by the CategoryList component (Plan 02-07's category-list.tsx will need a minor update to accept and use the batch selection state).

Note: This component does NOT modify category-list.tsx directly. Instead, it provides the hook. Plan 02-11 or the executor will wire the hook into the category list when integrating all components.
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check file:
```bash
grep -E "(BatchOperations|useBatchSelection|bulkUpdateStatus)" src/components/analysis/batch-operations.tsx
```

Check exports:
```bash
grep "export" src/components/analysis/batch-operations.tsx
```
Expected: BatchOperations and useBatchSelection exported.
  </verify>
  <done>
BatchOperations provides floating action toolbar with batch approve/reject. useBatchSelection hook manages checkbox state. Toolbar appears when categories selected. Calls bulkUpdateStatus server action. Select all filters to pending-only proposals. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **TypeScript compilation clean:** `npx tsc --noEmit`
2. **DuplicateResolver:** Shows duplicate table with checkboxes, smart defaults, preview dialog
3. **BatchOperations:** Provides selection hook and floating toolbar
4. **Server action integration:** Both components call appropriate server actions
5. **Preview before apply:** Dialog shows resolution summary before executing

These components are standalone. Plans 02-10/02-11 will integrate them into the analysis dashboard.
</verification>

<success_criteria>
Plan complete when:
- DuplicateResolver shows all duplicates with source playlists and resolution dropdown
- Smart default pre-selects "most specific playlist" (longest name)
- Multi-select checkboxes work with select-all
- Preview dialog shows "will keep X from A, remove Y from B" summary
- Bulk resolution calls resolveDuplicates server action
- BatchOperations provides useBatchSelection hook for category list
- Floating toolbar shows "Approve selected" / "Reject selected" when items selected
- Batch actions call bulkUpdateStatus server action
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-playlist-analysis-and-consolidation/02-09-SUMMARY.md`
</output>
