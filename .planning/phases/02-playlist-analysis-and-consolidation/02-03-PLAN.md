---
phase: 02-playlist-analysis-and-consolidation
plan: 03
type: execute
wave: 3
depends_on: [02-02]
files_modified:
  - src/app/analysis/page.tsx
  - src/components/analysis/proposal-table.tsx
  - src/components/analysis/duplicate-report.tsx
  - package.json
autonomous: false

must_haves:
  truths:
    - "User can see proposed category consolidations with source playlists"
    - "User can see overlap analysis showing duplicate video statistics"
    - "User can approve a consolidation proposal with single click"
    - "User can reject a consolidation proposal with single click"
    - "System prevents approval of categories exceeding 4,500 videos"
  artifacts:
    - path: "src/app/analysis/page.tsx"
      provides: "Analysis dashboard page with proposal generation"
      contains: "generateConsolidationProposal"
      min_lines: 80
    - path: "src/components/analysis/proposal-table.tsx"
      provides: "Interactive table showing proposals with approve/reject"
      exports: ["ConsolidationProposalTable"]
      min_lines: 120
    - path: "src/components/analysis/duplicate-report.tsx"
      provides: "Visual display of duplicate video statistics"
      exports: ["DuplicateReport"]
      min_lines: 60
  key_links:
    - from: "src/app/analysis/page.tsx"
      to: "src/app/actions/analysis.ts"
      via: "Server action imports"
      pattern: "import.*from.*actions/analysis"
    - from: "src/components/analysis/proposal-table.tsx"
      to: "@/components/ui/table"
      via: "shadcn/ui table components"
      pattern: "import.*from.*ui/table"
    - from: "src/components/analysis/proposal-table.tsx"
      to: "src/app/actions/analysis.ts"
      via: "Client-side server action calls"
      pattern: "(approveProposal|rejectProposal)\\("
---

<objective>
Create analysis dashboard UI displaying consolidation proposals, duplicate statistics, and approve/reject workflow using shadcn/ui components.

Purpose: User-facing interface for reviewing and approving system-generated consolidation proposals. Implements CAT-05, CAT-06, CAT-07, CAT-08 requirements.

Output: Working analysis page at /analysis route with interactive proposal table, duplicate statistics, and functional approve/reject buttons. Manual drag-drop adjustment deferred to Plan 04.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-RESEARCH.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-01-PLAN.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-02-PLAN.md
@src/app/actions/analysis.ts
@src/types/analysis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn/ui Components for Analysis UI</name>
  <files>package.json, src/components/ui/</files>
  <action>
Install shadcn/ui components needed for analysis interface:

```bash
npx shadcn@latest add table button badge card
```

This installs:
- table: For consolidation proposal display
- button: For approve/reject actions
- badge: For status indicators and warnings
- card: For duplicate statistics section

If shadcn not yet initialized in project, first run:
```bash
npx shadcn@latest init
```

Accept defaults: TypeScript, App Router, src/ directory, tailwind.config.ts, CSS variables for theming.

Verify installation by checking src/components/ui/ contains table.tsx, button.tsx, badge.tsx, card.tsx.

Note: This adds lucide-react icons if not already present (used for Check, X, AlertTriangle icons).
  </action>
  <verify>
Check components exist:
```bash
ls src/components/ui/ | grep -E "(table|button|badge|card)"
```

Expected: All four component files present.

Check package.json: `grep -E "(lucide-react|class-variance-authority)" package.json`

Expected: Dependencies added by shadcn.
  </verify>
  <done>
shadcn/ui components installed. src/components/ui/ contains table.tsx, button.tsx, badge.tsx, card.tsx. Dependencies in package.json include lucide-react and CVA.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Duplicate Statistics Report Component</name>
  <files>src/components/analysis/duplicate-report.tsx</files>
  <action>
Create src/components/analysis/duplicate-report.tsx as client component displaying overlap analysis:

```typescript
'use client'

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import type { OverlapStats } from '@/types/analysis'

export function DuplicateReport({ stats }: { stats: OverlapStats }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>Duplicate Video Analysis</CardTitle>
        <CardDescription>
          Videos appearing in multiple playlists
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          <div>
            <div className="text-2xl font-bold">{stats.duplicateVideoCount}</div>
            <div className="text-sm text-muted-foreground">
              Duplicate videos ({stats.duplicationPercentage.toFixed(1)}% of total)
            </div>
          </div>
          <div>
            <div className="text-2xl font-bold">{stats.totalUniqueVideos}</div>
            <div className="text-sm text-muted-foreground">
              Total unique videos
            </div>
          </div>
          <div className="text-sm">
            Consolidating playlists will automatically eliminate these duplicates.
          </div>
        </div>
      </CardContent>
    </Card>
  )
}
```

Simple card-based component. No complex logic. Displays stats passed as props. Follows shadcn/ui patterns.
  </action>
  <verify>
Run TypeScript compilation: `npx tsc --noEmit`

Check export: `grep "export function DuplicateReport" src/components/analysis/duplicate-report.tsx`

Expected: Component exported, compiles without errors.
  </verify>
  <done>
DuplicateReport component exists as client component. Uses Card from shadcn/ui. Displays duplicate count, total unique videos, and percentage. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Consolidation Proposal Table Component</name>
  <files>src/components/analysis/proposal-table.tsx</files>
  <action>
Create src/components/analysis/proposal-table.tsx as interactive client component:

```typescript
'use client'

import { useState, useTransition } from 'react'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Check, X, AlertTriangle } from 'lucide-react'
import { approveProposal, rejectProposal } from '@/app/actions/analysis'
import type { ConsolidationProposal } from '@/types/analysis'

export function ConsolidationProposalTable({ proposals }: { proposals: ConsolidationProposal[] }) {
  const [isPending, startTransition] = useTransition()

  const handleApprove = (proposalId: number) => {
    startTransition(async () => {
      await approveProposal(proposalId)
    })
  }

  const handleReject = (proposalId: number) => {
    startTransition(async () => {
      await rejectProposal(proposalId)
    })
  }

  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Proposed Category</TableHead>
          <TableHead>Source Playlists</TableHead>
          <TableHead>Total Videos</TableHead>
          <TableHead>Status</TableHead>
          <TableHead>Actions</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {proposals.map((proposal) => {
          const isOverLimit = proposal.totalVideos > 4500
          const isNearLimit = proposal.totalVideos > 4000 && proposal.totalVideos <= 4500

          return (
            <TableRow key={proposal.id}>
              <TableCell className="font-medium">
                {proposal.categoryName}
                {isOverLimit && (
                  <Badge variant="destructive" className="ml-2">
                    <AlertTriangle className="w-3 h-3 mr-1" />
                    Over Limit
                  </Badge>
                )}
                {isNearLimit && (
                  <Badge variant="secondary" className="ml-2">
                    Near Limit
                  </Badge>
                )}
              </TableCell>
              <TableCell>
                <div className="text-sm text-muted-foreground">
                  {proposal.playlists.slice(0, 3).map(p => p.title).join(', ')}
                  {proposal.playlists.length > 3 && ` +${proposal.playlists.length - 3} more`}
                </div>
              </TableCell>
              <TableCell>{proposal.totalVideos.toLocaleString()}</TableCell>
              <TableCell>
                <Badge variant={
                  proposal.status === 'approved' ? 'default' :
                  proposal.status === 'rejected' ? 'secondary' :
                  'outline'
                }>
                  {proposal.status}
                </Badge>
              </TableCell>
              <TableCell>
                <div className="flex gap-2">
                  <Button
                    size="sm"
                    onClick={() => handleApprove(proposal.id)}
                    disabled={isOverLimit || proposal.status === 'approved' || isPending}
                  >
                    <Check className="w-4 h-4 mr-1" />
                    Approve
                  </Button>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => handleReject(proposal.id)}
                    disabled={proposal.status === 'rejected' || isPending}
                  >
                    <X className="w-4 h-4 mr-1" />
                    Reject
                  </Button>
                </div>
              </TableCell>
            </TableRow>
          )
        })}
      </TableBody>
    </Table>
  )
}
```

Implements approve/reject with useTransition for pending state. Disables approve button if over 4,500 limit. Shows warning badges. Lists source playlists with truncation. Follows research PATTERN 4 structure (line 315-474).
  </action>
  <verify>
Run TypeScript compilation: `npx tsc --noEmit`

Check client directive: `head -1 src/components/analysis/proposal-table.tsx`

Expected: First line is 'use client'. Component exports ConsolidationProposalTable. No type errors.

Grep check: `grep -E "(approveProposal|rejectProposal)" src/components/analysis/proposal-table.tsx`

Expected: Both server actions imported and called.
  </verify>
  <done>
ConsolidationProposalTable component exists as client component. Uses Table, Button, Badge from shadcn/ui. Implements approve/reject with useTransition. Shows warning badges for categories near/over limit. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create Analysis Dashboard Page</name>
  <files>src/app/analysis/page.tsx</files>
  <action>
Create src/app/analysis/page.tsx as Server Component orchestrating proposal workflow:

```typescript
import { Button } from '@/components/ui/button'
import { ConsolidationProposalTable } from '@/components/analysis/proposal-table'
import { DuplicateReport } from '@/components/analysis/duplicate-report'
import { generateConsolidationProposal, getProposals, getDuplicateStats } from '@/app/actions/analysis'

export default async function AnalysisPage() {
  const proposals = await getProposals()
  const duplicateStats = await getDuplicateStats()

  return (
    <div className="container mx-auto py-8 space-y-8">
      <div>
        <h1 className="text-3xl font-bold">Playlist Analysis & Consolidation</h1>
        <p className="text-muted-foreground mt-2">
          Analyze your {proposals.length > 0 ? proposals.length : '87'} playlists and propose consolidated category structure
        </p>
      </div>

      <div className="flex gap-4">
        <form action={generateConsolidationProposal}>
          <Button type="submit" size="lg">
            Generate Consolidation Proposal
          </Button>
        </form>
      </div>

      {duplicateStats && (
        <DuplicateReport stats={duplicateStats} />
      )}

      {proposals.length > 0 ? (
        <div className="space-y-4">
          <div>
            <h2 className="text-2xl font-semibold">Proposed Consolidations</h2>
            <p className="text-sm text-muted-foreground">
              Review and approve proposed category consolidations below
            </p>
          </div>
          <ConsolidationProposalTable proposals={proposals} />
        </div>
      ) : (
        <div className="text-center py-12 text-muted-foreground">
          No consolidation proposals yet. Click "Generate Consolidation Proposal" to analyze playlists.
        </div>
      )}
    </div>
  )
}
```

Server Component fetches data. Uses form action for proposal generation (progressive enhancement). Displays duplicate stats and proposal table. Empty state when no proposals. Follows Next.js 15 App Router patterns.
  </action>
  <verify>
Run TypeScript compilation: `npx tsc --noEmit`

Check imports: `grep "import.*from.*actions/analysis" src/app/analysis/page.tsx`

Expected: Server actions imported. Page is default export async function. No 'use client' directive (Server Component).

Verify route: `ls src/app/analysis/`

Expected: page.tsx exists in analysis directory.
  </verify>
  <done>
Analysis page exists at src/app/analysis/page.tsx as Server Component. Fetches proposals and duplicate stats. Uses form action for proposal generation. Conditionally renders table or empty state. TypeScript compiles.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete analysis dashboard UI with consolidation proposal generation, duplicate statistics display, and approve/reject functionality.

Built components:
- Analysis dashboard page at /analysis route
- Consolidation proposal table with interactive approve/reject buttons
- Duplicate report card showing overlap statistics
- shadcn/ui components integrated (table, button, badge, card)
  </what-built>
  <how-to-verify>
1. Ensure PostgreSQL container running: `docker ps | grep youtube-org-db`

2. Start Next.js dev server:
   ```bash
   npm run dev
   ```

3. Visit http://localhost:3000/analysis in browser

4. Test proposal generation:
   - Click "Generate Consolidation Proposal" button
   - Wait for proposals to appear (may show empty if no playlists in database yet)
   - If no playlists: Expected - shows empty state message
   - If playlists exist: Should see table with proposed consolidations

5. Test duplicate statistics:
   - Verify DuplicateReport card displays with counts
   - Check percentage calculation is displayed

6. Test approve/reject (if proposals exist):
   - Click "Approve" on a proposal with <4,500 videos
   - Verify status changes to "approved" and button disables
   - Click "Reject" on another proposal
   - Verify status changes to "rejected"
   - Try approving proposal over 4,500 limit - button should be disabled

7. Visual checks:
   - Table layout is clean and readable
   - Badges show appropriate colors (warning for near limit, destructive for over limit)
   - Icons render correctly (Check, X, AlertTriangle)
   - Source playlists truncate with "+N more" if >3 playlists

8. Console checks:
   - Open browser DevTools console
   - Verify no React errors or warnings
   - Verify no TypeScript errors in terminal

**Note:** This verification depends on having playlists in database. If Phase 1 Plans 2-4 not yet completed (OAuth + API sync), analysis page will work but show empty state since no playlists exist yet. That's expected and acceptable for Plan 02-03 verification.
  </how-to-verify>
  <resume-signal>
Type "approved" if UI renders and interactions work as expected, or describe any issues encountered (styling problems, errors, missing functionality).
  </resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:

1. **shadcn/ui components installed:** ls src/components/ui/ shows table, button, badge, card
2. **Components created:** ls src/components/analysis/ shows proposal-table.tsx, duplicate-report.tsx
3. **Page created:** ls src/app/analysis/ shows page.tsx
4. **TypeScript compilation clean:** npx tsc --noEmit returns no errors
5. **Client components marked:** 'use client' directive in proposal-table.tsx and duplicate-report.tsx
6. **Server component unmarked:** No 'use client' in page.tsx (Server Component pattern)
7. **Human verification passed:** User confirms UI works correctly

Manual verification required because this is visual UI with interactive elements. Automated testing would require E2E test setup (Playwright/Cypress) which is out of scope for this plan.
</verification>

<success_criteria>
Plan complete when:
- Analysis page accessible at /analysis route
- Duplicate report displays statistics
- Consolidation proposal table renders with source playlists
- Approve/reject buttons functional and update proposal status
- Over-limit categories cannot be approved (button disabled)
- Status badges show correct state (pending/approved/rejected)
- User verification confirms UI works as expected
- Ready for manual adjustment UI (Plan 04 with drag-drop)
</success_criteria>

<output>
After completion, create `.planning/phases/02-playlist-analysis-and-consolidation/02-03-SUMMARY.md` following the template structure.
</output>
