---
phase: 02-playlist-analysis-and-consolidation
plan: 08
type: execute
wave: 5
depends_on: [02-07]
files_modified:
  - src/components/analysis/category-detail.tsx
  - src/components/analysis/video-list-paginated.tsx
  - src/components/analysis/confidence-badge.tsx
  - src/components/analysis/validation-badge.tsx
  - src/components/analysis/proposal-actions.tsx
  - src/components/analysis/analysis-dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "User sees comprehensive metrics for selected category (unique videos, source playlist breakdown, overlap insights)"
    - "User sees paginated video list with thumbnail, title, duration, channel name, publish date"
    - "User can change page size (50, 100, 250, all) and search/filter videos by title or source playlist"
    - "User sees color-coded confidence badge: HIGH (green), MEDIUM (yellow), LOW (red) with reasoning text"
    - "User sees color-coded validation badge: Green (<3000), Yellow (3000-4500), Red (>4500) with progress bar"
    - "User can approve or reject proposal from the detail panel"
  artifacts:
    - path: "src/components/analysis/category-detail.tsx"
      provides: "Right panel with metrics, video list, confidence, validation, and action buttons"
      exports: ["CategoryDetail"]
      min_lines: 120
    - path: "src/components/analysis/video-list-paginated.tsx"
      provides: "Paginated video table with search, filter, and YouTube preview links"
      exports: ["VideoListPaginated"]
      min_lines: 100
    - path: "src/components/analysis/confidence-badge.tsx"
      provides: "Color-coded confidence indicator with expandable reasoning"
      exports: ["ConfidenceBadge"]
      min_lines: 25
    - path: "src/components/analysis/validation-badge.tsx"
      provides: "Category size validation indicator with progress bar"
      exports: ["ValidationBadge"]
      min_lines: 30
    - path: "src/components/analysis/proposal-actions.tsx"
      provides: "Approve/reject buttons for individual proposals"
      exports: ["ProposalActions"]
      min_lines: 40
  key_links:
    - from: "src/components/analysis/video-list-paginated.tsx"
      to: "@tanstack/react-table"
      via: "useReactTable for pagination, sorting, filtering"
      pattern: "useReactTable"
    - from: "src/components/analysis/category-detail.tsx"
      to: "src/components/analysis/video-list-paginated.tsx"
      via: "Renders paginated video list"
      pattern: "VideoListPaginated"
    - from: "src/components/analysis/analysis-dashboard.tsx"
      to: "src/components/analysis/category-detail.tsx"
      via: "Right panel content when category selected"
      pattern: "CategoryDetail"
---

<objective>
Build the right-side detail panel for the split-panel layout, showing comprehensive category metrics, paginated video list with search/filter, confidence badges, validation badges, and approve/reject action buttons.

Purpose: CONTEXT.md specifies "Comprehensive metrics per category", "Extended metadata in video lists", "Pagination with options: 50, 100, 250, or all", "Search and filter within details", color-coded confidence and validation badges, and "Action buttons at bottom of detail panel". This plan implements the full category detail view.

Output: CategoryDetail component with all sub-components, wired into the analysis-dashboard right panel.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-CONTEXT.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-RESEARCH.md
@src/types/analysis.ts
@src/app/actions/analysis.ts
@src/components/analysis/analysis-dashboard.tsx
@src/components/ui/table.tsx
@src/components/ui/badge.tsx
@src/components/ui/progress.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create confidence badge, validation badge, and proposal actions components</name>
  <files>src/components/analysis/confidence-badge.tsx, src/components/analysis/validation-badge.tsx, src/components/analysis/proposal-actions.tsx</files>
  <action>
1. **Create src/components/analysis/confidence-badge.tsx:**

Client Component displaying color-coded confidence with expandable reasoning.

Props: `{ score: number; level: 'HIGH' | 'MEDIUM' | 'LOW'; reason: string }`

Implementation:
- Badge with background color based on level:
  - HIGH: green variant (bg-green-100 text-green-800 or similar Tailwind classes)
  - MEDIUM: yellow variant (bg-yellow-100 text-yellow-800)
  - LOW: red variant (bg-red-100 text-red-800)
- Display level text inside badge
- Below badge: reasoning text in text-sm text-muted-foreground
- The reasoning text (e.g., "Name similarity: 85%, Video overlap: 45%") is always visible -- no expand needed for this part
- If there's a duplicate count, show expandable "15 duplicates (click to view)" section using a details/summary HTML element or a simple toggle state

2. **Create src/components/analysis/validation-badge.tsx:**

Client Component showing category size validation with progress bar.

Props: `{ videoCount: number }`

Implementation:
- Calculate status: 'safe' (<3000), 'warning' (3000-4500), 'danger' (>4500)
- Color-coded Badge: Green for safe, Yellow for warning, Red for danger
- Text inside badge: video count formatted with toLocaleString()
- Below badge: Progress component showing videoCount / 5000 ratio
  - Progress bar color matches status (green/yellow/red via CSS classes)
  - Label: "{videoCount} / 5,000 videos"
- If danger: add inline warning text "Exceeds safe limit of 4,500 videos"

3. **Create src/components/analysis/proposal-actions.tsx:**

Client Component with approve/reject buttons at bottom of detail panel.

Props: `{ proposalId: number; status: ProposalStatus; videoCount: number; onStatusChange?: () => void }`

Implementation:
- Use useTransition for pending state
- Approve button: calls approveProposal(proposalId) server action
  - Disabled if status === 'approved' or videoCount > 4500
  - Shows Check icon
- Reject button: calls rejectProposal(proposalId) server action
  - Disabled if status === 'rejected'
  - Shows X icon
- Both buttons use Button from shadcn/ui
- Show status badge next to buttons showing current status
- Natural language summary of consolidation above buttons per CONTEXT.md:
  - "This category combines '{playlist1}', '{playlist2}', and '{playlist3}' into '{categoryName}'"
  - Pass proposal data as additional props for this text

Expand props to include categoryName and playlistNames for the summary text:
```typescript
interface ProposalActionsProps {
  proposalId: number
  status: ProposalStatus
  videoCount: number
  categoryName: string
  playlistNames: string[]
  onStatusChange?: () => void
}
```
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check files:
```bash
ls src/components/analysis/ | grep -E "(confidence-badge|validation-badge|proposal-actions)"
```

Check exports:
```bash
grep "export function" src/components/analysis/confidence-badge.tsx src/components/analysis/validation-badge.tsx src/components/analysis/proposal-actions.tsx
```
Expected: ConfidenceBadge, ValidationBadge, ProposalActions exported.
  </verify>
  <done>
ConfidenceBadge renders color-coded HIGH/MEDIUM/LOW with reasoning text. ValidationBadge renders Green/Yellow/Red with progress bar showing video count ratio. ProposalActions renders approve/reject buttons with natural language summary. All use shadcn/ui components. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create paginated video list and category detail panel</name>
  <files>src/components/analysis/video-list-paginated.tsx, src/components/analysis/category-detail.tsx, src/components/analysis/analysis-dashboard.tsx</files>
  <action>
1. **Create src/components/analysis/video-list-paginated.tsx:**

Client Component implementing paginated video table with @tanstack/react-table.

Props:
```typescript
interface VideoListPaginatedProps {
  videos: VideoDetail[]
  sourcePlaylists: Array<{ id: number; title: string }>
}
```

Implementation using @tanstack/react-table:
- Columns: Thumbnail (img 120x68), Title, Duration, Channel Name, Published Date, Source Playlist
- Title column: text with YouTube link -- clicking opens video in new tab (a href with target="_blank")
- Thumbnail: img tag with video thumbnail URL, fallback placeholder if missing
- Duration: format as "MM:SS" or "H:MM:SS"
- Published date: format as relative ("2 months ago") or absolute ("Jan 15, 2025")
- Source playlist: show playlist title from the sourcePlaylists mapping

Page size selector: Dropdown with options [50, 100, 250, 'All']. Default 50. Use a simple select element or shadcn Select.

Pagination controls: Previous/Next buttons, page number display ("Page 1 of 5"), using @tanstack/react-table's built-in pagination state.

Search input: Filter videos by title text. Use @tanstack/react-table's globalFilter or column filter.

Source playlist filter: Dropdown to filter by specific source playlist. "All playlists" default.

Use Table components from shadcn/ui for styling.

Implementation pattern:
```typescript
import { useReactTable, getCoreRowModel, getPaginationRowModel, getFilteredRowModel, ColumnDef, flexRender } from '@tanstack/react-table'
```

2. **Create src/components/analysis/category-detail.tsx:**

Client Component for the right panel, composing all detail sub-components.

Props:
```typescript
interface CategoryDetailProps {
  proposal: ConsolidationProposal
  metrics: CategoryMetrics
  videos: VideoDetail[]
}
```

Layout (top to bottom, all within ScrollArea for scrollability):
a. **Category name** as h2
b. **Confidence badge** with score, level, reason
c. **Validation badge** with unique video count
d. **Metrics section**: Card showing:
   - Total unique videos after deduplication
   - Source playlist breakdown: list each source playlist with its individual video contribution count
   - Overlap insights: "X duplicates removed"
   - Example format per CONTEXT.md: "JavaScript: 247 unique videos from 3 playlists (JS Basics: 87, JS Advanced: 120, Web Dev: 42), 15 duplicates removed"
e. **Video list** (paginated) with search and filter
f. **Proposal actions** (approve/reject buttons at bottom, per CONTEXT.md "Action buttons at bottom of detail panel")

Use Separator between sections. Wrap in ScrollArea for overflow handling.

3. **Update src/components/analysis/analysis-dashboard.tsx:**

Replace the placeholder right panel with actual CategoryDetail:
- Import CategoryDetail
- When selectedCategoryId is set, find the matching proposal from the proposals array
- Need to also pass metrics and videos. Since this is a client component, it needs the data pre-fetched.

Strategy: The analysis page (Server Component) fetches ALL data and passes it down. For the detail panel, we need:
- proposals (already passed)
- A map of categoryId -> { metrics, videos }

Add a new prop to AnalysisDashboard:
```typescript
interface AnalysisDashboardProps {
  proposals: ConsolidationProposal[]
  summary: AnalysisSummary
  categoryData: Record<number, { metrics: CategoryMetrics; videos: VideoDetail[] }>
}
```

PERFORMANCE NOTE: For 87 playlists, pre-fetching all video details would be too expensive. Instead:
- Pass proposals and summary to AnalysisDashboard (already done)
- When user selects a category, fetch that category's detail data via a server action
- Add a new server action `getCategoryDetail(proposalId: number)` to src/app/actions/analysis.ts that returns { metrics: CategoryMetrics, videos: VideoDetail[] }
- Use useState + useEffect in analysis-dashboard to fetch detail data when selectedCategoryId changes
- Show loading skeleton while fetching

Add to src/app/actions/analysis.ts:
```typescript
export async function getCategoryDetail(proposalId: number): Promise<{ metrics: CategoryMetrics; videos: VideoDetail[] }>
```
This function:
- Gets the proposal from DB
- Gets the source playlist IDs
- For each source playlist, count videos contributed
- Calculate unique video count, duplicate count
- Build confidence info from stored confidenceScore/confidenceReason
- Determine validationStatus from uniqueVideoCount thresholds
- Fetch video details: join videos with playlistVideos for the source playlists, including thumbnail, title, duration, channelName, publishedAt
- Return structured CategoryMetrics and VideoDetail[]
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check new components:
```bash
ls src/components/analysis/ | grep -E "(video-list-paginated|category-detail)"
```

Check @tanstack/react-table usage:
```bash
grep "useReactTable" src/components/analysis/video-list-paginated.tsx
```

Check CategoryDetail integration:
```bash
grep "CategoryDetail" src/components/analysis/analysis-dashboard.tsx
```

Check server action added:
```bash
grep "getCategoryDetail" src/app/actions/analysis.ts
```
  </verify>
  <done>
VideoListPaginated uses @tanstack/react-table with pagination (50/100/250/all), search by title, filter by source playlist, YouTube preview links. CategoryDetail composes confidence badge, validation badge, metrics, video list, and proposal actions in a scrollable panel. AnalysisDashboard wires CategoryDetail into right panel with on-demand data fetching via getCategoryDetail server action. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **TypeScript compilation clean:** `npx tsc --noEmit`
2. **All components created:** confidence-badge, validation-badge, proposal-actions, video-list-paginated, category-detail
3. **@tanstack/react-table used:** VideoListPaginated uses useReactTable with pagination
4. **Pagination options:** 50, 100, 250, all
5. **Search/filter:** Title search and source playlist filter
6. **Confidence badges:** Color-coded HIGH/MEDIUM/LOW with reasoning
7. **Validation badges:** Color-coded Green/Yellow/Red with progress bar
8. **Actions at bottom:** Approve/reject buttons in detail panel
9. **Dashboard wired:** CategoryDetail renders in right panel

This plan completes the main detail view. Plans 02-09 through 02-12 add duplicate resolution, batch operations, split wizard, keyboard nav, and final review.
</verification>

<success_criteria>
Plan complete when:
- CategoryDetail shows comprehensive metrics per CONTEXT.md spec
- Video list paginated with 4 page size options and search/filter
- Videos show thumbnail, title, duration, channel, date, source playlist
- YouTube preview link opens in new tab
- Confidence badge shows color-coded level with reasoning
- Validation badge shows color-coded size with progress bar
- Approve/reject buttons work at bottom of detail panel
- On-demand data fetching prevents loading all video data upfront
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-playlist-analysis-and-consolidation/02-08-SUMMARY.md`
</output>
