---
phase: 02-playlist-analysis-and-consolidation
plan: 06
type: execute
wave: 4
depends_on: [02-02, 02-05]
files_modified:
  - src/app/actions/analysis.ts
  - src/types/analysis.ts
autonomous: true

must_haves:
  truths:
    - "System can run analysis with Conservative or Aggressive mode and track it as a session"
    - "System can split a proposal into multiple new categories via server action"
    - "System can create a custom category from manually selected playlists"
    - "System can resolve duplicates by assigning a winning playlist"
    - "System can batch-update multiple proposal statuses in one action"
    - "System detects when playlist data is newer than the last analysis session"
  artifacts:
    - path: "src/app/actions/analysis.ts"
      provides: "Enhanced server actions: runAnalysis, splitProposal, createCustomCategory, resolveDuplicates, bulkUpdateStatus, checkStaleness"
      exports: ["runAnalysis", "splitProposal", "createCustomCategory", "resolveDuplicates", "bulkUpdateStatus", "checkStaleness"]
      min_lines: 200
    - path: "src/types/analysis.ts"
      provides: "Extended type definitions for sessions, confidence, algorithm modes, split wizard, duplicate resolution"
      exports: ["AnalysisSession", "AlgorithmMode", "ConfidenceLevel", "SplitInput", "DuplicateResolution"]
      min_lines: 80
  key_links:
    - from: "src/app/actions/analysis.ts"
      to: "src/lib/analysis/clustering.ts"
      via: "clusterPlaylists with mode parameter"
      pattern: "clusterPlaylists\\(mode\\)"
    - from: "src/app/actions/analysis.ts"
      to: "src/lib/db/schema.ts"
      via: "analysisSessions insert for session tracking"
      pattern: "db\\.insert\\(analysisSessions\\)"
    - from: "src/app/actions/analysis.ts"
      to: "src/lib/analysis/confidence.ts"
      via: "calculateConfidence for proposal enrichment"
      pattern: "calculateConfidence"
    - from: "src/app/actions/analysis.ts"
      to: "src/types/analysis.ts"
      via: "DuplicateResolution type import for resolveDuplicates parameter"
      pattern: "import.*DuplicateResolution.*from.*types/analysis"
---

<objective>
Add server actions required by CONTEXT.md that Plan 02-02 did not cover: analysis with mode selection and session tracking, proposal splitting, custom category creation, duplicate resolution, batch status updates, and staleness detection.

Purpose: CONTEXT.md specifies Conservative/Aggressive modes, a split wizard, custom category creation, bulk duplicate resolution, batch operations, and multi-session staleness detection. These all need server-side support beyond the basic generate/approve/reject from Plan 02-02.

Output: Enhanced server actions and types ready for UI components to call. All analysis state persisted in analysisSessions for multi-session workflow.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-CONTEXT.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-RESEARCH.md
@src/app/actions/analysis.ts
@src/types/analysis.ts
@src/lib/analysis/clustering.ts
@src/lib/analysis/similarity.ts
@src/lib/analysis/confidence.ts
@src/lib/analysis/duplicates.ts
@src/lib/analysis/consolidation.ts
@src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend type definitions for analysis features</name>
  <files>src/types/analysis.ts</files>
  <action>
Update src/types/analysis.ts to add types needed by new server actions and UI components. ADD to existing types (do not remove existing types from Plan 02-02):

```typescript
// === NEW TYPES (add after existing types) ===

export type AlgorithmMode = 'conservative' | 'aggressive'
export type ConfidenceLevel = 'HIGH' | 'MEDIUM' | 'LOW'

export interface AnalysisSession {
  id: number
  mode: AlgorithmMode
  playlistCount: number
  proposalCount: number
  duplicateCount: number
  createdAt: Date
  playlistDataTimestamp: Date
  finalizedAt?: Date
}

export interface ConfidenceInfo {
  score: number      // 0-100
  level: ConfidenceLevel
  reason: string     // "Name similarity: 85%, Video overlap: 45%"
}

// Extend existing ConsolidationProposal with new fields
// (update the existing interface, do not create duplicate)
// Add to ConsolidationProposal:
//   sessionId?: number
//   confidenceScore?: number
//   confidenceReason?: string
//   uniqueVideoCount?: number
//   duplicateVideoCount?: number
//   confidence?: ConfidenceInfo
//   updatedAt?: Date

export interface SplitInput {
  name: string
  playlistIds: number[]
}

export interface DuplicateResolution {
  duplicateRecordId: number
  resolvedPlaylistId: number  // The playlist that "wins" for this video
}

export interface RunAnalysisResult {
  success: boolean
  sessionId?: number
  proposalCount?: number
  duplicateCount?: number
  errors?: string[]
}

export interface StalenessCheck {
  isStale: boolean
  lastAnalysisDate?: Date
  lastSyncDate?: Date
  message?: string
}

export interface AnalysisSummary {
  totalPlaylists: number
  proposedCategories: number
  duplicatesFound: number
  reviewedCount: number
  approvedCount: number
  rejectedCount: number
  pendingCount: number
}

export interface VideoDetail {
  id: number
  youtubeId: string
  title: string
  thumbnailUrl?: string
  duration?: string
  channelName?: string
  publishedAt?: Date
  sourcePlaylistId: number
  sourcePlaylistTitle: string
}

export interface CategoryMetrics {
  uniqueVideoCount: number
  duplicateVideoCount: number
  sourcePlaylistBreakdown: Array<{
    playlistId: number
    playlistTitle: string
    videoCount: number
  }>
  confidence: ConfidenceInfo
  validationStatus: 'safe' | 'warning' | 'danger'  // <3000, 3000-4500, >4500
}
```

IMPORTANT: Update the existing ConsolidationProposal interface (from Plan 02-02) by adding the new optional fields (sessionId, confidenceScore, confidenceReason, uniqueVideoCount, duplicateVideoCount, confidence, updatedAt). Keep all existing fields.

Also update the AnalysisSession interface to include finalizedAt as an optional Date field, matching the database schema column added in Plan 02-05.
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check new types:
```bash
grep -E "(AlgorithmMode|ConfidenceLevel|AnalysisSession|SplitInput|DuplicateResolution|RunAnalysisResult|StalenessCheck|AnalysisSummary|VideoDetail|CategoryMetrics)" src/types/analysis.ts
```
Expected: All new types present alongside existing ones.
  </verify>
  <done>
src/types/analysis.ts contains all original types plus AlgorithmMode, ConfidenceLevel, AnalysisSession, ConfidenceInfo, SplitInput, DuplicateResolution, RunAnalysisResult, StalenessCheck, AnalysisSummary, VideoDetail, CategoryMetrics. AnalysisSession includes finalizedAt. ConsolidationProposal updated with new optional fields. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add enhanced server actions for analysis workflow</name>
  <files>src/app/actions/analysis.ts</files>
  <action>
Add the following server actions to the EXISTING src/app/actions/analysis.ts file. Do NOT remove existing functions (generateConsolidationProposal, approveProposal, rejectProposal, getProposals, getDuplicateStats, updateProposalPlaylists). ADD these new functions:

1. **runAnalysis(mode: AlgorithmMode = 'aggressive')** - Replaces/enhances generateConsolidationProposal:
   - Create a new analysisSessions record: { mode, playlistCount: (count playlists), playlistDataTimestamp: (latest playlists.lastFetched) }
   - Call clusterPlaylists(mode) to get enriched clusters with confidence
   - For each cluster, insert into consolidationProposals with sessionId, confidenceScore, confidenceReason, uniqueVideoCount, duplicateVideoCount
   - Call findDuplicateVideos() and insert into duplicateVideos/duplicateRecords with sessionId
   - Update analysisSessions record with proposalCount and duplicateCount
   - revalidatePath('/analysis')
   - Return: { success: true, sessionId, proposalCount, duplicateCount } or { success: false, errors: [...] }

2. **splitProposal(proposalId: number, newCategories: SplitInput[])** - For split wizard:
   - Mark original proposal as 'rejected' with note 'Split into N categories'
   - For each newCategory in newCategories:
     - Calculate uniqueVideoCount via calculateDeduplicatedCount(playlistIds)
     - Insert new consolidationProposal with sessionId from original, confidenceScore: 100, confidenceReason: 'Manually created via split wizard', status: 'pending'
   - revalidatePath('/analysis')
   - Return: { success: true, newProposalIds: number[] }

3. **createCustomCategory(name: string, playlistIds: number[])** - Create during analysis:
   - Calculate uniqueVideoCount via calculateDeduplicatedCount(playlistIds)
   - Validate against 4500 limit
   - Get latest session ID (or create one if none exists)
   - Insert into consolidationProposals with confidenceScore: 100, confidenceReason: 'Manually created', status: 'pending'
   - revalidatePath('/analysis')
   - Return: { success: true, proposalId: number }

4. **resolveDuplicates(resolutions: DuplicateResolution[])** - Bulk duplicate resolution:
   - Import DuplicateResolution type from '@/types/analysis'
   - For each resolution, update duplicateVideos/duplicateRecords SET resolvedPlaylistId = resolution.resolvedPlaylistId WHERE id = resolution.duplicateRecordId
   - revalidatePath('/analysis')
   - Return: { success: true, resolvedCount: number }

5. **bulkUpdateStatus(proposalIds: number[], status: 'approved' | 'rejected')** - Batch approve/reject:
   - For each proposalId, update consolidationProposals SET status, updatedAt, and approvedAt if approving
   - revalidatePath('/analysis')
   - Return: { success: true, updatedCount: number }

6. **checkStaleness()** - Multi-session staleness detection:
   - Get latest analysisSessions record (most recent createdAt)
   - Get latest playlists record (most recent lastFetched)
   - If no analysis session exists, return { isStale: false, message: 'No analysis run yet' }
   - Compare playlistDataTimestamp from session with latest playlists.lastFetched
   - If playlists.lastFetched > session.playlistDataTimestamp, return { isStale: true, lastAnalysisDate, lastSyncDate, message: 'Playlist data has changed since last analysis. Re-analyze?' }
   - Otherwise return { isStale: false }

7. **getAnalysisSummary()** - For overview card:
   - Count total playlists (excluding Watch Later)
   - Count proposals by status (approved, rejected, pending)
   - Count total duplicates from latest session
   - Return: AnalysisSummary object

8. **getLatestSession()** - For session tracking:
   - Return latest analysisSessions record or null

Import all new types from '@/types/analysis'. Import AlgorithmMode, DuplicateResolution, calculateConfidence, clusterPlaylists, and schema tables as needed.
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check all new server actions exist:
```bash
grep -E "export async function (runAnalysis|splitProposal|createCustomCategory|resolveDuplicates|bulkUpdateStatus|checkStaleness|getAnalysisSummary|getLatestSession)" src/app/actions/analysis.ts
```
Expected: All 8 new functions listed.

Check 'use server' directive:
```bash
head -1 src/app/actions/analysis.ts
```
Expected: 'use server'

Check DuplicateResolution import:
```bash
grep "DuplicateResolution" src/app/actions/analysis.ts
```
Expected: Import from '@/types/analysis' and usage in resolveDuplicates parameter.
  </verify>
  <done>
8 new server actions added to analysis.ts: runAnalysis (with mode + session tracking), splitProposal, createCustomCategory, resolveDuplicates, bulkUpdateStatus, checkStaleness, getAnalysisSummary, getLatestSession. All use Drizzle ORM, persist to database, call revalidatePath. resolveDuplicates imports DuplicateResolution type from types/analysis. TypeScript compiles with all types from analysis.ts.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **TypeScript compilation clean:** `npx tsc --noEmit` returns no errors
2. **Types extended:** src/types/analysis.ts has 10+ new type/interface exports
3. **Server actions count:** src/app/actions/analysis.ts now has 13+ exported functions (5 original + 8 new)
4. **Session tracking:** runAnalysis creates analysisSessions records
5. **Staleness detection:** checkStaleness compares timestamps
6. **All 'use server':** First line of analysis.ts is 'use server'
7. **DuplicateResolution wiring:** resolveDuplicates imports DuplicateResolution from types/analysis

These server actions provide the complete backend API for all CONTEXT.md features. Plans 02-07 through 02-12 build UI on top.
</verification>

<success_criteria>
Plan complete when:
- All 8 new server actions implemented and exported
- Type definitions extended with all new interfaces
- runAnalysis creates session records and stores confidence data
- splitProposal rejects original and creates new proposals
- createCustomCategory validates limits and creates proposal
- resolveDuplicates imports DuplicateResolution type and updates resolvedPlaylistId
- bulkUpdateStatus batch-updates proposals
- checkStaleness compares session vs playlist timestamps
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-playlist-analysis-and-consolidation/02-06-SUMMARY.md`
</output>
