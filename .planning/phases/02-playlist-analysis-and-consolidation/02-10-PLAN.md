---
phase: 02-playlist-analysis-and-consolidation
plan: 10
type: execute
wave: 6
depends_on: [02-08]
files_modified:
  - src/components/analysis/split-wizard.tsx
  - src/components/analysis/manual-adjustments.tsx
  - src/components/analysis/category-detail.tsx
autonomous: true

must_haves:
  truths:
    - "User can split a proposal into multiple new categories via guided wizard"
    - "Split wizard guides user: How many categories? -> Name each -> Assign playlists to each"
    - "User can add playlists to a proposal with 'Add playlist' button and selector"
    - "User can remove playlists from a proposal with X button on each source playlist"
    - "User can create a new custom category during analysis"
    - "All metrics (counts, confidence, validation) recalculate after manual changes"
    - "Rejected proposals move to 'Review needed' section"
  artifacts:
    - path: "src/components/analysis/split-wizard.tsx"
      provides: "Multi-step dialog for splitting a proposal into N new categories"
      exports: ["SplitWizard"]
      min_lines: 150
    - path: "src/components/analysis/manual-adjustments.tsx"
      provides: "Add/remove playlist buttons, create new category button"
      exports: ["ManualAdjustments", "AddPlaylistSelector", "CreateCategoryDialog"]
      min_lines: 120
  key_links:
    - from: "src/components/analysis/split-wizard.tsx"
      to: "src/app/actions/analysis.ts"
      via: "splitProposal server action"
      pattern: "splitProposal\\("
    - from: "src/components/analysis/manual-adjustments.tsx"
      to: "src/app/actions/analysis.ts"
      via: "createCustomCategory and updateProposalPlaylists server actions"
      pattern: "(createCustomCategory|updateProposalPlaylists)\\("
    - from: "src/components/analysis/category-detail.tsx"
      to: "src/components/analysis/split-wizard.tsx"
      via: "Split button triggers wizard"
      pattern: "SplitWizard"
---

<objective>
Build the split wizard and manual adjustment controls per CONTEXT.md: split a proposal into multiple categories via guided dialog, add/remove playlists from proposals with buttons, create new custom categories during analysis, and ensure metrics recalculate after changes.

Purpose: CONTEXT.md specifies "All adjustment methods available: Edit in place, reject and recreate, split/merge", "Split workflow: Guided wizard (How many? -> Name each -> Assign playlists)", "Add playlist button opens selector", "X button on each source playlist", "Create new category during analysis", and "Real-time metric updates after manual changes". These replace the drag-and-drop approach from Plan 02-04.

Output: SplitWizard dialog component, ManualAdjustments toolbar with add/remove/create functionality, integrated into CategoryDetail panel.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-CONTEXT.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-RESEARCH.md
@src/types/analysis.ts
@src/app/actions/analysis.ts
@src/components/analysis/category-detail.tsx
@src/components/ui/dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create split wizard dialog</name>
  <files>src/components/analysis/split-wizard.tsx</files>
  <action>
Create src/components/analysis/split-wizard.tsx as Client Component implementing guided multi-step split workflow.

Props:
```typescript
interface SplitWizardProps {
  proposal: ConsolidationProposal
  open: boolean
  onOpenChange: (open: boolean) => void
  onComplete: () => void  // Callback to refresh parent
}
```

Implementation as a Dialog with 3 steps (use local state machine):

**Step 1: "How many categories?"**
- Display current proposal name and source playlists
- Number input: "Split into how many categories?" (min 2, max = number of source playlists)
- Default: 2
- "Next" button to proceed

**Step 2: "Name each category"**
- For each new category (based on count from step 1):
  - Text input: "Category {N} name"
  - Pre-fill with intelligent defaults: if splitting 2, use the two most dissimilar playlist names from the source
- "Back" and "Next" buttons

**Step 3: "Assign playlists to each category"**
- For each new category:
  - Show category name (from step 2)
  - Checkbox list of all source playlists from the original proposal
  - User checks which playlists belong to this category
  - Each playlist can only be assigned to one category (radio-button behavior across categories)
- Validation: all playlists must be assigned somewhere (no orphans)
- Show video count estimate per new category (sum of playlist itemCounts as rough estimate)
- "Back" and "Split" buttons

**On Split execution:**
- Build SplitInput[] array from wizard state
- Call splitProposal(proposalId, newCategories) server action
- Show loading state during execution
- On success: close dialog, call onComplete() to refresh parent
- On error: show error message within dialog

State management:
```typescript
interface WizardState {
  step: 'count' | 'name' | 'assign'
  splitCount: number
  names: string[]
  assignments: Map<number, number>  // playlistId -> categoryIndex
}
```

Use Dialog, Button, Input from shadcn/ui. Use simple step indicator at top ("Step 1 of 3: Choose count").
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check file:
```bash
grep -E "(SplitWizard|splitProposal)" src/components/analysis/split-wizard.tsx
```

Check multi-step:
```bash
grep -E "(step.*count|step.*name|step.*assign)" src/components/analysis/split-wizard.tsx
```
  </verify>
  <done>
SplitWizard implements 3-step guided dialog: count -> name -> assign. Validates all playlists assigned. Calls splitProposal server action. Shows loading state. Uses Dialog from shadcn/ui. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create manual adjustment controls and integrate into category detail</name>
  <files>src/components/analysis/manual-adjustments.tsx, src/components/analysis/category-detail.tsx</files>
  <action>
1. **Create src/components/analysis/manual-adjustments.tsx:**

Contains three sub-components for manual adjustments:

a. **AddPlaylistSelector** - Button + dialog to add playlists to a proposal:
   - "Add playlist" button that opens a Dialog
   - Dialog shows all playlists NOT currently in this proposal
   - Searchable list (text input filtering)
   - Multi-select with checkboxes
   - "Add selected" button
   - Calls updateProposalPlaylists server action with current playlistIds + new ones
   - On success: close dialog, trigger parent refresh

   Props:
   ```typescript
   interface AddPlaylistSelectorProps {
     proposalId: number
     currentPlaylistIds: number[]
     allPlaylists: Array<{ id: number; title: string; itemCount: number }>
     onUpdate: () => void
   }
   ```

b. **RemovePlaylistButton** - X button on each source playlist:
   - Small X button next to each playlist in the source playlist list
   - Calls updateProposalPlaylists with the playlist removed
   - Disabled if only 1 playlist remaining (can't have empty proposal)
   - Confirmation: no confirmation needed for single removal (quick action)

   Props:
   ```typescript
   interface RemovePlaylistButtonProps {
     proposalId: number
     playlistIdToRemove: number
     currentPlaylistIds: number[]
     disabled?: boolean
     onUpdate: () => void
   }
   ```

c. **CreateCategoryDialog** - Button + dialog to create a new custom category:
   - "Create new category" button (shown somewhere accessible, e.g., in the category list panel)
   - Dialog with:
     - Text input: "Category name"
     - Multi-select playlist picker (searchable, with checkboxes)
     - Video count estimate shown as user selects playlists
     - Validation: warn if >4500 videos
   - "Create" button calls createCustomCategory server action
   - On success: close dialog, trigger parent refresh

   Props:
   ```typescript
   interface CreateCategoryDialogProps {
     allPlaylists: Array<{ id: number; title: string; itemCount: number }>
     onCreated: () => void
   }
   ```

Export: ManualAdjustments (container component), AddPlaylistSelector, CreateCategoryDialog, RemovePlaylistButton

2. **Update src/components/analysis/category-detail.tsx:**

Add manual adjustment controls to the detail panel:
- After the metrics section and before the video list, add a section "Adjustments":
  - "Split this proposal" button (opens SplitWizard)
  - Source playlist list with RemovePlaylistButton on each item
  - "Add playlist" button (opens AddPlaylistSelector)
- Import SplitWizard and ManualAdjustments components
- Add state for split wizard open/close
- After any manual change (add/remove/split/create), refresh the detail data by re-calling getCategoryDetail

The adjustment section should only show for proposals with status === 'pending' (approved/rejected proposals are not editable).

Also pass an allPlaylists prop to CategoryDetail (fetched by the parent) so the add/create dialogs know what playlists exist.

Ensure that after any adjustment action:
- The detail panel refreshes (re-fetch getCategoryDetail)
- The category list updates (parent re-fetches proposals via revalidatePath triggered by server actions)
- Metrics (video count, confidence, validation) reflect the changes
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check manual adjustments:
```bash
grep -E "(AddPlaylistSelector|RemovePlaylistButton|CreateCategoryDialog|ManualAdjustments)" src/components/analysis/manual-adjustments.tsx
```

Check split wizard integration:
```bash
grep "SplitWizard" src/components/analysis/category-detail.tsx
```

Check add/remove integration:
```bash
grep -E "(AddPlaylistSelector|RemovePlaylistButton)" src/components/analysis/category-detail.tsx
```
  </verify>
  <done>
ManualAdjustments provides AddPlaylistSelector (searchable multi-select dialog), RemovePlaylistButton (X on each playlist), and CreateCategoryDialog (name + select playlists). SplitWizard integrated into CategoryDetail with "Split this proposal" button. All controls trigger server actions and refresh detail data. Only shown for pending proposals. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **TypeScript compilation clean:** `npx tsc --noEmit`
2. **Split wizard:** 3-step dialog working (count -> name -> assign)
3. **Add playlist:** Dialog with searchable multi-select
4. **Remove playlist:** X button on each source playlist
5. **Create category:** Dialog with name input and playlist multi-select
6. **Integration:** All controls in CategoryDetail for pending proposals
7. **Server action calls:** splitProposal, updateProposalPlaylists, createCustomCategory

This completes manual adjustment mechanics from CONTEXT.md.
</verification>

<success_criteria>
Plan complete when:
- SplitWizard guides through 3 steps and calls splitProposal
- AddPlaylistSelector opens searchable dialog and adds playlists
- RemovePlaylistButton removes playlist with single click
- CreateCategoryDialog creates new custom category
- All controls wired into CategoryDetail for pending proposals
- Metrics refresh after every manual change
- Rejected proposals become uneditable
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-playlist-analysis-and-consolidation/02-10-SUMMARY.md`
</output>
