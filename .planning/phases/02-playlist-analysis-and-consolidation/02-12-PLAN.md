---
phase: 02-playlist-analysis-and-consolidation
plan: 12
type: execute
wave: 7
depends_on: [02-08, 02-09, 02-10, 02-11]
files_modified:
  - src/components/analysis/final-review.tsx
  - src/components/analysis/analysis-dashboard.tsx
  - src/components/analysis/category-list.tsx
  - src/app/analysis/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees final review screen with summary statistics, detailed change list, and impact visualization"
    - "User can execute all approved consolidations with single 'Execute consolidation' button"
    - "All components are integrated: split panel, category list, detail panel, batch ops, keyboard nav, progress, loading"
    - "Complete end-to-end analysis workflow functions from run analysis to final execution"
  artifacts:
    - path: "src/components/analysis/final-review.tsx"
      provides: "Pre-execution comprehensive review screen with summary, change list, and impact"
      exports: ["FinalReview"]
      min_lines: 120
    - path: "src/components/analysis/analysis-dashboard.tsx"
      provides: "Fully integrated dashboard with all Plan 02-05 through 02-11 components"
      min_lines: 150
    - path: "src/app/analysis/page.tsx"
      provides: "Analysis page with all features wired"
      min_lines: 80
  key_links:
    - from: "src/components/analysis/final-review.tsx"
      to: "src/app/actions/analysis.ts"
      via: "Execute consolidation action"
      pattern: "executeConsolidation|bulkUpdateStatus"
    - from: "src/components/analysis/analysis-dashboard.tsx"
      to: "src/components/analysis/category-list.tsx"
      via: "Passes batch selection and keyboard nav"
      pattern: "(useBatchSelection|useCategoryKeyboardNav)"
    - from: "src/app/analysis/page.tsx"
      to: "src/components/analysis/analysis-dashboard.tsx"
      via: "Server Component passes all data to client dashboard"
      pattern: "AnalysisDashboard"
---

<objective>
Build the final review screen and integrate ALL components from Plans 02-05 through 02-11 into a cohesive analysis workflow. Wire keyboard navigation into category list, batch operations into the dashboard, progress tracking, staleness banner, and the complete end-to-end flow from running analysis to final execution.

Purpose: CONTEXT.md specifies "Final review screen: Before execution, show comprehensive review with summary statistics, detailed change list, impact visualization" and "Single 'Execute consolidation' button". This plan also serves as the integration point where all separately-built components come together into the working analysis page.

Output: Complete, fully-functional analysis page with all CONTEXT.md features working end-to-end.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-CONTEXT.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-RESEARCH.md
@src/types/analysis.ts
@src/app/actions/analysis.ts
@src/app/analysis/page.tsx
@src/components/analysis/analysis-dashboard.tsx
@src/components/analysis/category-list.tsx
@src/components/analysis/category-detail.tsx
@src/components/analysis/batch-operations.tsx
@src/components/analysis/keyboard-nav.tsx
@src/components/analysis/progress-tracker.tsx
@src/components/analysis/staleness-banner.tsx
@src/components/analysis/analysis-loading.tsx
@src/components/analysis/algorithm-mode-toggle.tsx
@src/components/analysis/duplicate-resolver.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create final review screen</name>
  <files>src/components/analysis/final-review.tsx</files>
  <action>
Create src/components/analysis/final-review.tsx as Client Component implementing the pre-execution comprehensive review.

Props:
```typescript
interface FinalReviewProps {
  proposals: ConsolidationProposal[]
  summary: AnalysisSummary
  open: boolean
  onOpenChange: (open: boolean) => void
  onExecute: () => void
}
```

Implementation as a full-screen Dialog (or sheet):

**Section 1: Summary Statistics**
- "25 categories to create"
- "82 playlists to merge"
- "234 duplicates to remove"
- "{X} categories approved, {Y} rejected, {Z} pending"
- Warning if any pending categories remain: "Note: {Z} categories are still pending review"

**Section 2: Detailed Change List**
- Scrollable list of every approved proposal
- For each: Category name, source playlists (with arrow showing merge), video count
- Format: "JavaScript: JS Basics (87) + JS Advanced (120) + Web Dev (42) -> 247 unique videos"
- Color-coded by status: only approved shown as active changes, rejected shown as struck-through

**Section 3: Impact Visualization**
- Before/After comparison:
  - Before: "{totalPlaylists} playlists"
  - After: "{approvedCount} consolidated categories"
  - Net reduction: "Reducing from {X} to {Y} playlists ({Z}% consolidation)"
- Action summary: "Will create {X} new playlists, move {Y} videos, mark {Z} source playlists for consolidation"

**Section 4: Execution Button**
- Single "Execute consolidation" button at the bottom (per CONTEXT.md: no type-to-confirm or checkboxes needed)
- Button disabled if 0 approved proposals
- On click: calls onExecute callback
- Loading state while executing

NOTE: The actual "Execute consolidation" functionality (creating YouTube playlists, moving videos) is Phase 8 (Batch Sync Operations). For Phase 2, this button should:
- Mark all approved proposals as "finalized" (add a status or flag)
- Store the approved structure as the target category structure for future phases
- Show success: "Consolidation structure saved. {X} categories ready for Phase 3."
- The button does NOT sync to YouTube -- that's Phase 8

Add a server action `finalizeConsolidation()` to src/app/actions/analysis.ts:
- Validates all approved proposals (recheck limits)
- Marks the session as finalized
- Returns { success: true, categoryCount: number }

Use Dialog from shadcn/ui with large size. ScrollArea for the change list section. Separator between sections.
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check file:
```bash
grep -E "(FinalReview|finalizeConsolidation)" src/components/analysis/final-review.tsx
```

Check sections:
```bash
grep -E "(Summary|Change List|Impact|Execute)" src/components/analysis/final-review.tsx
```

Check server action added:
```bash
grep "finalizeConsolidation" src/app/actions/analysis.ts
```
  </verify>
  <done>
FinalReview shows summary statistics, detailed change list, before/after impact visualization, and "Execute consolidation" button. finalizeConsolidation server action validates and marks session as finalized. Dialog uses ScrollArea for long content. Button disabled when no approved proposals. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate all components into analysis dashboard and page</name>
  <files>src/components/analysis/analysis-dashboard.tsx, src/components/analysis/category-list.tsx, src/app/analysis/page.tsx</files>
  <action>
This is the integration task that wires all separately-built components together.

1. **Update src/components/analysis/category-list.tsx:**

Add the following integrations:
- Accept `batchSelection` prop from useBatchSelection hook (selectedIds, toggle, isSelected)
- Render Checkbox next to each category item (from batch-operations)
- Accept `focusedIndex` prop from useCategoryKeyboardNav hook
- Apply focus ring class (ring-2 ring-primary) to the focused item
- Show "select all" checkbox in header
- Add the CreateCategoryDialog button below the list

Updated props:
```typescript
interface CategoryListProps {
  proposals: ConsolidationProposal[]
  selectedId: number | null
  onSelect: (id: number) => void
  batchSelection?: {
    selectedIds: Set<number>
    toggle: (id: number) => void
    isSelected: (id: number) => boolean
  }
  focusedIndex?: number
  allPlaylists?: Array<{ id: number; title: string; itemCount: number }>
  onCategoryCreated?: () => void
}
```

2. **Update src/components/analysis/analysis-dashboard.tsx:**

Wire all components:

```typescript
export function AnalysisDashboard({ proposals, summary, staleness, allPlaylists }: AnalysisDashboardProps) {
  // State
  const [orientation, setOrientation] = useState<Orientation>('horizontal')
  const [selectedCategoryId, setSelectedCategoryId] = useState<number | null>(null)
  const [showFinalReview, setShowFinalReview] = useState(false)
  const [detailData, setDetailData] = useState<{ metrics: CategoryMetrics; videos: VideoDetail[] } | null>(null)
  const [detailLoading, setDetailLoading] = useState(false)

  // Hooks
  const batchSelection = useBatchSelection()
  const keyboardNav = useCategoryKeyboardNav({
    categories: proposals,
    onSelect: setSelectedCategoryId,
  })

  // Fetch detail on category selection
  useEffect(() => {
    if (selectedCategoryId) {
      setDetailLoading(true)
      getCategoryDetail(selectedCategoryId).then(data => {
        setDetailData(data)
        setDetailLoading(false)
      })
    }
  }, [selectedCategoryId])

  // Layout (top to bottom):
  // 1. ProgressTracker
  // 2. Orientation toggle + "Review & Execute" button
  // 3. ResizablePanelGroup:
  //    Left panel: CategoryList (with batch checkboxes, keyboard focus, search, sort)
  //    Right panel: CategoryDetail (or DuplicateResolver via tab, or empty state)
  // 4. BatchOperations floating toolbar (when items selected)
  // 5. FinalReview dialog (when showFinalReview is true)
}
```

Add a tab or toggle in the right panel header to switch between:
- "Category Detail" (default) -- shows CategoryDetail for selected category
- "Duplicates" -- shows DuplicateResolver

Use Tabs from shadcn/ui if installed, or simple button toggle.

Add "Review & Execute" button in the top bar that opens FinalReview dialog. Only enabled when at least 1 proposal is approved.

3. **Update src/app/analysis/page.tsx:**

The Server Component needs to:
- Call getProposals() to get all proposals
- Call getAnalysisSummary() to get summary stats
- Call checkStaleness() to get staleness info
- Fetch all playlists (for AddPlaylistSelector and CreateCategoryDialog)
- Call getLatestSession() to get current mode

Pass all data to AnalysisDashboard:
```typescript
<AnalysisDashboard
  proposals={proposals}
  summary={summary}
  staleness={staleness}
  allPlaylists={allPlaylists}
/>
```

Page layout:
1. Header: "Playlist Analysis & Consolidation" + subtitle
2. StalenessBanner (if stale)
3. If no proposals: AnalysisRunner (mode toggle + run button + loading states)
4. If proposals exist: AnalysisDashboard

The page also needs a "Re-analyze" button accessible even when proposals exist. Place it in the header bar.

Import AnalysisRunner from analysis-loading.tsx. Import StalenessBanner. Remove old components from Plan 02-03 that are now replaced (ConsolidationProposalTable, the old layout).

Keep DuplicateReport from Plan 02-03 but integrate it into the dashboard (it can be shown in the summary area or as a tab in the right panel).
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check integration points:
```bash
grep -E "(useBatchSelection|useCategoryKeyboardNav|ProgressTracker|FinalReview|StalenessBanner|AnalysisRunner|DuplicateResolver)" src/components/analysis/analysis-dashboard.tsx
```

Check page integration:
```bash
grep -E "(AnalysisDashboard|checkStaleness|getAnalysisSummary)" src/app/analysis/page.tsx
```

Check batch selection in category list:
```bash
grep "batchSelection" src/components/analysis/category-list.tsx
```

Start dev server and verify it compiles:
```bash
cd /Users/anthonygeorge/Projects/YouTubeOrg && npm run build 2>&1 | tail -5
```
Expected: Build succeeds or only has non-critical warnings.
  </verify>
  <done>
All components integrated: CategoryList has batch checkboxes and keyboard focus, AnalysisDashboard wires progress tracker, keyboard nav, batch operations, final review dialog, duplicate resolver tab, and staleness banner. Analysis page passes all server data and renders the complete workflow. Build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 2 analysis workflow with all CONTEXT.md features integrated:

1. Resizable split-panel layout with orientation toggle
2. Category list (left panel) with sort, search, status badges, batch checkboxes, keyboard navigation
3. Category detail (right panel) with metrics, paginated video list, confidence/validation badges, proposal actions
4. Duplicate resolver view with bulk resolution and "keep from most specific playlist" default
5. Split wizard (3-step guided dialog)
6. Manual adjustments (add/remove playlists, create custom category)
7. Batch operations (multi-select approve/reject)
8. Progress tracking (reviewed counter, progress bar)
9. Algorithm mode toggle (Conservative/Aggressive)
10. Staged loading states
11. Staleness detection
12. Final review screen with summary, change list, and impact visualization
13. Keyboard navigation (arrow keys, Enter)
  </what-built>
  <how-to-verify>
1. Ensure PostgreSQL container running: `docker ps | grep youtube-org-db`
2. Start dev server: `npm run dev`
3. Visit http://localhost:3000/analysis

**Test complete workflow:**

4. **Run Analysis:**
   - See algorithm mode toggle (Conservative/Aggressive)
   - Click "Run Analysis" (Aggressive mode)
   - See staged loading: "Detecting duplicates... (1/3)" -> "Clustering... (2/3)" -> "Generating... (3/3)"
   - Wait for proposals to appear

5. **Review layout:**
   - Split-panel with categories on left, detail on right
   - Click orientation toggle button to switch horizontal/vertical
   - Summary card shows stats at top
   - Progress tracker shows "Reviewed: 0/N categories"

6. **Category list:**
   - Default sort is alphabetical
   - Try sort options: video count, playlist count, confidence
   - Use search to filter by name
   - See status badges (all pending initially)
   - See confidence badges (HIGH/MEDIUM/LOW)
   - See "Review needed" section at bottom

7. **Keyboard navigation:**
   - Use arrow keys or j/k to move through categories
   - See focus indicator on current category
   - Press Enter to select

8. **Category detail:**
   - Click a category to see detail panel
   - See metrics: unique videos, source playlists, duplicates
   - See confidence badge with reasoning text
   - See validation badge with progress bar
   - Scroll video list with pagination (try 50, 100, 250, all)
   - Search videos by title
   - Filter by source playlist
   - Click video title to open YouTube in new tab

9. **Manual adjustments (on a pending proposal):**
   - Click "Add playlist" to add a playlist
   - Click X on a source playlist to remove it
   - Click "Split this proposal" to open split wizard
   - Walk through wizard: count -> name -> assign

10. **Batch operations:**
    - Check multiple category checkboxes
    - See floating toolbar: "N selected - Approve / Reject"
    - Click "Approve selected"

11. **Duplicate resolution:**
    - Switch to Duplicates tab/view
    - See duplicate list with source playlists
    - Note smart defaults (most specific playlist pre-selected)
    - Select multiple duplicates with checkboxes
    - Click "Apply resolution to selected"
    - See preview dialog, confirm

12. **Progress updates:**
    - After approving/rejecting, progress tracker updates
    - Status badges update on categories

13. **Final review:**
    - Click "Review & Execute"
    - See summary statistics
    - See detailed change list
    - See before/after impact
    - Click "Execute consolidation"
    - See success confirmation

14. **Edge cases:**
    - Open DevTools console - no React errors
    - Check terminal - no TypeScript errors
    - Test empty state (if possible)
    - Test with categories near 4,500 limit (button should warn/disable)

**Note:** Full verification depends on having playlists synced in database from Phase 1. If no playlist data, the analysis will produce empty results. Focus on verifying the UI renders and interactions work correctly.
  </how-to-verify>
  <resume-signal>
Type "approved" if the complete analysis workflow works end-to-end, or describe issues with specific components.
  </resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:

1. **TypeScript compilation clean:** `npx tsc --noEmit`
2. **Build succeeds:** `npm run build` completes
3. **All components integrated:** Dashboard uses all Plan 02-05 through 02-11 components
4. **Final review screen:** Shows summary, changes, impact, execute button
5. **Keyboard navigation works:** Arrow keys navigate, Enter selects
6. **Batch operations work:** Multi-select + batch approve/reject
7. **Split wizard works:** 3-step dialog creates new proposals
8. **Progress tracking updates:** Counter reflects reviewed state
9. **Human verification passed:** Complete workflow confirmed

This completes Phase 2 implementation. The analysis page at /analysis delivers all CONTEXT.md features.
</verification>

<success_criteria>
Plan complete when:
- Final review screen displays all required sections
- "Execute consolidation" marks session as finalized
- All components integrated into cohesive dashboard
- Keyboard navigation works throughout
- Batch operations functional
- Progress tracking accurate
- Build succeeds
- User verifies complete end-to-end workflow
- Phase 2 success criteria achievable:
  1. User sees proposed category consolidation structure
  2. User sees overlap analysis with duplicate counts
  3. User can approve proposed consolidations
  4. User can manually adjust proposals
  5. System validates no category exceeds 4,500 videos
</success_criteria>

<output>
After completion, create `.planning/phases/02-playlist-analysis-and-consolidation/02-12-SUMMARY.md`
</output>
