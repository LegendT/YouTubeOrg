---
phase: 02-playlist-analysis-and-consolidation
plan: 05
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/lib/db/schema.ts
  - src/lib/analysis/clustering.ts
  - src/lib/analysis/similarity.ts
  - src/lib/analysis/confidence.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "System uses fast-dice-coefficient for string similarity (not unmaintained string-similarity)"
    - "System uses ml-hclust group(k) to produce exact target cluster count (no custom cutDendrogram)"
    - "System combines name similarity and video overlap into a single distance metric for clustering"
    - "System calculates confidence scores (0-100) with reasoning text for each proposed category"
    - "System supports Conservative and Aggressive algorithm mode presets"
    - "Analysis sessions are tracked in database for multi-session staleness detection"
  artifacts:
    - path: "src/lib/analysis/similarity.ts"
      provides: "Combined distance matrix computation using name similarity + video overlap"
      exports: ["buildDistanceMatrix", "ALGORITHM_PRESETS"]
      min_lines: 60
    - path: "src/lib/analysis/confidence.ts"
      provides: "Confidence score calculation with reasoning text"
      exports: ["calculateConfidence"]
      min_lines: 30
    - path: "src/lib/analysis/clustering.ts"
      provides: "Updated clustering using fast-dice-coefficient and group(k)"
      exports: ["clusterPlaylists", "generateCategoryName"]
      min_lines: 80
    - path: "src/lib/db/schema.ts"
      provides: "analysisSessions table, algorithmModeEnum, enhanced consolidationProposals with confidenceScore/confidenceReason/sessionId"
      contains: "analysisSessions"
      min_lines: 120
  key_links:
    - from: "src/lib/analysis/similarity.ts"
      to: "fast-dice-coefficient"
      via: "similarity function import"
      pattern: "import.*from.*fast-dice-coefficient"
    - from: "src/lib/analysis/clustering.ts"
      to: "src/lib/analysis/similarity.ts"
      via: "buildDistanceMatrix for clustering input"
      pattern: "buildDistanceMatrix"
    - from: "src/lib/analysis/clustering.ts"
      to: "ml-hclust"
      via: "agnes + group(k)"
      pattern: "tree\\.group\\("
    - from: "src/lib/db/schema.ts"
      to: "analysisSessions"
      via: "sessionId foreign key on consolidationProposals"
      pattern: "references.*analysisSessions"
---

<objective>
Fix outdated library choices in Plan 02-01 and add backend analysis enhancements specified in CONTEXT.md and RESEARCH.md: fast-dice-coefficient instead of string-similarity, ml-hclust group(k) instead of custom cutDendrogram, combined distance matrix (name + video overlap), confidence score calculation, algorithm mode presets, and analysisSessions table for staleness detection.

Purpose: The original Plan 02-01 used unmaintained string-similarity and had a TODO for cutDendrogram. RESEARCH.md identified fast-dice-coefficient and group(k) as correct replacements. CONTEXT.md requires confidence badges, algorithm modes, and multi-session staleness detection -- all requiring backend support.

Output: Updated clustering algorithm with correct libraries, new similarity/confidence modules, enhanced database schema with analysisSessions table and enriched consolidationProposals columns.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-RESEARCH.md
@.planning/phases/02-playlist-analysis-and-consolidation/02-CONTEXT.md
@src/lib/db/schema.ts
@src/lib/analysis/clustering.ts
@src/lib/analysis/duplicates.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install correct libraries and extend database schema</name>
  <files>package.json, src/lib/db/schema.ts</files>
  <action>
1. Install fast-dice-coefficient (replacing string-similarity):
```bash
npm install fast-dice-coefficient
npm uninstall string-similarity @types/string-similarity 2>/dev/null
```

2. Extend src/lib/db/schema.ts with these additions (do NOT remove existing tables, ADD alongside them):

a. **algorithmModeEnum** - pgEnum with values ['conservative', 'aggressive']

b. **analysisSessions** table (for multi-session staleness detection per CONTEXT.md):
   - id: serial primary key
   - mode: algorithmModeEnum, not null, default 'aggressive'
   - playlistCount: integer, not null
   - proposalCount: integer, not null, default 0
   - duplicateCount: integer, not null, default 0
   - createdAt: timestamp, not null, defaultNow()
   - playlistDataTimestamp: timestamp, not null (when playlist data was last synced - used for staleness detection)

c. **Modify consolidationProposals** table to add new columns:
   - sessionId: integer, references analysisSessions.id (nullable for backward compatibility with Plan 02-01)
   - confidenceScore: integer (0-100, nullable initially)
   - confidenceReason: text (nullable)
   - uniqueVideoCount: integer (nullable - replaces totalVideos semantically as the deduplicated count)
   - duplicateVideoCount: integer (nullable - how many dupes were found within this proposal's playlists)
   - updatedAt: timestamp, not null, defaultNow()

d. **Modify duplicateVideos** table (or create duplicateRecords if Plan 02-01 uses different name):
   - Add: resolvedPlaylistId: integer (nullable, which playlist "wins" for this duplicate)
   - Add: sessionId: integer, references analysisSessions.id (nullable for backward compat)

IMPORTANT: Plan 02-01 creates the initial consolidationProposals and duplicateVideos tables. This plan ADDS columns. If Plan 02-01 has already been executed, new columns must be nullable or have defaults. If Plan 02-01 has NOT been executed, merge the additions directly into the table definitions.

Check whether Plan 02-01 has been executed by looking at existing schema.ts content. If consolidationProposals already exists in the file, add the new columns to it. If it does not exist, create the full definition including both the original and new columns.

After schema changes: `npx drizzle-kit push` to apply to database.

3. Push schema:
```bash
docker ps | grep youtube-org-db || docker start youtube-org-db
npx drizzle-kit push
```
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check schema has new elements:
```bash
grep -E "(analysisSessions|algorithmModeEnum|confidenceScore|sessionId|resolvedPlaylistId)" src/lib/db/schema.ts
```
Expected: All new table/column names present.

Check fast-dice-coefficient installed:
```bash
grep "fast-dice-coefficient" package.json
```

Check string-similarity removed:
```bash
grep "string-similarity" package.json || echo "REMOVED (good)"
```

Verify database tables:
```bash
docker exec youtube-org-db psql -U postgres -d youtube_organizer -c "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' ORDER BY table_name;"
```
Expected: analysis_sessions table present.
  </verify>
  <done>
fast-dice-coefficient installed, string-similarity removed. analysisSessions table and algorithmModeEnum exist in schema. consolidationProposals has confidenceScore, confidenceReason, sessionId, uniqueVideoCount, duplicateVideoCount, updatedAt columns. duplicateVideos/duplicateRecords has resolvedPlaylistId and sessionId. Database pushed successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create similarity module and update clustering to use fast-dice-coefficient + group(k)</name>
  <files>src/lib/analysis/similarity.ts, src/lib/analysis/confidence.ts, src/lib/analysis/clustering.ts</files>
  <action>
1. **Create src/lib/analysis/similarity.ts** - Combined distance matrix:

```typescript
import { similarity } from 'fast-dice-coefficient'
import { db } from '@/lib/db'
import { playlistVideos } from '@/lib/db/schema'
import { sql } from 'drizzle-orm'

export const ALGORITHM_PRESETS = {
  aggressive: { targetClusters: 25, nameWeight: 0.6, overlapWeight: 0.4 },
  conservative: { targetClusters: 35, nameWeight: 0.8, overlapWeight: 0.2 },
} as const

export type AlgorithmMode = keyof typeof ALGORITHM_PRESETS

interface PlaylistForClustering {
  id: number
  title: string
  itemCount: number
}

/**
 * Build combined distance matrix using name similarity + video overlap.
 * distance = nameWeight * (1 - nameSim) + overlapWeight * (1 - videoOverlap)
 */
export async function buildDistanceMatrix(
  playlists: PlaylistForClustering[],
  mode: AlgorithmMode = 'aggressive'
): Promise<{ distances: number[][]; nameSimilarities: number[][]; videoOverlaps: number[][] }> {
  const { nameWeight, overlapWeight } = ALGORITHM_PRESETS[mode]
  const n = playlists.length
  const titles = playlists.map(p => p.title.toLowerCase())

  // Name similarity matrix using fast-dice-coefficient
  const nameSimilarities: number[][] = Array.from({ length: n }, () => Array(n).fill(0))
  for (let i = 0; i < n; i++) {
    nameSimilarities[i][i] = 1
    for (let j = i + 1; j < n; j++) {
      const sim = similarity(titles[i], titles[j])
      nameSimilarities[i][j] = sim
      nameSimilarities[j][i] = sim
    }
  }

  // Video overlap matrix: for each pair, count shared videos / total unique videos
  const videoOverlaps: number[][] = Array.from({ length: n }, () => Array(n).fill(0))
  // Pre-fetch video sets for each playlist
  const videoSets: Map<number, Set<number>> = new Map()
  for (const p of playlists) {
    const rows = await db
      .select({ videoId: playlistVideos.videoId })
      .from(playlistVideos)
      .where(sql`${playlistVideos.playlistId} = ${p.id}`)
    videoSets.set(p.id, new Set(rows.map(r => r.videoId)))
  }

  for (let i = 0; i < n; i++) {
    videoOverlaps[i][i] = 1
    const setI = videoSets.get(playlists[i].id) || new Set()
    for (let j = i + 1; j < n; j++) {
      const setJ = videoSets.get(playlists[j].id) || new Set()
      // Jaccard-like overlap: intersection / union
      let intersection = 0
      for (const vid of setI) {
        if (setJ.has(vid)) intersection++
      }
      const union = setI.size + setJ.size - intersection
      const overlap = union > 0 ? intersection / union : 0
      videoOverlaps[i][j] = overlap
      videoOverlaps[j][i] = overlap
    }
  }

  // Combined distance matrix
  const distances: number[][] = Array.from({ length: n }, () => Array(n).fill(0))
  for (let i = 0; i < n; i++) {
    for (let j = i + 1; j < n; j++) {
      const dist = nameWeight * (1 - nameSimilarities[i][j]) + overlapWeight * (1 - videoOverlaps[i][j])
      distances[i][j] = dist
      distances[j][i] = dist
    }
  }

  return { distances, nameSimilarities, videoOverlaps }
}
```

Key: Uses fast-dice-coefficient (not string-similarity). Combines name similarity and video overlap with configurable weights per algorithm mode. Returns raw matrices for confidence calculation.

2. **Create src/lib/analysis/confidence.ts** - Confidence score calculation:

```typescript
import { similarity } from 'fast-dice-coefficient'

/**
 * Calculate confidence score for a cluster based on pairwise name similarity + video overlap.
 * Returns score (0-100) and human-readable reasoning.
 */
export function calculateConfidence(
  clusterTitles: string[],
  videoOverlapPercent: number
): { score: number; level: 'HIGH' | 'MEDIUM' | 'LOW'; reason: string } {
  if (clusterTitles.length === 1) {
    return { score: 100, level: 'HIGH', reason: 'Single playlist, no merge needed' }
  }

  // Average pairwise name similarity within cluster
  let totalSim = 0
  let pairs = 0
  for (let i = 0; i < clusterTitles.length; i++) {
    for (let j = i + 1; j < clusterTitles.length; j++) {
      totalSim += similarity(clusterTitles[i].toLowerCase(), clusterTitles[j].toLowerCase())
      pairs++
    }
  }
  const avgNameSim = pairs > 0 ? totalSim / pairs : 1

  // Combined score: 60% name similarity, 40% video overlap
  const score = Math.round((avgNameSim * 0.6 + (videoOverlapPercent / 100) * 0.4) * 100)
  const level = score >= 70 ? 'HIGH' : score >= 40 ? 'MEDIUM' : 'LOW'
  const reason = `Name similarity: ${Math.round(avgNameSim * 100)}%, Video overlap: ${videoOverlapPercent}%`

  return { score, level, reason }
}
```

3. **Update src/lib/analysis/clustering.ts** to use new modules:

Replace the entire file content. Key changes:
- Import `buildDistanceMatrix` and `AlgorithmMode` from `./similarity`
- Import `calculateConfidence` from `./confidence`
- Remove `string-similarity` import, replace with `fast-dice-coefficient` via similarity module
- Remove `cutDendrogram` TODO, use `tree.group(targetClusters)` from ml-hclust
- `clusterPlaylists` now accepts `mode: AlgorithmMode` parameter
- Returns enriched results including confidence score/level/reason per cluster
- `generateCategoryName` uses STOPWORDS filtering and prefers longest descriptive name (per RESEARCH.md heuristic)

The function signature becomes:
```typescript
export async function clusterPlaylists(
  mode: AlgorithmMode = 'aggressive'
): Promise<Array<{
  categoryName: string
  playlists: Array<{ id: number; title: string }>
  totalVideos: number
  confidence: { score: number; level: 'HIGH' | 'MEDIUM' | 'LOW'; reason: string }
}>>
```

Implementation:
- Fetch playlists from DB (exclude Watch Later per RESEARCH.md open question 3)
- Call buildDistanceMatrix(playlists, mode)
- Call agnes(distances, { method: 'average' }) from ml-hclust
- Call tree.group(ALGORITHM_PRESETS[mode].targetClusters) to get clusters
- For each cluster: extract indices, map to playlists, call generateCategoryName, calculate video overlap percent, call calculateConfidence
- Sort by totalVideos descending
- Return enriched array

For Watch Later exclusion: filter playlists where title !== 'Watch Later' (or youtubeId === 'WL') before clustering.
  </action>
  <verify>
Run: `npx tsc --noEmit`

Check new files exist:
```bash
ls src/lib/analysis/similarity.ts src/lib/analysis/confidence.ts
```

Check clustering uses new modules:
```bash
grep -E "(buildDistanceMatrix|calculateConfidence|fast-dice-coefficient)" src/lib/analysis/clustering.ts
```

Check group(k) used instead of cutDendrogram:
```bash
grep "group(" src/lib/analysis/clustering.ts
grep "cutDendrogram" src/lib/analysis/clustering.ts || echo "cutDendrogram removed (good)"
```

Check string-similarity no longer imported:
```bash
grep "string-similarity" src/lib/analysis/clustering.ts || echo "string-similarity removed (good)"
```
  </verify>
  <done>
similarity.ts exports buildDistanceMatrix and ALGORITHM_PRESETS with Conservative/Aggressive modes. confidence.ts exports calculateConfidence returning score/level/reason. clustering.ts updated to use fast-dice-coefficient via similarity module, ml-hclust group(k) for exact cluster count, and returns enriched results with confidence data. string-similarity fully removed from clustering. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **TypeScript compilation clean:** `npx tsc --noEmit` returns no errors
2. **Correct library:** `grep "fast-dice-coefficient" package.json` shows installed
3. **Old library removed:** `grep "string-similarity" package.json` shows nothing (or only in devDependencies types if leftover)
4. **New files exist:** ls src/lib/analysis/ shows similarity.ts, confidence.ts alongside existing files
5. **Schema extended:** grep "analysisSessions" src/lib/db/schema.ts returns match
6. **Database updated:** analysis_sessions table exists in PostgreSQL
7. **group(k) used:** grep "group(" src/lib/analysis/clustering.ts returns match
8. **No cutDendrogram:** grep "cutDendrogram" src/lib/analysis/clustering.ts returns nothing

This plan fixes the foundation. Plan 02-06 builds server actions on top of this enhanced backend.
</verification>

<success_criteria>
Plan complete when:
- fast-dice-coefficient installed, string-similarity removed
- analysisSessions table in schema with algorithmModeEnum
- consolidationProposals has confidenceScore, confidenceReason, sessionId, updatedAt columns
- similarity.ts builds combined distance matrix (name + video overlap)
- confidence.ts calculates score/level/reason
- clustering.ts uses group(k) and returns enriched results with confidence
- Algorithm presets (aggressive: 25 clusters, conservative: 35 clusters) defined
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-playlist-analysis-and-consolidation/02-05-SUMMARY.md`
</output>
