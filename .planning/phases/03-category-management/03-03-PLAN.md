---
phase: 03-category-management
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/lib/categories/undo-stack.ts
  - src/components/analysis/undo-banner.tsx
  - src/components/analysis/rename-category-dialog.tsx
  - src/components/analysis/delete-category-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Undo stack hook stores undo entries in memory with 30s TTL"
    - "Undo banner appears when undo entries exist, with Cmd/Ctrl+Z shortcut"
    - "User can rename a category via a dialog with name validation"
    - "User can delete a category with confirmation showing orphan count"
    - "Protected categories cannot be renamed or deleted (buttons disabled)"
  artifacts:
    - path: "src/lib/categories/undo-stack.ts"
      provides: "useUndoStack hook with push, undo, auto-expire"
      exports: ["useUndoStack", "UndoEntry"]
    - path: "src/components/analysis/undo-banner.tsx"
      provides: "Floating undo notification banner"
      exports: ["UndoBanner"]
    - path: "src/components/analysis/rename-category-dialog.tsx"
      provides: "Rename dialog with name input and validation"
      exports: ["RenameCategoryDialog"]
    - path: "src/components/analysis/delete-category-dialog.tsx"
      provides: "Delete confirmation dialog with orphan info"
      exports: ["DeleteCategoryDialog"]
  key_links:
    - from: "src/components/analysis/rename-category-dialog.tsx"
      to: "src/app/actions/categories.ts"
      via: "calls renameCategory server action"
      pattern: "renameCategory"
    - from: "src/components/analysis/delete-category-dialog.tsx"
      to: "src/app/actions/categories.ts"
      via: "calls deleteCategory server action"
      pattern: "deleteCategory"
    - from: "src/components/analysis/undo-banner.tsx"
      to: "src/lib/categories/undo-stack.ts"
      via: "receives undo stack state as props"
      pattern: "canUndo|undoAction"
---

<objective>
Build the undo stack infrastructure and the rename/delete dialog components. These are the foundational UI pieces that Plan 04 (merge) and Plan 06 (integration) will wire into the dashboard.

Purpose: Rename and delete are the most common management operations. The undo stack is critical safety infrastructure that must exist before any destructive operations are exposed in the UI.

Output: useUndoStack hook, UndoBanner component, RenameCategoryDialog, DeleteCategoryDialog -- all standalone, ready to be composed into the dashboard.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-category-management/03-CONTEXT.md
@.planning/phases/03-category-management/03-RESEARCH.md
@.planning/phases/03-category-management/03-02-SUMMARY.md

@src/components/analysis/manual-adjustments.tsx
@src/components/ui/dialog.tsx
@src/types/categories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useUndoStack hook and UndoBanner component</name>
  <files>
    src/lib/categories/undo-stack.ts
    src/components/analysis/undo-banner.tsx
  </files>
  <action>
**`src/lib/categories/undo-stack.ts`** -- Create the `useUndoStack` custom hook:

```
'use client'
```

Define an `UndoEntry` interface:
- `id`: string (crypto.randomUUID())
- `type`: 'delete' | 'merge'
- `label`: string (e.g., "Deleted 'JavaScript'" or "Merged 3 categories into 'Web Dev'")
- `undoAction`: `() => Promise<{ success: boolean; error?: string }>` -- the server action call to reverse
- `timestamp`: number (Date.now())

Implement `useUndoStack(maxSize = 10, ttlMs = 30_000)`:
- State: `useState<UndoEntry[]>([])`
- `push(entry)`: Prepend to array, slice to maxSize.
- `undo()`: Pop the first entry, call its `undoAction`, return the result. Remove from stack.
- Auto-expire: `useEffect` with `setInterval` every 5000ms, filter entries where `Date.now() - timestamp < ttlMs`.
- Return: `{ stack, push, undo, canUndo: stack.length > 0, latest: stack[0] ?? null, isUndoing }` where `isUndoing` is a boolean state set during undo execution.

IMPORTANT per RESEARCH pitfall #4: The `undoAction` stores a closure that calls the server action with serializable snapshot data. The snapshot data (category names, video IDs) is captured at push time. The server action reconstructs state from the snapshot. This avoids stale closure bugs.

**`src/components/analysis/undo-banner.tsx`** -- Create a floating notification:

```
'use client'
```

Props: `{ canUndo: boolean, latest: UndoEntry | null, onUndo: () => void, isUndoing: boolean }`

Render a fixed-position banner at the bottom-center of the viewport (z-40 to stay below dialogs at z-50):
- Only visible when `canUndo` is true.
- Shows: `latest.label` text + "Undo" button + countdown indicator (seconds remaining before expiry).
- "Undo" button calls `onUndo`, shows Loader2 spinner when `isUndoing`.
- Use `Undo2` icon from lucide-react.
- Styling: `fixed bottom-6 left-1/2 -translate-x-1/2 z-40` with rounded-lg, border, bg-background, shadow-lg, px-4 py-3.
- Animate in/out with CSS transition (opacity + transform).

Also add Cmd/Ctrl+Z keyboard shortcut support:
- Import `useHotkeys` from `react-hotkeys-hook`.
- Register `mod+z` hotkey that calls `onUndo` when `canUndo` is true.
- Only active when no dialog is open (check `document.querySelector('[role="dialog"]')` -- if dialog is open, don't trigger undo).
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm both files compile. Verify `useUndoStack` is exported from `src/lib/categories/undo-stack.ts` and `UndoBanner` is exported from `src/components/analysis/undo-banner.tsx`.
  </verify>
  <done>
useUndoStack hook handles push/undo/auto-expire with 30s TTL and max 10 entries. UndoBanner renders fixed-position notification with undo button, keyboard shortcut (Cmd/Ctrl+Z), and loading state. Both compile cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RenameCategoryDialog and DeleteCategoryDialog</name>
  <files>
    src/components/analysis/rename-category-dialog.tsx
    src/components/analysis/delete-category-dialog.tsx
  </files>
  <action>
**`src/components/analysis/rename-category-dialog.tsx`**:

Props: `{ categoryId: number, currentName: string, open: boolean, onOpenChange: (open: boolean) => void, onRenamed: () => void }`

Use the existing Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter from `@/components/ui/dialog`.

Implementation:
- State: `newName` (initialized to `currentName` when dialog opens), `error`, `isRenaming` (via useTransition or useState).
- On open change: reset `newName` to `currentName`, clear error.
- Name input: native HTML input with Tailwind styling (matching existing pattern from manual-adjustments.tsx -- `flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm`).
- Validation: non-empty after trim, max 150 chars. Show inline error text below input.
- Submit: call `renameCategory(categoryId, newName.trim())` from `@/app/actions/categories`. On success, call `onRenamed()` and close dialog. On error, show error message.
- Buttons: Cancel (outline) + Rename (primary, disabled while pending). Show Loader2 spinner during rename.
- Handle Enter key on input to submit.

**`src/components/analysis/delete-category-dialog.tsx`**:

Props: `{ categoryId: number, categoryName: string, videoCount: number, open: boolean, onOpenChange: (open: boolean) => void, onDeleted: (undoData: DeleteUndoData) => void }`

Use the same Dialog components.

Implementation:
- State: `isDeleting`, `error`.
- Show confirmation message: "Are you sure you want to delete '{categoryName}'?"
- If `videoCount > 0`: show warning text: "{videoCount} videos will be reassigned. Videos that exist in other categories will stay there. Truly orphaned videos will be moved to Uncategorized."
- If `videoCount === 0`: show simple text: "This empty category will be permanently removed."
- Buttons: Cancel (outline) + Delete (variant="destructive", shows Loader2 when deleting).
- On confirm: call `deleteCategory(categoryId)` from `@/app/actions/categories`. On success, call `onDeleted(result.undoData!)` with the undo data so the parent can push to the undo stack. Close dialog.
- On error: show error inline.

Both dialogs follow the exact same visual patterns as the existing dialogs in manual-adjustments.tsx (DialogContent max-w-md, same spacing, same button layout).
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm both dialog components compile. Verify exports: `RenameCategoryDialog` and `DeleteCategoryDialog`.
  </verify>
  <done>
RenameCategoryDialog validates name input, calls renameCategory server action, handles errors inline. DeleteCategoryDialog shows confirmation with video count warning, calls deleteCategory, passes undo data to parent via callback. Both follow existing dialog patterns and compile cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. useUndoStack handles push/undo/auto-expire correctly
3. UndoBanner renders with keyboard shortcut support
4. RenameCategoryDialog validates and submits rename
5. DeleteCategoryDialog shows orphan warning and returns undo data
6. All components follow existing codebase patterns (Dialog, Button, Loader2)
</verification>

<success_criteria>
- Undo infrastructure ready: hook + banner + keyboard shortcut
- Rename dialog validates and persists name changes
- Delete dialog confirms with orphan info and returns undo data
- All 4 new files compile with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-category-management/03-03-SUMMARY.md`
</output>
