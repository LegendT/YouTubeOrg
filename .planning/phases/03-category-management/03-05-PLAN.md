---
phase: 03-category-management
plan: 05
type: execute
wave: 4
depends_on: ["03-03", "03-04"]
files_modified:
  - src/app/analysis/page.tsx
  - src/components/analysis/analysis-dashboard.tsx
  - src/components/analysis/category-list.tsx
  - src/components/analysis/category-detail.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard switches to management mode after finalization"
    - "Category list shows categories (not proposals) with hover action buttons"
    - "Hover actions: rename (Pencil icon), delete (Trash2 icon), assign videos (Plus icon)"
    - "Protected categories (Uncategorized) have rename/delete actions disabled"
    - "Batch toolbar shows Merge button when 2+ categories are selected"
    - "Detail panel shows category info with management actions"
    - "Undo banner appears after delete/merge with Cmd/Ctrl+Z support"
  artifacts:
    - path: "src/app/analysis/page.tsx"
      provides: "Extended to load categories after finalization"
      contains: "getCategories"
    - path: "src/components/analysis/analysis-dashboard.tsx"
      provides: "Management mode with undo stack, rename/delete/merge/assign wiring"
      contains: "useUndoStack"
    - path: "src/components/analysis/category-list.tsx"
      provides: "Hover action buttons for rename/delete/assign"
      contains: "Pencil|Trash2"
    - path: "src/components/analysis/category-detail.tsx"
      provides: "Management actions layered on detail panel"
      contains: "RenameCategoryDialog|DeleteCategoryDialog|VideoAssignmentDialog"
  key_links:
    - from: "src/app/analysis/page.tsx"
      to: "src/app/actions/categories.ts"
      via: "calls getCategories to load management data"
      pattern: "getCategories"
    - from: "src/components/analysis/analysis-dashboard.tsx"
      to: "src/lib/categories/undo-stack.ts"
      via: "uses useUndoStack hook"
      pattern: "useUndoStack"
    - from: "src/components/analysis/analysis-dashboard.tsx"
      to: "src/components/analysis/merge-categories-dialog.tsx"
      via: "renders MergeCategoriesDialog on batch merge"
      pattern: "MergeCategoriesDialog"
    - from: "src/components/analysis/category-list.tsx"
      to: "src/components/analysis/rename-category-dialog.tsx"
      via: "opens rename dialog from hover action"
      pattern: "RenameCategoryDialog"
---

<objective>
Wire all Phase 3 components into the existing analysis dashboard. Extend the page, dashboard, category list, and category detail to support a management mode that loads real categories (not proposals) and exposes all CRUD operations through the UI.

Purpose: This plan connects all the standalone components from Plans 03 and 04 into the existing dashboard, creating the complete management experience. The dashboard detects finalization and switches from analysis mode to management mode.

Output: Fully functional category management UI integrated into the existing /analysis page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-category-management/03-CONTEXT.md
@.planning/phases/03-category-management/03-03-SUMMARY.md
@.planning/phases/03-category-management/03-04-SUMMARY.md

@src/app/analysis/page.tsx
@src/components/analysis/analysis-dashboard.tsx
@src/components/analysis/category-list.tsx
@src/components/analysis/category-detail.tsx
@src/types/categories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend page.tsx and analysis-dashboard.tsx for management mode</name>
  <files>
    src/app/analysis/page.tsx
    src/components/analysis/analysis-dashboard.tsx
  </files>
  <action>
**`src/app/analysis/page.tsx`** -- Extend the Server Component to detect finalization and load categories:

1. Import `getCategories` from `@/app/actions/categories` and `getLatestSession` (already imported).
2. After the existing `Promise.all`, check if the session has `finalizedAt` set (non-null).
3. If finalized: also call `getCategories()` to load the category list.
4. Pass a new prop `managementMode: boolean` and `categories: CategoryListItem[]` to `AnalysisDashboard`.
5. When in management mode, the header text changes: "Category Management" instead of "Playlist Analysis & Consolidation", with subtitle "Manage your approved category structure".
6. Hide the RunAnalysisButton in management mode (analysis is done).

**`src/components/analysis/analysis-dashboard.tsx`** -- Add management mode with undo stack:

1. Import new components: `useUndoStack` from `@/lib/categories/undo-stack`, `UndoBanner` from `./undo-banner`, `RenameCategoryDialog` from `./rename-category-dialog`, `DeleteCategoryDialog` from `./delete-category-dialog`, `MergeCategoriesDialog` from `./merge-categories-dialog`, `VideoAssignmentDialog` from `./video-assignment-dialog`.
2. Import types: `CategoryListItem`, `DeleteUndoData`, `MergeUndoData` from `@/types/categories`.
3. Import server actions: `getCategories`, `getCategoryDetailManagement`, `undoDelete`, `undoMerge` from `@/app/actions/categories`.

4. Add new props to `AnalysisDashboardProps`:
   - `managementMode?: boolean`
   - `categories?: CategoryListItem[]`

5. Add state:
   - `const undoStack = useUndoStack()`
   - `managedCategories` state (initialized from `categories` prop)
   - `renameTarget` state: `{ id, name } | null` (which category is being renamed)
   - `deleteTarget` state: `{ id, name, videoCount } | null`
   - `mergeDialogOpen` state: boolean
   - `assignTarget` state: `{ id, name, videoCount } | null`

6. **When `managementMode` is true:**
   - Replace the data source: use `managedCategories` instead of `proposals` for the category list.
   - Map `CategoryListItem` to the shape the CategoryList component expects (or update CategoryList to accept both -- see Task 2).
   - The left panel category list gets hover action callbacks: `onRename`, `onDelete`, `onAssignVideos`.
   - The batch toolbar adds a "Merge" button when 2+ categories are selected.
   - The right panel detail tab calls `getCategoryDetailManagement` instead of `getCategoryDetail`.
   - Hide analysis-specific UI: ProgressTracker, StalenessBanner, FinalReview, "Review & Execute" button, CreateCategoryDialog (replaced by a simpler "New Category" button that calls createCategory).

7. **Undo wiring:**
   - After delete: `undoStack.push({ type: 'delete', label: \`Deleted "${name}"\`, undoAction: () => undoDelete(undoData) })`.
   - After merge: `undoStack.push({ type: 'merge', label: \`Merged ${count} categories into "${name}"\`, undoAction: () => undoMerge(undoData) })`.
   - After undo completes: `router.refresh()` to reload data.

8. **Refresh pattern:** After any CRUD operation (rename, delete, merge, assign, undo), call `router.refresh()` to re-fetch server data AND re-fetch `managedCategories` by calling `getCategories()`.

9. Render at the bottom (outside the panel layout):
   - `<RenameCategoryDialog>` (controlled by `renameTarget`)
   - `<DeleteCategoryDialog>` (controlled by `deleteTarget`)
   - `<MergeCategoriesDialog>` (controlled by `mergeDialogOpen`, passes selected categories from batchSelection)
   - `<VideoAssignmentDialog>` (controlled by `assignTarget`)
   - `<UndoBanner>` (always rendered, connected to undoStack)

Keep the existing analysis mode rendering completely intact -- management mode is an alternate branch based on the `managementMode` prop. The analysis mode code path should not change at all.
  </action>
  <verify>
Run `npx tsc --noEmit`. Start dev server (`npm run dev`) and verify `/analysis` loads without errors. If Phase 2 has been finalized, the management mode should activate.
  </verify>
  <done>
Analysis page detects finalization and loads categories. Dashboard switches to management mode with undo stack wiring, all dialog state management, and refresh-after-mutation pattern. Analysis mode remains untouched.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend CategoryList and CategoryDetail for management mode</name>
  <files>
    src/components/analysis/category-list.tsx
    src/components/analysis/category-detail.tsx
  </files>
  <action>
**`src/components/analysis/category-list.tsx`** -- Add hover action buttons for management mode:

1. Add new optional props to `CategoryListProps`:
   - `managementMode?: boolean`
   - `onRename?: (id: number, name: string) => void`
   - `onDelete?: (id: number, name: string, videoCount: number) => void`
   - `onAssignVideos?: (id: number, name: string, videoCount: number) => void`
   - `items?: CategoryListItem[]` (alternative data source to proposals)

2. When `managementMode` is true:
   - Use `items` instead of `proposals` as the data source.
   - Map `CategoryListItem` fields to the rendering: `item.name` -> category name, `item.videoCount` -> video count, `item.sourcePlaylistNames.length` -> playlist count.
   - Remove the "Review needed" section (not applicable to management mode).
   - Remove confidence score display (not applicable).
   - Replace status icons with simple category indicators.

3. **Hover action buttons:** For each category row in management mode, add a group of small icon buttons that appear on hover (`opacity-0 group-hover:opacity-100 transition-opacity`):
   - Pencil icon -> calls `onRename(id, name)` -- disabled if `isProtected`
   - Trash2 icon -> calls `onDelete(id, name, videoCount)` -- disabled if `isProtected`
   - Plus icon -> calls `onAssignVideos(id, name, videoCount)`
   - Each button: `h-7 w-7 p-0` size, ghost variant, with title tooltip.
   - Add `group` class to the row container to enable group-hover.

4. For the "Uncategorized" category (isProtected): show it at the bottom of the list, with a subtle muted style, and disabled rename/delete buttons (but still allow assign videos).

5. Keep ALL existing analysis mode rendering intact. The `managementMode` prop conditionally switches behavior.

**`src/components/analysis/category-detail.tsx`** -- Add management actions in detail panel:

1. Add new optional props:
   - `managementMode?: boolean`
   - `category?: CategoryListItem` (alternative to `proposal` when in management mode)
   - `managementVideos?: VideoSearchResult[]` (videos from getCategoryDetailManagement)
   - `onRename?: (id: number, name: string) => void`
   - `onDelete?: (id: number, name: string, videoCount: number) => void`
   - `onAssignVideos?: (id: number, name: string, videoCount: number) => void`

2. When `managementMode` is true:
   - Show category name as heading (same as before).
   - Replace confidence/validation badges with a simple metrics card: video count, source playlists count, last updated date.
   - Show management action buttons in a toolbar below the heading:
     - "Rename" button (Pencil icon) -> calls `onRename`
     - "Delete" button (Trash2 icon, destructive variant) -> calls `onDelete`
     - "Assign Videos" button (Plus icon) -> calls `onAssignVideos`
     - All disabled if `isProtected` (except Assign Videos).
   - Render the video list using the existing `VideoListPaginated` component, mapping `VideoSearchResult` to `VideoDetail` format.
   - Remove: ManualAdjustments, SplitWizard, ProposalActions (these are analysis-mode only).

3. Keep ALL existing analysis mode rendering intact.
  </action>
  <verify>
Run `npx tsc --noEmit`. Start the dev server and navigate to `/analysis`. If in management mode: verify category list shows hover actions. If still in analysis mode: verify nothing has changed.
  </verify>
  <done>
CategoryList shows hover action buttons (rename/delete/assign) in management mode with disabled state for protected categories. CategoryDetail shows management toolbar with CRUD actions. Both components maintain full backward compatibility with analysis mode.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `/analysis` page loads without errors in both modes
3. Management mode: category list shows hover actions
4. Management mode: detail panel shows management actions
5. Management mode: batch toolbar includes Merge button
6. Management mode: undo banner appears after delete/merge
7. Analysis mode: no visual or functional changes
</verification>

<success_criteria>
- Dashboard detects finalization and activates management mode
- All CRUD operations accessible: rename, delete, merge (batch), assign videos, create
- Undo stack wired: delete and merge push entries, Cmd/Ctrl+Z triggers undo
- All dialogs open from correct triggers (hover buttons, batch toolbar, detail panel)
- Analysis mode preserved exactly as-is
</success_criteria>

<output>
After completion, create `.planning/phases/03-category-management/03-05-SUMMARY.md`
</output>
