---
phase: 03-category-management
plan: 06
type: execute
wave: 5
depends_on: ["03-05"]
files_modified:
  - src/components/analysis/analysis-dashboard.tsx
  - src/components/analysis/category-list.tsx
autonomous: false

must_haves:
  truths:
    - "User can view all categories with video counts on the management dashboard"
    - "User can create a new category from the toolbar"
    - "User can rename a category via the rename dialog"
    - "User can delete a category and see orphaned videos go to Uncategorized"
    - "User can merge 2+ categories via batch selection and see combined result"
    - "User can undo a delete or merge within 30 seconds"
    - "User can assign videos to a category via the full-screen dialog"
  artifacts:
    - path: "src/components/analysis/analysis-dashboard.tsx"
      provides: "Complete management dashboard with all CRUD wired"
    - path: "src/components/analysis/category-list.tsx"
      provides: "Category list with management actions"
  key_links:
    - from: "src/components/analysis/analysis-dashboard.tsx"
      to: "src/app/actions/categories.ts"
      via: "all CRUD operations flow through server actions"
      pattern: "createCategory|renameCategory|deleteCategory|mergeCategories|assignVideosToCategory"
---

<objective>
Final polish and end-to-end verification of the complete Phase 3 category management flow. Fix any integration issues, add the "New Category" button for management mode, and verify all 5 success criteria through manual testing.

Purpose: Plans 01-05 built the data layer, server actions, UI components, and wiring. This plan ensures everything works together end-to-end and addresses any gaps found during integration.

Output: Fully working category management system verified against all Phase 3 success criteria.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-category-management/03-CONTEXT.md
@.planning/phases/03-category-management/03-05-SUMMARY.md

@src/app/analysis/page.tsx
@src/components/analysis/analysis-dashboard.tsx
@src/components/analysis/category-list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add management mode "New Category" button and polish integration</name>
  <files>
    src/components/analysis/analysis-dashboard.tsx
    src/components/analysis/category-list.tsx
  </files>
  <action>
Address integration gaps and add missing pieces:

1. **"New Category" button in management mode toolbar** (per CONTEXT.md: "'New Category' button in the category list toolbar only -- single entry point for creation"):
   - In the dashboard management mode toolbar area, replace the Phase 2 `CreateCategoryDialog` with a simpler "New Category" button.
   - This button opens a small dialog (reuse Dialog component) with just a name input.
   - On submit, calls `createCategory(name)` from `@/app/actions/categories`.
   - After success, refreshes the category list.
   - Position: in the toolbar row alongside the layout toggle button.

2. **Batch merge button in toolbar:**
   - When `managementMode` and `batchSelection.selectedIds.size >= 2`, show a "Merge" button (GitMerge icon from lucide-react) in the batch toolbar.
   - Clicking opens the MergeCategoriesDialog with the selected categories.
   - After merge completes: clear batch selection, push undo entry, refresh.

3. **Fix any type mismatches** between CategoryListItem and the existing component props that expect ConsolidationProposal. Ensure smooth data flow from getCategories -> dashboard -> CategoryList -> CategoryDetail.

4. **Ensure "New Category" creates an empty category** (with videoCount 0) that immediately appears in the list. The user can then assign videos to it via the VideoAssignmentDialog.

5. **Management mode detail panel data loading:**
   - When a category is selected in management mode, call `getCategoryDetailManagement(categoryId)` instead of `getCategoryDetail(proposalId)`.
   - Wire the response into the CategoryDetail component's management mode props.

6. **Run `npx tsc --noEmit`** and fix any remaining type errors across all Phase 3 files.

7. **Start dev server** and fix any runtime errors visible in the browser console or terminal.
  </action>
  <verify>
Run `npx tsc --noEmit` (zero errors). Run `npm run dev` and open `/analysis` in the browser -- no console errors, page loads correctly.
  </verify>
  <done>
Management mode has working "New Category" button, merge button in batch toolbar, correct data loading for detail panel. All TypeScript errors resolved. Dev server runs without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 3 Category Management system: new database tables (categories, category_videos), 10 server actions, undo stack, rename/delete/merge/video-assignment dialogs, management mode dashboard.</what-built>
  <how-to-verify>
    Open http://localhost:3001/analysis (or the port your dev server uses).

    **Pre-requisite:** Phase 2 must be finalized. If you haven't finalized yet, click "Review & Execute" in analysis mode first. Then the migration script must be run: `DATABASE_URL=... npx tsx scripts/migrate-proposals-to-categories.ts`. Refresh the page -- you should see "Category Management" mode.

    **Test 1 - View categories:**
    1. The page should show "Category Management" heading
    2. Category list on the left should show all your approved categories with video counts
    3. "Uncategorized" should appear at the bottom (if it has 0 videos it may just be there with "0 videos")

    **Test 2 - Create category:**
    1. Click "New Category" button in the toolbar
    2. Type a name like "Test Category"
    3. Click Create -- it should appear in the list with 0 videos

    **Test 3 - Rename category:**
    1. Hover over the "Test Category" you just created
    2. Click the pencil (rename) icon
    3. Change the name to "Renamed Test"
    4. Click Rename -- the name should update in the list

    **Test 4 - Delete category:**
    1. Hover over "Renamed Test"
    2. Click the trash (delete) icon
    3. Confirm in the dialog
    4. Category should disappear. An undo banner should appear at the bottom.
    5. Click "Undo" (or press Cmd/Ctrl+Z) -- the category should reappear
    6. Delete it again (let the undo expire this time)

    **Test 5 - Merge categories:**
    1. Select 2+ categories using the checkboxes
    2. Click "Merge" in the batch toolbar
    3. Confirm the merged name
    4. Click Merge -- the source categories should disappear, replaced by one merged category
    5. The undo banner should appear
    6. (Optionally) click Undo to reverse the merge

    **Test 6 - Assign videos (if time permits):**
    1. Click a category to select it
    2. In the detail panel, click "Assign Videos"
    3. The full-screen dialog should open
    4. Search for a video or browse by source category
    5. Select some videos and click Assign

    Report any issues you encounter.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 3 Success Criteria from ROADMAP.md:
1. User can view all categories with video counts -- verified in Test 1
2. User can create new category and assign videos to it -- verified in Tests 2 + 6
3. User can rename existing category -- verified in Test 3
4. User can delete empty category -- verified in Test 4
5. User can manually merge two categories and see combined video count -- verified in Test 5
</verification>

<success_criteria>
All 5 Phase 3 success criteria pass. Management mode is stable. Undo works for delete and merge. No console errors. TypeScript compiles cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/03-category-management/03-06-SUMMARY.md`
</output>
