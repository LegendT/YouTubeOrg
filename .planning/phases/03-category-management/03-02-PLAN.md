---
phase: 03-category-management
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/actions/categories.ts
autonomous: true

must_haves:
  truths:
    - "Server actions exist for all CRUD operations: list, create, rename, delete, merge"
    - "Delete returns undo data with category name and video IDs"
    - "Merge returns undo data with original category structure"
    - "Orphaned videos are moved to Uncategorized on delete"
    - "Merge deduplicates shared videos within a transaction"
    - "Protected categories (Uncategorized) cannot be renamed or deleted"
  artifacts:
    - path: "src/app/actions/categories.ts"
      provides: "All Phase 3 CRUD server actions"
      exports: ["getCategories", "createCategory", "renameCategory", "deleteCategory", "mergeCategories", "undoDelete", "undoMerge", "searchVideosForAssignment", "assignVideosToCategory", "getCategoryDetailManagement"]
  key_links:
    - from: "src/app/actions/categories.ts"
      to: "src/lib/db/schema.ts"
      via: "imports categories, categoryVideos tables"
      pattern: "import.*categories.*categoryVideos.*from"
    - from: "src/app/actions/categories.ts"
      to: "src/types/categories.ts"
      via: "imports result types"
      pattern: "import.*DeleteUndoData.*MergeUndoData.*from"
---

<objective>
Create all Phase 3 CRUD server actions in a single `categories.ts` file: list categories, create, rename, delete (with orphan handling + undo data), merge (transactional with dedup + undo data), undo operations, video search, and video assignment.

Purpose: These server actions are the complete backend for Phase 3. Every UI component in subsequent plans calls these actions. Following the established pattern from Phase 2's `analysis.ts` (18 server actions in one file).

Output: `src/app/actions/categories.ts` with all CRUD + undo + video assignment server actions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-category-management/03-CONTEXT.md
@.planning/phases/03-category-management/03-RESEARCH.md
@.planning/phases/03-category-management/03-01-SUMMARY.md

@src/app/actions/analysis.ts
@src/lib/db/schema.ts
@src/types/categories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Core CRUD server actions (list, create, rename, delete with undo)</name>
  <files>src/app/actions/categories.ts</files>
  <action>
Create `src/app/actions/categories.ts` with `'use server'` directive. Import from `@/lib/db`, `@/lib/db/schema`, `drizzle-orm` operators, `revalidatePath`, and `@/types/categories`.

Implement these server actions:

**1. `getCategories()`** -- Returns all categories sorted by name, with Uncategorized at the bottom.
- Query `categories` table, select all fields.
- Sort: non-protected alphabetically first, then protected (Uncategorized last).
- Return `CategoryListItem[]` with `sourcePlaylistNames` derived by joining through `sourceProposalId` -> `consolidationProposals.sourcePlaylistIds` -> `playlists.title` (or empty array if no sourceProposalId).
- Wrap count values with `Number()` (PostgreSQL bigint returns strings).

**2. `createCategory(name: string)`** -- Creates a new empty category.
- Validate: name must be non-empty after trim, max 150 chars.
- Check for duplicate name (case-insensitive) -- return error if exists.
- Insert into `categories` with `videoCount: 0`, `isProtected: false`.
- `revalidatePath('/analysis')`.
- Return `CategoryActionResult`.

**3. `renameCategory(categoryId: number, newName: string)`** -- Renames a category.
- Validate: newName non-empty after trim, max 150 chars.
- Check: category exists. Check: category is NOT protected (isProtected = true means cannot rename). Return error if protected.
- Check for duplicate name (case-insensitive, excluding self).
- Update `name` and `updatedAt`.
- `revalidatePath('/analysis')`.
- Return `CategoryActionResult`.

**4. `deleteCategory(categoryId: number)`** -- Deletes a category, handles orphans, returns undo data.
- Check: category exists. Check: NOT protected. Return error if protected.
- Wrap in `db.transaction()`:
  a. Get category info (name, isProtected).
  b. Get all videoIds from `categoryVideos` where `categoryId` matches.
  c. Delete the category (cascade deletes its categoryVideos rows).
  d. Find orphaned videos: query for videoIds that NO LONGER appear in ANY `categoryVideos` row.
  e. If orphans exist, find the Uncategorized category (`isProtected = true`), insert orphaned videoIds into `categoryVideos` with `source: 'orphan'`, update Uncategorized's `videoCount`.
  f. Return `DeleteCategoryResult` with `undoData: { type: 'delete', categoryName, categoryId, videoIds, wasProtected: false }` and `orphanedCount`.
- `revalidatePath('/analysis')`.

**5. `undoDelete(undoData: DeleteUndoData)`** -- Restores a deleted category.
- Wrap in `db.transaction()`:
  a. Re-create the category with the original name.
  b. Remove the videoIds from Uncategorized's `categoryVideos` (only those with `source: 'orphan'` and matching videoIds).
  c. Insert videoIds into the restored category's `categoryVideos` with `source: 'undo'`.
  d. Update both categories' `videoCount`.
- `revalidatePath('/analysis')`.
- Return `CategoryActionResult`.

Follow the existing error handling pattern: try/catch wrapping everything, returning `{ success: false, error: message }` on failure.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm all server actions compile. Check that the file has the `'use server'` directive at top.
  </verify>
  <done>
Five server actions exist and compile: getCategories, createCategory, renameCategory, deleteCategory (with transactional orphan handling + undo data), undoDelete (with transactional restoration). All follow the established `{ success, error? }` return pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Merge, undo-merge, video search, and video assignment server actions</name>
  <files>src/app/actions/categories.ts</files>
  <action>
Add these server actions to the SAME `src/app/actions/categories.ts` file:

**6. `mergeCategories(sourceCategoryIds: number[], targetName: string)`** -- Merges 2+ categories into one.
- Validate: at least 2 source IDs, targetName non-empty.
- Check: none of the source categories are protected. Return error if any are.
- Wrap in `db.transaction()`:
  a. Collect all videoIds from `categoryVideos` for the source categories.
  b. Deduplicate (a video in multiple source categories should appear once).
  c. Snapshot each source category's name and videoIds for undo data.
  d. Delete all source categories (cascade deletes their categoryVideos).
  e. Create new merged category with `name: targetName.trim()`.
  f. Batch insert deduplicated videoIds into `categoryVideos` with `source: 'merge'`.
  g. Set `videoCount` to deduplicated count.
- Return `MergeCategoriesResult` with `mergedCategoryId`, `totalVideos`, and `undoData: { type: 'merge', mergedCategoryId, originalCategories }`.
- `revalidatePath('/analysis')`.

**7. `undoMerge(undoData: MergeUndoData)`** -- Reverses a merge.
- Wrap in `db.transaction()`:
  a. Delete the merged category (cascade deletes its categoryVideos).
  b. For each original category in `undoData.originalCategories`: re-create with original name, re-insert videoIds, set videoCount.
- `revalidatePath('/analysis')`.
- Return `CategoryActionResult`.

**8. `searchVideosForAssignment(query: string, sourceCategoryId?: number, limit?: number, offset?: number)`** -- Searches videos for the assignment dialog.
- Default limit: 50, default offset: 0.
- If `query` is non-empty: filter videos by ILIKE on `title` OR `channelTitle`.
- If `sourceCategoryId` is provided: only return videos in that category (join through `categoryVideos`).
- For each video, include `categoryNames`: the names of all categories this video belongs to (subquery on `categoryVideos` joined to `categories`).
- Return `{ videos: VideoSearchResult[], total: number }`.
- Use `sql` template for the ILIKE query (not Drizzle operators which don't support ILIKE natively).

**9. `assignVideosToCategory(categoryId: number, videoIds: number[], mode: 'move' | 'copy', sourceCategoryId?: number)`** -- Assigns videos to a target category.
- Validate: categoryId exists, videoIds non-empty.
- Check YouTube 5,000 limit: current `videoCount` + new videos must not exceed 5000. Warn at 4500. Block at 5000.
- Wrap in `db.transaction()`:
  a. Filter out videoIds already in the target category (avoid duplicates using `ON CONFLICT`-style check or pre-filter).
  b. Insert new `categoryVideos` rows with `source: 'manual'`.
  c. If mode is 'move' AND `sourceCategoryId` is provided: delete those videoIds from the source category's `categoryVideos`.
  d. Update `videoCount` for target category (and source if move).
- `revalidatePath('/analysis')`.
- Return `CategoryActionResult`.

**10. `getCategoryDetailManagement(categoryId: number)`** -- Gets full category detail for the management view.
- Query category info from `categories`.
- Query videos via `categoryVideos` joined to `videos`, return `VideoSearchResult[]` with category names.
- Return `{ category: Category, videos: VideoSearchResult[], total: number }`.

All actions follow the same error handling pattern (try/catch, `{ success: false, error }` on failure).
  </action>
  <verify>
Run `npx tsc --noEmit` to verify all 10 server actions compile. Verify the file exports all functions listed in must_haves.
  </verify>
  <done>
All 10 server actions compile and are exported: getCategories, createCategory, renameCategory, deleteCategory, undoDelete, mergeCategories, undoMerge, searchVideosForAssignment, assignVideosToCategory, getCategoryDetailManagement. Merge and delete are transactional with undo data. Video assignment enforces the 5,000 limit.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `src/app/actions/categories.ts` has `'use server'` directive
3. All 10 server actions are exported
4. Delete and merge actions use `db.transaction()`
5. Delete handles orphans (moves to Uncategorized)
6. Merge deduplicates shared videos
7. Undo actions reverse delete and merge correctly
8. Video assignment enforces 5,000 video limit
</verification>

<success_criteria>
- Complete CRUD backend for Phase 3 in a single server actions file
- All mutations are transactional where needed
- Undo data returned from destructive operations (delete, merge)
- Protected category (Uncategorized) guard on rename/delete
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-category-management/03-02-SUMMARY.md`
</output>
