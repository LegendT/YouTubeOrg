---
phase: 03-category-management
plan: 04
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/components/analysis/merge-categories-dialog.tsx
  - src/components/analysis/video-assignment-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can merge 2+ selected categories into one via a preview dialog"
    - "Merge dialog shows combined video count (deduplicated) and category names being merged"
    - "User must type/confirm the merged category name before executing"
    - "User can assign videos to a category via a full-screen dialog with search and browse"
    - "Video assignment supports both move and copy modes"
    - "Video assignment blocks at 5,000 videos, warns at 4,500"
  artifacts:
    - path: "src/components/analysis/merge-categories-dialog.tsx"
      provides: "Merge preview + confirmation dialog"
      exports: ["MergeCategoriesDialog"]
    - path: "src/components/analysis/video-assignment-dialog.tsx"
      provides: "Full-screen video search/browse/assign dialog"
      exports: ["VideoAssignmentDialog"]
  key_links:
    - from: "src/components/analysis/merge-categories-dialog.tsx"
      to: "src/app/actions/categories.ts"
      via: "calls mergeCategories server action"
      pattern: "mergeCategories"
    - from: "src/components/analysis/video-assignment-dialog.tsx"
      to: "src/app/actions/categories.ts"
      via: "calls searchVideosForAssignment and assignVideosToCategory"
      pattern: "searchVideosForAssignment|assignVideosToCategory"
---

<objective>
Build the merge confirmation dialog and the full-screen video assignment dialog. These are the two most complex UI components in Phase 3, each in its own file with no shared file conflicts with Plan 03.

Purpose: Merge is the primary consolidation action (multi-select categories -> combine). Video assignment is the primary video management action (find videos -> assign to category). Both are user decisions locked in CONTEXT.md.

Output: MergeCategoriesDialog (modal with preview + name confirmation) and VideoAssignmentDialog (full-screen with search/browse/select/assign).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-category-management/03-CONTEXT.md
@.planning/phases/03-category-management/03-RESEARCH.md
@.planning/phases/03-category-management/03-02-SUMMARY.md

@src/components/ui/dialog.tsx
@src/components/analysis/manual-adjustments.tsx
@src/components/analysis/batch-operations.tsx
@src/types/categories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MergeCategoriesDialog</name>
  <files>src/components/analysis/merge-categories-dialog.tsx</files>
  <action>
Create `src/components/analysis/merge-categories-dialog.tsx` with `'use client'` directive.

Props:
```typescript
interface MergeCategoriesDialogProps {
  categories: Array<{ id: number; name: string; videoCount: number }>
  open: boolean
  onOpenChange: (open: boolean) => void
  onMerged: (undoData: MergeUndoData) => void
}
```

Implementation:
- Use Dialog, DialogContent (max-w-lg), DialogHeader, DialogTitle, DialogDescription, DialogFooter.
- State: `mergedName` (string, auto-suggested as the longest category name), `isMerging`, `error`.

**Content layout:**
1. **Preview section:** Show a list of categories being merged:
   - Each category: name + video count (e.g., "JavaScript (120 videos)")
   - Below: "Combined: ~{sum of video counts} videos (duplicates will be removed automatically)"
   - Warn (amber) if combined count > 4,500. Block if > 5,000.

2. **Name input:** Label "Merged category name", pre-filled with the longest source category name. Native HTML input with existing Tailwind styling pattern. Auto-focus on dialog open.

3. **Confirmation text:** "This will merge {N} categories into one. The original categories will be removed."

4. **Footer:** Cancel button (outline) + "Merge {N} categories" button (primary, destructive-ish -- use default variant since it's a positive action).

**On submit:**
- Call `mergeCategories(categoryIds, mergedName.trim())` from `@/app/actions/categories`.
- On success: call `onMerged(result.undoData!)`, close dialog.
- On error: show error inline.
- Show Loader2 during merge.

Reset state on dialog close. Handle Enter key on input to submit.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm the component compiles. Verify `MergeCategoriesDialog` is exported.
  </verify>
  <done>
MergeCategoriesDialog shows merge preview with category list and combined video count, requires name confirmation, calls mergeCategories transactionally, and passes undo data back to parent. Compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create VideoAssignmentDialog</name>
  <files>src/components/analysis/video-assignment-dialog.tsx</files>
  <action>
Create `src/components/analysis/video-assignment-dialog.tsx` with `'use client'` directive.

Props:
```typescript
interface VideoAssignmentDialogProps {
  categoryId: number
  categoryName: string
  currentVideoCount: number
  open: boolean
  onOpenChange: (open: boolean) => void
  onAssigned: () => void
  allCategories: Array<{ id: number; name: string }>
}
```

This is a full-screen dialog per user decision (CONTEXT.md: "Assignment interface is a full-screen dialog").

**Dialog setup:**
- Override default DialogContent size: `className="max-w-[95vw] w-[95vw] h-[90vh] max-h-[90vh] overflow-hidden flex flex-col"`

**Layout (two-column):**

**Left panel (70% -- flex-[7]):**
1. **Search bar** at top: native HTML input with Search icon, debounced (300ms) search via `searchVideosForAssignment`. State: `query`, `searchResults`, `isSearching`.
2. **Source category tabs** below search: Use Tabs component. One tab per category in `allCategories` (excluding the target category). Clicking a tab calls `searchVideosForAssignment('', sourceCategoryId)` to browse that category's videos.
3. **Video list:** Render search results as rows with:
   - Checkbox for selection (use `useBatchSelection` hook from batch-operations.tsx)
   - Thumbnail (small 40x30), title, channel name, duration
   - Small badges showing which categories this video is already in
   - If video already in target category, show "Already added" badge and disable checkbox

**Right panel (30% -- flex-[3], border-l):**
1. **Header:** "Selected ({count})"
2. **Selected video list:** ScrollArea showing selected videos with remove (X) button each.
3. **Move/Copy toggle:** Two radio buttons -- "Move (remove from source)" and "Copy (keep in both)". Only show "Move" option if browsing a specific source category (not search results).
4. **Video limit indicator:** Show "{currentVideoCount + selectedCount} / 5,000". Yellow at 4,500+, red at 5,000+.

**Footer:**
- Cancel button
- "Assign {count} videos" button -- disabled if no videos selected or over 5,000 limit.
- Show Loader2 during assignment.

**On submit:**
- Call `assignVideosToCategory(categoryId, selectedVideoIds, mode, sourceCategoryId)`.
- On success: call `onAssigned()`, close dialog.
- On error: show error inline.

**Search debounce:** Use a `useEffect` with `setTimeout` 300ms on query changes. Cancel previous timeout on new input.

Reset all state when dialog closes.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm the component compiles. Verify `VideoAssignmentDialog` is exported.
  </verify>
  <done>
VideoAssignmentDialog renders full-screen with two-column layout: left panel for search/browse videos, right panel for selection summary with move/copy toggle. Calls searchVideosForAssignment for search and assignVideosToCategory on submit. Enforces 5,000 video limit. Compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. MergeCategoriesDialog handles preview, name input, transactional merge, undo data
3. VideoAssignmentDialog is full-screen with search + browse + batch selection
4. Video assignment respects 5,000 limit with warning/block
5. Both components follow existing dialog patterns
</verification>

<success_criteria>
- Merge dialog: shows categories being merged, requires name, returns undo data
- Assignment dialog: full-screen, search by title/channel, browse by source category, move/copy, batch select, 5000 limit enforcement
- Both compile with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-category-management/03-04-SUMMARY.md`
</output>
