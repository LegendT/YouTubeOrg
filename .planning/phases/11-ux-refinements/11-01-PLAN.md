---
phase: 11-ux-refinements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/actions/analysis.ts
  - src/components/analysis/proposal-actions.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking Approve on an already-approved proposal is a no-op (button disabled)"
    - "Clicking Reject on an already-rejected proposal is a no-op (button disabled)"
    - "Clicking Reject on an approved proposal transitions directly to rejected"
    - "Clicking Approve on a rejected proposal transitions directly to approved"
    - "A Reset button appears when proposal is approved or rejected, returning it to pending"
    - "Reset button does not appear when proposal is already pending"
    - "bulkUpdateStatus accepts 'pending' status and clears approvedAt"
  artifacts:
    - path: "src/app/actions/analysis.ts"
      provides: "resetProposal server action and widened bulkUpdateStatus"
      exports: ["resetProposal"]
      contains: "resetProposal"
    - path: "src/components/analysis/proposal-actions.tsx"
      provides: "Reset button UI alongside Approve/Reject"
      contains: "RotateCcw"
  key_links:
    - from: "src/components/analysis/proposal-actions.tsx"
      to: "src/app/actions/analysis.ts"
      via: "import resetProposal"
      pattern: "import.*resetProposal.*from.*actions/analysis"
---

<objective>
Add a Reset button to proposal actions and create the supporting server action, enabling users to return approved or rejected proposals back to pending state.

Purpose: Currently approval and rejection are one-way operations. Users need an explicit way to undo their decision and return a proposal to pending for reconsideration. This also widens `bulkUpdateStatus` to accept `'pending'` for the batch reset operation needed in Plan 02.

Output: Modified `proposal-actions.tsx` with contextual Reset button, new `resetProposal` server action, and widened `bulkUpdateStatus` signature in `analysis.ts`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-ux-refinements/11-CONTEXT.md
@.planning/phases/11-ux-refinements/11-RESEARCH.md

@src/app/actions/analysis.ts
@src/components/analysis/proposal-actions.tsx
@src/types/analysis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add resetProposal server action and widen bulkUpdateStatus</name>
  <files>src/app/actions/analysis.ts</files>
  <action>
    1. Add a new `resetProposal` server action that mirrors the existing `approveProposal`/`rejectProposal` pattern (lines 130-168). It should:
       - Accept `proposalId: number` parameter
       - Return `Promise<ProposalActionResult>`
       - Set `status: 'pending'`, `approvedAt: null`, `updatedAt: new Date()`
       - Call `revalidatePath('/analysis')`
       - Wrap in try/catch matching the existing pattern

    2. Widen the `bulkUpdateStatus` function signature (currently at line 634-636):
       - Change `status: 'approved' | 'rejected'` to `status: ProposalStatus`
       - Import `ProposalStatus` from `@/types/analysis` if not already imported (check existing imports)
       - Add handling: when `status === 'pending'`, set `approvedAt: null` in the update data (same as the reset action)
       - The existing `if (status === 'approved') { updateData.approvedAt = now; }` block should be extended with `else if (status === 'pending') { updateData.approvedAt = null; }`
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles without errors. Grep for `resetProposal` in analysis.ts to confirm the function exists. Grep for `ProposalStatus` in the bulkUpdateStatus signature.
  </verify>
  <done>
    `resetProposal` server action exists and sets status to 'pending' with `approvedAt: null`. `bulkUpdateStatus` accepts `ProposalStatus` (including 'pending') and clears `approvedAt` when resetting to pending.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Reset button to ProposalActions component</name>
  <files>src/components/analysis/proposal-actions.tsx</files>
  <action>
    Modify the `ProposalActions` component to add a contextual Reset button:

    1. Add imports:
       - `RotateCcw` from `lucide-react` (alongside existing Check, X)
       - `resetProposal` from `@/app/actions/analysis` (alongside existing approveProposal, rejectProposal)

    2. Add a `handleReset` function following the same pattern as `handleApprove`/`handleReject`:
       ```
       function handleReset() {
         startTransition(async () => {
           await resetProposal(proposalId)
           onStatusChange?.()
         })
       }
       ```

    3. In the JSX, after the Reject button and before the Badge, add the Reset button that only renders when `status !== 'pending'`:
       ```
       {status !== 'pending' && (
         <Button
           size="sm"
           variant="ghost"
           onClick={handleReset}
           disabled={isPending}
           className="gap-1"
         >
           <RotateCcw className="h-4 w-4" />
           Reset
         </Button>
       )}
       ```

    4. Keep the existing Approve button disabled logic (`disabled={isPending || status === 'approved' || videoCount > 4500}`) unchanged.
    5. Keep the existing Reject button disabled logic (`disabled={isPending || status === 'rejected'}`) unchanged.
    6. The Reset button should be disabled only during `isPending` (it should always be clickable when visible and not in a transition).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify TypeScript compiles. Grep for `RotateCcw` and `resetProposal` in proposal-actions.tsx.
  </verify>
  <done>
    Reset button appears in ProposalActions when proposal is approved or rejected. Clicking it calls resetProposal and returns the proposal to pending. Button is hidden when already pending. All three buttons (Approve, Reject, Reset) are disabled during transitions.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `resetProposal` function is exported from `src/app/actions/analysis.ts`
3. `bulkUpdateStatus` accepts `ProposalStatus` type parameter (includes 'pending')
4. `ProposalActions` component renders Reset button conditionally based on status
5. Reset button imports and calls `resetProposal` from the actions file
</verification>

<success_criteria>
- The `resetProposal` server action sets status='pending' and approvedAt=null
- The `bulkUpdateStatus` function handles 'pending' status by clearing approvedAt
- The Reset button appears only when status is 'approved' or 'rejected'
- The Reset button is hidden when status is 'pending'
- Approve/Reject disabled logic remains unchanged from current behaviour
- Direct state transitions work: approved->rejected, rejected->approved (no reset required first)
- All buttons disabled during useTransition pending state
</success_criteria>

<output>
After completion, create `.planning/phases/11-ux-refinements/11-01-SUMMARY.md`
</output>
