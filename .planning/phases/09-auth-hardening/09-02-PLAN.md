---
phase: 09-auth-hardening
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/actions/analysis.ts
  - src/app/actions/categories.ts
  - src/app/actions/ml-categorization.ts
autonomous: true

must_haves:
  truths:
    - "Mutating analysis actions return { success: false, error } when called without valid session"
    - "Read-only analysis actions return empty results when called without valid session"
    - "Mutating category actions return { success: false, error } when called without valid session"
    - "Read-only category actions return empty results when called without valid session"
    - "Mutating ML actions return { success: false, error } when called without valid session"
    - "Read-only ML actions return empty results when called without valid session"
    - "Auth checks happen BEFORE any database queries in every action"
  artifacts:
    - path: "src/app/actions/analysis.ts"
      provides: "Auth-guarded analysis actions (18 actions)"
      contains: "requireAuth"
    - path: "src/app/actions/categories.ts"
      provides: "Auth-guarded category actions (10 actions)"
      contains: "requireAuth"
    - path: "src/app/actions/ml-categorization.ts"
      provides: "Auth-guarded ML categorization actions (10 actions)"
      contains: "requireAuth"
  key_links:
    - from: "src/app/actions/analysis.ts"
      to: "src/lib/auth/guard.ts"
      via: "import { requireAuth }"
      pattern: "import.*requireAuth.*from.*@/lib/auth/guard"
    - from: "src/app/actions/categories.ts"
      to: "src/lib/auth/guard.ts"
      via: "import { requireAuth }"
      pattern: "import.*requireAuth.*from.*@/lib/auth/guard"
    - from: "src/app/actions/ml-categorization.ts"
      to: "src/lib/auth/guard.ts"
      via: "import { requireAuth }"
      pattern: "import.*requireAuth.*from.*@/lib/auth/guard"
---

<objective>
Add auth guards to the 3 largest server action files: analysis.ts (18 actions), categories.ts (10 actions), and ml-categorization.ts (10 actions).

Purpose: Close the second security gap -- server actions currently execute database operations without verifying the caller is authenticated. After this plan, every action validates auth before touching the database, following the defence-in-depth principle.

Output: 3 updated server action files with `requireAuth()` guards on all 38 actions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-auth-hardening/09-RESEARCH.md
@.planning/phases/09-auth-hardening/09-01-SUMMARY.md

@src/lib/auth/guard.ts
@src/app/actions/sync.ts
@src/app/actions/analysis.ts
@src/app/actions/categories.ts
@src/app/actions/ml-categorization.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auth guards to analysis.ts (18 actions)</name>
  <files>src/app/actions/analysis.ts</files>
  <action>
Add `import { requireAuth } from '@/lib/auth/guard'` at the top of the file.

Add auth guard to EVERY exported function in the file. There are two patterns based on action type:

**Pattern A -- Mutating actions (already return `{ success: boolean; error?: string }` shapes):**
Add at the VERY START of the function body, BEFORE any database queries:
```typescript
const auth = await requireAuth()
if (!auth.authenticated) {
  return { success: false, error: auth.error }
}
```

Apply Pattern A to these 10 mutating actions:
- `generateConsolidationProposal`
- `approveProposal`
- `rejectProposal`
- `splitProposal`
- `updateProposalPlaylists`
- `createCustomCategory`
- `resolveDuplicates`
- `bulkUpdateStatus`
- `runAnalysis`
- `finalizeConsolidation`

**Pattern B -- Read-only actions (return arrays, objects, or nullable types):**
Add at the VERY START of the function body, BEFORE any database queries. Return the appropriate empty/null value that matches the existing return type (do NOT change return type signatures):
```typescript
const auth = await requireAuth()
if (!auth.authenticated) {
  return <empty-value>  // [], null, or appropriate empty shape
}
```

Apply Pattern B to these 8 read-only actions:
- `getProposals` -- return `{ success: false, proposals: [], error: auth.error }` (check existing return shape)
- `getDuplicateStats` -- return `{ totalDuplicates: 0, totalAffectedPlaylists: 0, pairs: [] }` or appropriate empty shape
- `getDuplicateVideos` -- return `[]`
- `getCategoryDetail` -- return `null`
- `getAnalysisSummary` -- return `null`
- `checkStaleness` -- return `{ isStale: false, lastSync: null, lastAnalysis: null }` or appropriate empty shape
- `getLatestSession` -- return `null`
- `getAllPlaylistsForSelector` -- return `[]`

IMPORTANT:
- Check each action's actual return type BEFORE adding the guard to ensure the empty value matches
- The auth check MUST be the FIRST thing in the function, BEFORE any try/catch blocks or database queries
- Do NOT change any function signatures or return types
- Use `const auth = await requireAuth()` (not `const authResult` or other names) for consistency
  </action>
  <verify>
`npx tsc --noEmit` passes (no TypeScript errors -- return types are preserved).
`grep -c "requireAuth" src/app/actions/analysis.ts` returns 19 (1 import + 18 usage sites).
  </verify>
  <done>
All 18 exported actions in analysis.ts check authentication before any database access. Mutating actions return `{ success: false, error }`, read-only actions return empty results.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add auth guards to categories.ts (10 actions) and ml-categorization.ts (10 actions)</name>
  <files>
    src/app/actions/categories.ts
    src/app/actions/ml-categorization.ts
  </files>
  <action>
Add `import { requireAuth } from '@/lib/auth/guard'` at the top of BOTH files.

**categories.ts -- 10 actions:**

Pattern A (mutating, already return `{ success, error }` shapes):
- `createCategory`
- `renameCategory`
- `deleteCategory`
- `mergeCategories`
- `assignVideosToCategory`
- `undoDelete`
- `undoMerge`

Pattern B (read-only, return arrays/objects):
- `getCategories` -- return `[]`
- `searchVideosForAssignment` -- return `[]`
- `getCategoryDetailManagement` -- return `null` or appropriate empty shape

**ml-categorization.ts -- 10 actions:**

Pattern A (mutating):
- `saveCategorizationResults`
- `acceptSuggestion`
- `rejectSuggestion`
- `recategorizeVideo`

Pattern B (read-only):
- `getDataForCategorization` -- return appropriate empty shape (check actual return type: likely `{ videos: [], categories: [] }` or similar)
- `getMLCategorizationForVideo` -- return `null`
- `getMLCategorizationResults` -- return `[]`
- `getReviewData` -- return `[]`
- `getVideoReviewDetail` -- return `null`
- `getReviewStats` -- return appropriate empty stats shape (all zeros)

Same rules as Task 1:
- Check each action's actual return type before adding the guard
- Auth check is FIRST in function body, before try/catch or DB queries
- Do NOT change function signatures or return types
- Use `const auth = await requireAuth()` naming
  </action>
  <verify>
`npx tsc --noEmit` passes.
`grep -c "requireAuth" src/app/actions/categories.ts` returns 11 (1 import + 10 usage sites).
`grep -c "requireAuth" src/app/actions/ml-categorization.ts` returns 11 (1 import + 10 usage sites).
  </verify>
  <done>
All 20 exported actions across categories.ts and ml-categorization.ts check authentication before any database access. Combined with Task 1, all 38 actions in the 3 largest server action files are guarded.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes with zero errors
2. All 3 files import `requireAuth` from `@/lib/auth/guard`
3. Total `requireAuth` calls across 3 files: 38 (18 + 10 + 10)
4. No function signatures or return types changed
5. Dev server starts without errors: `npm run dev`
</verification>

<success_criteria>
- Every mutating action in analysis.ts, categories.ts, ml-categorization.ts returns `{ success: false, error }` on auth failure
- Every read-only action returns empty/null results on auth failure
- No TypeScript errors introduced (return types preserved)
- Auth checks occur before any database queries in all 38 actions
</success_criteria>

<output>
After completion, create `.planning/phases/09-auth-hardening/09-02-SUMMARY.md`
</output>
