---
phase: 09-auth-hardening
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/app/actions/videos.ts
  - src/app/actions/backup.ts
  - src/app/actions/operation-log.ts
autonomous: true

must_haves:
  truths:
    - "removeVideosFromCategory returns { success: false, error } when called without valid session"
    - "getVideosForCategory returns empty array when called without valid session"
    - "createManualBackup, restoreBackup, deleteBackup return { success: false, error } without valid session"
    - "listBackups returns empty array without valid session"
    - "logOperation, getOperationLog, getPendingChanges guard against unauthenticated calls"
    - "Auth checks happen BEFORE any database queries or file operations"
  artifacts:
    - path: "src/app/actions/videos.ts"
      provides: "Auth-guarded video actions (2 actions)"
      contains: "requireAuth"
    - path: "src/app/actions/backup.ts"
      provides: "Auth-guarded backup actions (4 actions)"
      contains: "requireAuth"
    - path: "src/app/actions/operation-log.ts"
      provides: "Auth-guarded operation log actions (3 actions)"
      contains: "requireAuth"
  key_links:
    - from: "src/app/actions/videos.ts"
      to: "src/lib/auth/guard.ts"
      via: "import { requireAuth }"
      pattern: "import.*requireAuth.*from.*@/lib/auth/guard"
    - from: "src/app/actions/backup.ts"
      to: "src/lib/auth/guard.ts"
      via: "import { requireAuth }"
      pattern: "import.*requireAuth.*from.*@/lib/auth/guard"
    - from: "src/app/actions/operation-log.ts"
      to: "src/lib/auth/guard.ts"
      via: "import { requireAuth }"
      pattern: "import.*requireAuth.*from.*@/lib/auth/guard"
---

<objective>
Add auth guards to the 3 smaller server action files: videos.ts (2 actions), backup.ts (4 actions), and operation-log.ts (3 actions).

Purpose: Complete the server action auth hardening. After this plan, all 47 server actions across 6 files (plus the 2 already-guarded sync files) validate authentication before executing.

Output: 3 updated server action files with `requireAuth()` guards on all 9 actions.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-auth-hardening/09-RESEARCH.md
@.planning/phases/09-auth-hardening/09-01-SUMMARY.md

@src/lib/auth/guard.ts
@src/app/actions/videos.ts
@src/app/actions/backup.ts
@src/app/actions/operation-log.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auth guards to videos.ts, backup.ts, and operation-log.ts (9 actions)</name>
  <files>
    src/app/actions/videos.ts
    src/app/actions/backup.ts
    src/app/actions/operation-log.ts
  </files>
  <action>
Add `import { requireAuth } from '@/lib/auth/guard'` at the top of ALL THREE files.

**videos.ts -- 2 actions:**

Pattern A (mutating):
- `removeVideosFromCategory` -- already returns `{ success, error }` shape

Pattern B (read-only):
- `getVideosForCategory` -- returns `VideoCardData[]`, return `[]` on auth failure

**backup.ts -- 4 actions:**

Pattern A (mutating):
- `createManualBackup` -- already returns `{ success, error/snapshot }` shape
- `restoreBackup` -- already returns `{ success, error }` shape
- `deleteBackup` -- already returns `{ success, error }` shape

Pattern B (read-only):
- `listBackups` -- returns array, return `[]` on auth failure

**operation-log.ts -- 3 actions:**

Pattern A (mutating):
- `logOperation` -- this is called internally by other server actions (deleteCategory, restoreBackup) but has `'use server'` making it callable from client. Add auth guard. Check return type and return appropriate error shape.

Pattern B (read-only):
- `getOperationLog` -- returns array (possibly with pagination shape), return appropriate empty shape
- `getPendingChanges` -- returns `PendingChangeSummary` or similar, return empty summary shape

Same rules as Plan 02:
- Check each action's actual return type before adding the guard
- Auth check is FIRST in function body, before try/catch or DB/file operations
- Do NOT change function signatures or return types
- Use `const auth = await requireAuth()` naming

NOTE for `logOperation`: Since it is called internally by other already-guarded actions, the auth check is technically redundant when called internally. But since it has `'use server'` making it technically callable from client, add the guard anyway -- defence-in-depth. The double `auth()` call is lightweight (JWT decode, no DB hit).
  </action>
  <verify>
`npx tsc --noEmit` passes (no TypeScript errors).
`grep -c "requireAuth" src/app/actions/videos.ts` returns 3 (1 import + 2 usage sites).
`grep -c "requireAuth" src/app/actions/backup.ts` returns 5 (1 import + 4 usage sites).
`grep -c "requireAuth" src/app/actions/operation-log.ts` returns 4 (1 import + 3 usage sites).
  </verify>
  <done>
All 9 exported actions across videos.ts, backup.ts, and operation-log.ts check authentication before any database or file access.
  </done>
</task>

<task type="auto">
  <name>Task 2: Full auth coverage verification</name>
  <files>None (verification only)</files>
  <action>
Perform a comprehensive verification of the entire Phase 9 auth hardening:

1. **Page coverage audit**: Grep all `src/app/*/page.tsx` files to confirm every page has either `getServerSession` or `auth()` check. List all pages and their auth status. The expected result:
   - dashboard/page.tsx: GUARDED (existing)
   - sync/page.tsx: GUARDED (existing)
   - ml-categorization/page.tsx: GUARDED (existing)
   - analysis/page.tsx: GUARDED (Plan 01)
   - ml-review/page.tsx: GUARDED (Plan 01)
   - safety/page.tsx: GUARDED (Plan 01)
   - videos/page.tsx: GUARDED (Plan 01)
   - Root page.tsx (if exists): May not need auth (landing/login page)

2. **Server action coverage audit**: Grep all `src/app/actions/*.ts` files for `requireAuth` or `getAccessToken` (sync.ts uses its own helper). Confirm every exported async function has an auth check. Expected:
   - analysis.ts: 18 actions guarded (Plan 02)
   - categories.ts: 10 actions guarded (Plan 02)
   - ml-categorization.ts: 10 actions guarded (Plan 02)
   - videos.ts: 2 actions guarded (Plan 03)
   - backup.ts: 4 actions guarded (Plan 03)
   - operation-log.ts: 3 actions guarded (Plan 03)
   - sync.ts: Already guarded via getAccessToken()
   - sync-playlists.ts: Already guarded

3. **TypeScript health**: Run `npx tsc --noEmit` and confirm zero errors.

4. **Dev server health**: Start dev server briefly to confirm no runtime import errors.

If any gaps found, fix them immediately.
  </action>
  <verify>
All pages audited and confirmed guarded.
All server action files audited and confirmed guarded.
`npx tsc --noEmit` passes.
Dev server starts without errors.
  </verify>
  <done>
100% auth coverage verified: all 7 authenticated pages and all 47+ server actions across 8 files have auth checks. Phase 9 success criteria fully met.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes with zero errors
2. Every `src/app/*/page.tsx` (except root) contains auth check
3. Every `src/app/actions/*.ts` file contains auth guards on all exported functions
4. Total guarded actions: 47+ across 8 files (6 newly guarded + 2 existing)
5. Dev server starts without errors
</verification>

<success_criteria>
- All 9 actions in videos.ts, backup.ts, operation-log.ts have auth guards
- Full audit confirms 100% auth coverage across pages and server actions
- No TypeScript errors
- Phase 9 success criteria fully satisfied:
  1. Visiting /analysis, /ml-review, /safety, /videos without session redirects to login
  2. Server actions return auth error (not crash) when called without valid session
  3. Expired tokens trigger re-authentication flow, not raw error display
</success_criteria>

<output>
After completion, create `.planning/phases/09-auth-hardening/09-03-SUMMARY.md`
</output>
