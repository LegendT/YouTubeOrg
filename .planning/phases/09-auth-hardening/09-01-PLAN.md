---
phase: 09-auth-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/auth/guard.ts
  - src/app/analysis/page.tsx
  - src/app/ml-review/page.tsx
  - src/app/safety/page.tsx
  - src/app/videos/page.tsx
autonomous: true

must_haves:
  truths:
    - "Visiting /analysis without a session redirects to /api/auth/signin"
    - "Visiting /ml-review without a session redirects to /api/auth/signin"
    - "Visiting /safety without a session redirects to /api/auth/signin"
    - "Visiting /videos without a session redirects to /api/auth/signin"
    - "Expired refresh tokens trigger redirect to /api/auth/signin on all 4 pages"
    - "requireAuth() helper exists for server action use in subsequent plans"
  artifacts:
    - path: "src/lib/auth/guard.ts"
      provides: "Shared requireAuth() utility for server actions"
      exports: ["requireAuth", "AuthResult"]
      min_lines: 15
    - path: "src/app/analysis/page.tsx"
      provides: "Auth-gated analysis page"
      contains: "getServerSession"
    - path: "src/app/ml-review/page.tsx"
      provides: "Auth-gated ML review page"
      contains: "getServerSession"
    - path: "src/app/safety/page.tsx"
      provides: "Auth-gated safety page"
      contains: "getServerSession"
    - path: "src/app/videos/page.tsx"
      provides: "Auth-gated videos page"
      contains: "getServerSession"
  key_links:
    - from: "src/lib/auth/guard.ts"
      to: "src/lib/auth/config"
      via: "import { auth }"
      pattern: "import.*auth.*from.*@/lib/auth/config"
    - from: "src/app/*/page.tsx"
      to: "/api/auth/signin"
      via: "redirect() on missing/expired session"
      pattern: "redirect\\('/api/auth/signin'\\)"
---

<objective>
Create the shared `requireAuth()` utility and add auth checks to the 4 unprotected pages.

Purpose: Close the first security gap -- unauthenticated users currently see raw errors or empty data when visiting /analysis, /ml-review, /safety, and /videos. After this plan, they are cleanly redirected to sign-in.

Output: `src/lib/auth/guard.ts` (new file) and 4 updated page files with auth gates.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-auth-hardening/09-RESEARCH.md

@src/lib/auth/session.ts
@src/lib/auth/config.ts
@src/app/dashboard/page.tsx
@src/app/sync/page.tsx
@src/app/analysis/page.tsx
@src/app/ml-review/page.tsx
@src/app/safety/page.tsx
@src/app/videos/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create requireAuth() guard utility</name>
  <files>src/lib/auth/guard.ts</files>
  <action>
Create `src/lib/auth/guard.ts` with:

1. Import `auth` from `@/lib/auth/config` (NOT getServerSession -- auth() is lighter for actions, matches sync.ts pattern)
2. Export `AuthResult` discriminated union type:
   - `{ authenticated: true; accessToken: string }`
   - `{ authenticated: false; error: string }`
3. Export `requireAuth()` async function that:
   - Calls `auth()` to get session
   - Returns `{ authenticated: false, error: 'Not authenticated' }` if `!session?.access_token`
   - Returns `{ authenticated: false, error: 'Session expired. Please sign in again.' }` if `session.error === 'RefreshAccessTokenError'`
   - Returns `{ authenticated: true, accessToken: session.access_token }` on success
4. Add JSDoc with usage example showing the guard-clause pattern

Do NOT add `'use server'` directive -- this is a utility, not a server action. It will be imported by server action files that already have the directive.
  </action>
  <verify>
`npx tsc --noEmit` passes (no TypeScript errors in the new file).
Verify the file imports `auth` from `@/lib/auth/config` and exports both `AuthResult` and `requireAuth`.
  </verify>
  <done>
`src/lib/auth/guard.ts` exists, exports `requireAuth()` and `AuthResult`, checks both missing token and RefreshAccessTokenError conditions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add auth checks to 4 unprotected pages</name>
  <files>
    src/app/analysis/page.tsx
    src/app/ml-review/page.tsx
    src/app/safety/page.tsx
    src/app/videos/page.tsx
  </files>
  <action>
Add the existing 3-line auth check pattern to each of the 4 pages. The exact pattern is already used in `src/app/dashboard/page.tsx` and `src/app/sync/page.tsx`:

```typescript
import { getServerSession } from '@/lib/auth/session'
import { redirect } from 'next/navigation'

// Inside the default export async function, BEFORE any data fetching:
const session = await getServerSession()
if (!session?.access_token || session?.error === 'RefreshAccessTokenError') {
  redirect('/api/auth/signin')
}
```

For each page:

1. **`src/app/analysis/page.tsx`**: Add `getServerSession` import and `redirect` import (if not already present). Add the 3-line check as the FIRST lines inside `AnalysisPage()`, BEFORE the `Promise.all(...)` data fetch.

2. **`src/app/ml-review/page.tsx`**: Add imports. Add the 3-line check as the FIRST lines inside `MLReviewPage()`, BEFORE the `Promise.all(...)` data fetch.

3. **`src/app/safety/page.tsx`**: Add imports. Add the 3-line check as the FIRST lines inside `SafetyPage()`, BEFORE any data fetching.

4. **`src/app/videos/page.tsx`**: Add imports. Add the 3-line check as the FIRST lines inside `VideosPage()`, BEFORE `getCategories()` or `getVideosForCategory()` calls.

IMPORTANT: Use `getServerSession` from `@/lib/auth/session` (not `auth()` directly) for pages -- this matches the existing convention in dashboard/sync pages. Use `redirect` from `next/navigation`. The auth check MUST be BEFORE any database queries.
  </action>
  <verify>
`npx tsc --noEmit` passes.
Grep all 4 page files for the auth pattern: `grep -l "getServerSession" src/app/analysis/page.tsx src/app/ml-review/page.tsx src/app/safety/page.tsx src/app/videos/page.tsx` should return all 4 files.
Grep for redirect: `grep -l "redirect('/api/auth/signin')" src/app/analysis/page.tsx src/app/ml-review/page.tsx src/app/safety/page.tsx src/app/videos/page.tsx` should return all 4 files.
  </verify>
  <done>
All 4 pages check `session?.access_token` and `session?.error === 'RefreshAccessTokenError'` before any data fetching, redirecting to `/api/auth/signin` on failure. Together with the 3 existing pages (dashboard, sync, ml-categorization), all 7 authenticated pages now have auth checks.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes with zero errors
2. All 7 app pages (dashboard, sync, ml-categorization, analysis, ml-review, safety, videos) contain `getServerSession` or `auth()` auth checks
3. `src/lib/auth/guard.ts` exists and is importable
4. Dev server starts without errors: `npm run dev` (verify no import resolution issues)
</verification>

<success_criteria>
- Visiting /analysis, /ml-review, /safety, /videos without a session redirects to /api/auth/signin
- Expired tokens (RefreshAccessTokenError) on any of the 4 pages redirect to sign-in
- requireAuth() utility is ready for server action use in Plans 02 and 03
- No TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/09-auth-hardening/09-01-SUMMARY.md`
</output>
