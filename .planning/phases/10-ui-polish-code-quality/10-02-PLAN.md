---
phase: 10-ui-polish-code-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - drizzle/schema.ts
  - drizzle/relations.ts
  - src/app/actions/ml-categorization.ts
  - src/lib/backup/restore.ts
  - src/lib/backup/snapshot.ts
  - src/app/actions/operation-log.ts
  - src/types/ml.ts
  - src/lib/ml/confidence.ts
autonomous: true

must_haves:
  truths:
    - "Database table ml_categorisations exists (British spelling)"
    - "Protected category name is 'Uncategorised' in database"
    - "All TypeScript code referencing the old table name compiles cleanly"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "Schema with mlCategorisations export (British spelling)"
      contains: "mlCategorisations"
    - path: "drizzle/schema.ts"
      provides: "Auto-generated schema with ml_categorisations table"
      contains: "ml_categorisations"
    - path: "drizzle/relations.ts"
      provides: "Relations using mlCategorisations import"
      contains: "mlCategorisations"
  key_links:
    - from: "src/app/actions/ml-categorization.ts"
      to: "src/lib/db/schema.ts"
      via: "mlCategorisations import"
      pattern: "import.*mlCategorisations.*schema"
    - from: "src/lib/backup/snapshot.ts"
      to: "src/lib/db/schema.ts"
      via: "mlCategorisations import"
      pattern: "mlCategorisations"
    - from: "src/lib/backup/restore.ts"
      to: "src/lib/db/schema.ts"
      via: "mlCategorisations import"
      pattern: "mlCategorisations"
---

<objective>
Rename the database table `ml_categorizations` to `ml_categorisations` (British spelling) and update the protected category data from "Uncategorized" to "Uncategorised". Update all TypeScript references to use the new names.

Purpose: British English consistency at the database layer -- the foundation that all subsequent code renames depend on.
Output: Database table renamed via drizzle-kit push, schema.ts exports renamed, all importing files updated, protected category data migrated.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-ui-polish-code-quality/10-CONTEXT.md
@.planning/phases/10-ui-polish-code-quality/10-RESEARCH.md
@src/lib/db/schema.ts
@drizzle/schema.ts
@drizzle/relations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename DB table and schema exports, update all TypeScript references</name>
  <files>
    src/lib/db/schema.ts
    drizzle/schema.ts
    drizzle/relations.ts
    src/app/actions/ml-categorization.ts
    src/lib/backup/restore.ts
    src/lib/backup/snapshot.ts
    src/app/actions/operation-log.ts
    src/types/ml.ts
    src/lib/ml/confidence.ts
  </files>
  <action>
    1. Update src/lib/db/schema.ts:
       - Rename the export: `export const mlCategorizations` -> `export const mlCategorisations`
       - Rename the table string: `pgTable('ml_categorizations', ...)` -> `pgTable('ml_categorisations', ...)`
       - Update the comment on line 143 from "Phase 5: ML Categorization Engine" to "Phase 5: ML Categorisation Engine"
       - Update the comment on line 148 from "ML Categorizations table" to "ML Categorisations table"
       - Update index comments (lines 163, 166): `ml_categorizations` -> `ml_categorisations`
       - Update comment on line 128: "Uncategorized" -> "Uncategorised"
       - Update comment on line 145: "categorization" -> "categorisation"

    2. Update drizzle/schema.ts (auto-generated, but needs manual update):
       - Rename `export const mlCategorizations` -> `export const mlCategorisations`
       - Rename table string: `pgTable("ml_categorizations", ...)` -> `pgTable("ml_categorisations", ...)`
       - Update all FK constraint name strings: `ml_categorizations_*` -> `ml_categorisations_*`

    3. Update drizzle/relations.ts:
       - Rename all references to `mlCategorizations` -> `mlCategorisations` in imports, relation function names, and relation references
       - `mlCategorizationsRelations` -> `mlCategorisationsRelations`
       - All `mlCategorizations` references in relation bodies -> `mlCategorisations`
       - Update relation name strings: `"mlCategorizations_suggestedCategoryId_categories_id"` -> `"mlCategorisations_suggestedCategoryId_categories_id"` (and similar)

    4. Update all importing files -- grep for `mlCategorizations` across src/:
       - src/app/actions/ml-categorization.ts: update import and all usages of `mlCategorizations` -> `mlCategorisations`
       - src/lib/backup/restore.ts: update import and all usages
       - src/lib/backup/snapshot.ts: update import and all usages
       - src/app/actions/operation-log.ts: update the `entityType: 'ml_categorization'` strings to `'ml_categorisation'` (3 occurrences at lines ~149, 159, 169)
       - src/types/ml.ts: update any references
       - src/lib/ml/confidence.ts: update any references

    5. Run `npx drizzle-kit push` to rename the table in PostgreSQL. When prompted about the rename, confirm it is a rename (not drop+create). This uses the project's established push workflow (not migrations).

    IMPORTANT: The project uses `drizzle-kit push` for development (not migrations). Run push after updating schema.ts. If drizzle-kit push does not handle the table rename cleanly, fall back to raw SQL: `ALTER TABLE "ml_categorizations" RENAME TO "ml_categorisations";` via the database connection.

    Also run a raw SQL update for the protected category name:
    `UPDATE categories SET name = 'Uncategorised' WHERE is_protected = true AND name = 'Uncategorized';`

    This can be done via a small script using the project's db connection, or via psql.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles with zero errors
    - `grep -rn "mlCategorizations\b" src/ drizzle/` returns zero matches (only mlCategorisations)
    - `grep -rn "ml_categorizations" src/ drizzle/` returns zero matches (only ml_categorisations)
    - Database query confirms table exists: `SELECT tablename FROM pg_tables WHERE tablename = 'ml_categorisations';`
    - Database query confirms data: `SELECT name FROM categories WHERE is_protected = true;` returns "Uncategorised"
  </verify>
  <done>
    - DB table renamed from ml_categorizations to ml_categorisations
    - All TypeScript exports/imports use mlCategorisations
    - Protected category name updated to "Uncategorised" in database
    - Zero TypeScript compilation errors
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `grep -rn "mlCategorizations\b\|ml_categorizations" src/ drizzle/` returns zero matches
- Database has table `ml_categorisations` and no table `ml_categorizations`
- Protected category displays as "Uncategorised"
</verification>

<success_criteria>
1. Database table successfully renamed to ml_categorisations
2. All TypeScript code uses mlCategorisations (British spelling)
3. Protected category name is "Uncategorised" in database
4. Zero TypeScript compilation errors after all renames
</success_criteria>

<output>
After completion, create `.planning/phases/10-ui-polish-code-quality/10-02-SUMMARY.md`
</output>
